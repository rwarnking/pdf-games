\documentclass[12pt, a4paper, footexclude, headexclude]{scrartcl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[margin=0.5in]{geometry}

\usepackage[pdftex]{hyperref}
\usepackage{multicol}

\usepackage{xinttools}
\usepackage{tabularx}
\usepackage{tcolorbox}

\setlength{\parindent}{0pt}

\usepackage[pdftex]{insdljs}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Parameter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\cards{32}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Javascript
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{insDLJS}[]{JSDateiname}{Maumau}

const GAME_DESC = "Text.\
Text.\
Text.\
Text.\
Text.";

% Outside variables
const CARD_COUNT = AFMakeNumber(\cards);
% TODO get this from the gui
var playerCount = 4;

% Constants
const TEXT_SIZE = 14;

% Access constants
const X = 0;
const Y = 1;
const SYMB = 2;
const LEFT = 0;
const TOP = 1;
const RIGHT = 2;
const BOT = 3;
% Document dims: 842, 596
% Canvas dims
% upper-left x, upper-left y, lower-right x and lower-right y
const CANVAS_LTRB = [47.5, 770, 547.5, 241];
const CANVAS_HEIGHT = CANVAS_LTRB[TOP] - CANVAS_LTRB[BOT];
const CANVAS_WIDTH = CANVAS_LTRB[RIGHT] - CANVAS_LTRB[LEFT];
const CANVAS_CENTER_H = CANVAS_HEIGHT * 0.5 + CANVAS_LTRB[BOT];
const CANVAS_CENTER_W = CANVAS_WIDTH * 0.5 + CANVAS_LTRB[LEFT];

const CARD_WIDTH = 20;
const STACK_POS = [CANVAS_CENTER_W - CARD_WIDTH * 1.25, CANVAS_CENTER_H - 100];
const GRAVE_POS = [CANVAS_CENTER_W + CARD_WIDTH * 1.25, CANVAS_CENTER_H - 100];

% Globals
var curPlayer = 0;
% Player cards
var playerCards = [
    [], [], [], []
];

% Spades, clubs, hearts, diamonds
% const CARD_COLORS = ["S", "C", "H", "D"];
const CARD_COLORS = [
    String.fromCharCode(0x2660),
    String.fromCharCode(0x2663),
    String.fromCharCode(0x2665),
    String.fromCharCode(0x2666)
];

const CARD_VALUES = ["7", "8", "9", "10", "B", "Q", "K", "A"];
const CARDS = [];

% TODO graveyard?
var unusedCards = [];
var stack = [];

const STACK = -1;
const GRAVEYARD = -2;
var cardOwner = [];

for (var col = 0; col < CARD_COLORS.length; col++) {
    for (var val = 0; val < CARD_VALUES.length; val++) {
        CARDS.push(CARD_VALUES[val] + CARD_COLORS[col]);
    }
}

%%%%%%%%%%
% Helper %
%%%%%%%%%%
/**
 * Returns a random integer between 0 and the param.
 * @param {Number} max The upperbound.
 */
function getRandomInt(max) {
    return Math.floor(Math.random() * max);
}

% TODO
var gameInterval;
const ANIMATION_SPEED = 200;
% TODO
var curCardIdx = -1;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Initialisation and Restart %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
/**
 * Initialise the default game state.
 */
function initialise() {
    % Init the GUI
    initialiseButtons();

    % Init unused cards
    for (var i = 0; i < CARD_COUNT; i++) {
        unusedCards.push(i);
    }
    for (var i = 0; i < CARD_COUNT; i++) {
        % Get random element from the  and remove the card afterwards
        var rnd = getRandomInt(unusedCards.length);
        stack.push(unusedCards[rnd]);
        cardOwner.push(STACK);
        unusedCards.splice(rnd, 1);
    }

    fillCards();

    curCardIdx = stack.length - 1;
    gameInterval = app.setInterval("initCardPositions()", ANIMATION_SPEED);
}

/**
 * Initialise all buttons from the GUI.
 * For example add callbacks and set the correct colors.
 */
function initialiseButtons() {
    % Disables the rectangle around a button after the click
    app.focusRect = false;

    for (var c = 0; c < CARDS.length; c++) {
        var callbackName = "chooseCard(" + c.toString() + ");";
        var card = this.getField("card" + c);
        card.setAction("MouseUp", callbackName);
    }

    % Assign each button the coresponding function and disable the highlights
    this.getField("restart").setAction("MouseUp", "restart();");
    %this.getField("restart").highlight="none";

    % Info field setup
    this.getField("info").fillColor = color.transparent;
    this.getField("info").borderColor = color.transparent;

    % Tooltip setup
    this.getField("tooltipbtn").setAction("MouseDown", "tooltip(true);");
    this.getField("tooltipbtn").setAction("MouseUp", "tooltip(false);");
    %this.getField("tooltipbtn").highlight="none";

    printInfoText("Init");
}

/**
 * Restart the game and clear everything
 */
function restart() {
    printInfoText("Restart");
}

/**
 * Enable or disable the tooltip
 *
 * @param {Boolean} on Enable or disable tooltip
 */
function tooltip(on) {
    if (on) {
        % Move the tooltip field to the center of the screen
        % and adjust the size so the text can be displayed
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.hidden = false;
        field.value = GAME_DESC;

        field.multiline = true;
        field.textSize = 16;
        field.fillColor = color.gray;
        % height 842, width 596
        % upper-left x, upper-left y, lower-right x and lower-right y
        field.rect = [128, 601, 468, 401];

        field.delay = false;
    } else {
        % Remove the field such that it is not visible
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.hidden = true;
        field.value = "";

        field.multiline = false;
        field.fillColor = color.gray;
        field.rect = [0, 0, 0, 0];

        field.delay = false;
    }
}

%%%%%%%%%%%%%
% Gamelogic %
%%%%%%%%%%%%%
% 1. Drop cards
% 2. Deploy cards
% 3. Open first card
% 4.1 if card on hand is clicked play it
% 4.2 if card on stack is clicked take it

const PLAYER_POS = [
    [CANVAS_CENTER_W, CANVAS_LTRB[BOT]],
    [CANVAS_LTRB[LEFT], CANVAS_CENTER_H],
    [CANVAS_CENTER_W, CANVAS_LTRB[TOP]],
    [CANVAS_LTRB[RIGHT], CANVAS_CENTER_H]
]

function chooseCard(cardIdx) {
    % Player draws a card
    if (cardOwner[cardIdx] == STACK) {
        var card = this.getField("card" + stack[0]);
        cardOwner[stack[0]] = curPlayer;

        card.delay = true;
        card.rect = [
            PLAYER_POS[curPlayer][X] - CARD_WIDTH,
            PLAYER_POS[curPlayer][Y] + CARD_WIDTH,
            PLAYER_POS[curPlayer][X] + CARD_WIDTH,
            PLAYER_POS[curPlayer][Y] - CARD_WIDTH
        ];
        card.delay = false;

        drawCardFront(stack[0]);
        stack.splice(0, 1);

        printInfoText("Player " + curPlayer + " took a card!");
    } else if (cardOwner[cardIdx] > STACK) {
        var card = this.getField("card" + cardIdx);
        card.delay = true;
        card.rect = [
            GRAVE_POS[X] - CARD_WIDTH,
            GRAVE_POS[Y] + CARD_WIDTH,
            GRAVE_POS[X] + CARD_WIDTH,
            GRAVE_POS[Y] - CARD_WIDTH
        ];
        card.delay = false;

        drawCardFront(cardIdx);

        printInfoText("Player " + curPlayer + " played a card!");
    }

    curPlayer = (curPlayer + 1) \% playerCount;
}

%%%%%%%%%%%%%%%%%%%%%
% Draw and coloring %
%%%%%%%%%%%%%%%%%%%%%
/**
 * Draw all cells.
 */
function fillCards() {
    for (var c = 0; c < CARDS.length; c++) {
        var card = this.getField("card" + c);
        card.delay = true;
        if (c >= CARDS.length * 0.5) {
            card.textColor = color.red;
        }
        card.textFont = font.Cour;
        card.textSize = TEXT_SIZE;
        card.alignment = "center";
        %card.value = CARDS[c];
        card.delay = false;
    }
}

function drawCardFront(cardIdx) {
    var card = this.getField("card" + cardIdx);
    card.delay = true;
    card.fillColor = color.white;
    card.value = CARDS[cardIdx];
    card.delay = false;
}

function drawCardBack(cardIdx) {
    var card = this.getField("card" + cardIdx);
    card.delay = true;
    card.fillColor = color.blue;
    card.value = "";
    card.delay = false;
}

const FOCUS_CARD = false;
var initState = !FOCUS_CARD;

function initCardPositions() {
    printInfoText("jo" + curCardIdx + " " + stack[curCardIdx]);

    if (curCardIdx < 0) {
        app.clearInterval(gameInterval);

        this.getField("tooltiptxt").setFocus();
        % for (var i = 0; i < CARD_COUNT; i++) {
        %     var idx2 = stack[i];
        %     var card = this.getField("card" + idx2);
        %     card.readonly = true;
        % }

        % TODO place top card of stack on graveyard

        return;
    }

    % initState = !initState;
    % if (initState == FOCUS_CARD) {
    %     var idx = stack[curCardIdx];
    %     var card = this.getField("card" + idx);
    %     card.setFocus();
    %     return;
    % }

    % for (var c = stack.length - 1; c >= 0; c--) {
        var idx = stack[curCardIdx];
        var card = this.getField("card" + idx);
        %card.delay = true;

        % card.setFocus();

        card.rect = [
            STACK_POS[X] - CARD_WIDTH,
            % STACK_POS[X] - CARD_WIDTH + curCardIdx * 30,
            % STACK_POS[X] * 0.5 - CARD_WIDTH + curCardIdx * 10,
            STACK_POS[Y] + CARD_WIDTH,
            STACK_POS[X] + CARD_WIDTH,
            % STACK_POS[X] + CARD_WIDTH + curCardIdx * 30,
            % STACK_POS[X] * 0.5 + CARD_WIDTH + curCardIdx * 10,
            STACK_POS[Y] - CARD_WIDTH
        ];
        %card.delay = false;
    % }

    drawCardBack(curCardIdx);

    curCardIdx--;

}

/**
 * Since only one cell is updated with each input,
 * only this cell needs to be redrawn.
 *
 * @param {Number} m The m position.
 * @param {Number} n The n position.
 */
function draw(m, n) {
    var cell = this.getField("cell" + m + "-" + n);
    cell.delay = true;
    cell.value = "tmp";
    cell.delay = false;
}

/**
 * Print information about the winner and the gamestate.
 */
function printInfoText(text) {
    var field = this.getField("info");
    field.delay = true;
    field.value = text;
    field.delay = false;
}

\end{insDLJS}

\OpenAction{/S /JavaScript /JS (initialise();)}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Dokument
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

    \begin{Form}

        % Header
        \begin{multicols}{2}
            % Title
            \section*{Mau mau}
        \columnbreak
            % Tooltip object
            \begin{flushright}%
                \PushButton[name=tooltipbtn, bordercolor=white]{%
                    \begin{tcolorbox}[width=20pt, height=20pt, left=3pt, top=0pt]
                        \centering?\strut{}
                    \end{tcolorbox}%
                }
            \end{flushright}%
        \end{multicols}

        % TODO make them readonly but carefull because of setFocus
        \begin{tcolorbox}[height=\linewidth, valign=center]
            \xintFor* #1 in {\xintSeq{0}{\cards-1}} \do {%
                \TextField[name=card#1, width=1cm, height=1cm,%
                    bordercolor=red, backgroundcolor=white, readonly=true%
                ]{}%
            }%
        \end{tcolorbox}

        %%%%%%%%%%%%%%%%%%%%%%%
        % Commandredifinition %
        % https://www.dickimaw-books.com/latex/admin/html/eforms.shtml
        %%%%%%%%%%%%%%%%%%%%%%%
        % \def\DefaultHeightofText{14pt}
        % \renewcommand*{\LayoutTextField}[2]{%
        %     \parbox[c][\DefaultHeightofText]{0.5\linewidth}{#1#2}%
        % }

        % \renewcommand*{\LayoutCheckField}[2]{#1 #2}
        % \renewcommand*{\DefaultWidthofCheckBox}{2ex}
        % \renewcommand*{\DefaultHeightofCheckBox}{2ex}
        % \renewcommand*{\LayoutCheckField}[2]{%
        %     \parbox[c][\DefaultHeightofCheckBox]{0.12\linewidth}{#1}\enspace%
        %     \parbox[c][\DefaultHeightofCheckBox]{\DefaultWidthofCheckBox}{#2}%
        % }

        % \renewcommand*{\DefaultWidthofChoiceMenu}{2.5ex}
        % \renewcommand*{\DefaultHeightofChoiceMenu}{2.04ex}

        %%%%%%%%%%%%%%%%
        % GUI elements %
        %%%%%%%%%%%%%%%%
        \begin{center}
            % Game related buttons
            \begin{tabularx}{\textwidth}{@{} *{2}{X} @{}}%
                \PushButton[name=restart, bordercolor=white, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        Restart game\strut
                    \end{tcolorbox}
                } &
                \begin{tcolorbox}
                    \TextField[name=info, width=\linewidth, readonly=true]{}
                \end{tcolorbox}
            \end{tabularx}
        \end{center}

        \TextField[bordercolor=white, name=tooltiptxt, readonly=true, hidden]{}

    \end{Form}
\end{document}
