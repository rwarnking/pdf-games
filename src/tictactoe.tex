\documentclass[12pt, a4paper]{scrartcl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[margin=0.5in]{geometry}

\usepackage[pdftex]{hyperref}
\usepackage{multicol}

\usepackage{xinttools}
\usepackage[nomessages]{fp}
\usepackage{tabularx}
\usepackage{tcolorbox}

\setlength{\parindent}{0pt}

\usepackage[pdftex]{insdljs}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Parameter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Values can be changed
\def\fieldWidth{3}
\def\fieldHeight{3}
\def\winningPieces{3}
% Max playercount is 5
\def\playerCount{2}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Javascript
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{insDLJS}[]{JSDateiname}{tic-tac-toe}

const GAME_DESC = "Tic-Tac-Toe is a turnbased multiplayer strategy game.\
Each player has a symbol which is used to mark parts of the field.\
The symbol is used to create a connected line of usually three symbols.\
The player who is able to create such a line first wins.";

% Outside variables
const FIELD_WIDTH = AFMakeNumber(\fieldWidth);
const FIELD_HEIGHT = AFMakeNumber(\fieldHeight);
const SCREEN_TEXT_SIZE = 300;
const WINNING_PIECES = AFMakeNumber(\winningPieces);
const MAX_PLAYERS = AFMakeNumber(\playerCount);

% Constants
const EMPTY = 0;

% Globals
% The game field
var complField = new Array();
% Lock if the game has ended
var gameover = false;
% Save the current turn
var playerIdx = 1;
% Save the last move for highlighting
var lastField = false;

% Symbol array (for each player)
const PLAYER_SYMBOLS = [
    0x2717,
    0x274D,
    0x2730,
    0x2752,
    0x271C
];

% Each player gets a color
const COLORS = new Array(
    [ "RGB", 0.843, 0.078, 0.058 ],
    [ "RGB", 0.203, 0.603, 0.054 ],
    [ "RGB", 0.078, 0.305, 0.560 ],
    [ "RGB", 0.560, 0.078, 0.533 ],
    color.black
);

const HIGHLIGHT_COLOR = [ "RGB", 0.984, 0.800, 0.176 ];

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Initialisation and Restart %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
/**
 * Initialise the default game state.
 */
function initialise() {
    % Initlialise the array with a zeros
    for (var row = 0; row < FIELD_HEIGHT; row++) {
        var zArr = new Array();
        for (var column = 0; column < FIELD_WIDTH; column++) {
            zArr.push(EMPTY);
        }
        complField.push(zArr);
    }

    % Init the GUI
    initialiseButtons();
}

/**
 * Initialise all buttons from the GUI.
 * For example add callbacks and set the correct colors.
 */
function initialiseButtons() {
    % Disables the rectangle around a button after the click
    app.focusRect = false;

    % Assign each button the coresponding function and disable the highlights
    this.getField("restart").setAction("MouseUp", "restart();");

    % Each field needs to be connected to an input function
    % Define text style
    var cell;
    var funcName = "markField";
    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            var callbackName = funcName + "(" + x.toString() + "," + y.toString() + ");";
            cell = this.getField("pos" + x + "-" + y);
            cell.setAction("MouseDown", callbackName);
            cell.textSize = SCREEN_TEXT_SIZE / Math.max(FIELD_HEIGHT, FIELD_WIDTH);
        }
    }

    % Tooltip setup
    this.getField("tooltipbtn").setAction("MouseDown", "tooltip(true);");
    this.getField("tooltipbtn").setAction("MouseUp", "tooltip(false);");

    % Print the initial move information
    printCurrentMove();
}

/**
 * Enable or disable the tooltip.
 *
 * @param {Boolean} on Enable or disable tooltip.
 */
function tooltip(on) {
    if (on) {
        % Move the tooltip field to the center of the screen
        % and adjust the size so the text can be displayed
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.hidden = false;
        field.value = GAME_DESC;

        field.multiline = true;
        field.textSize = 16;
        % height 842, width 596
        % upper-left x, upper-left y, lower-right x and lower-right y
        field.rect = [128, 601, 468, 401];

        this.getField("tooltiptxt").setFocus();

        field.delay = false;
    } else {
        % Remove the field such that it is not visible
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.hidden = true;
        field.delay = false;
    }
}

/**
 * Restart the game and clear everything
 */
function restart() {
    % Reset field
    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            complField[y][x] = EMPTY;
            resetDraw(x, y);
        }
    }

    % Reset game state
    lastField = false;
    gameover = false;
    playerIdx = 1;

    % Print the initial move information
    printCurrentMove();
}

%%%%%%%%%%%%%
% Gamelogic %
%%%%%%%%%%%%%
/**
 * Set the value of the input field.
 *
 * @param {Number} x The x position.
 * @param {Number} y The y position.
 */
function markField(x, y) {
    % Remove blinking cursor after selection
    this.getField("info").setFocus();

    if (gameover || complField[y][x] != EMPTY) {
        return;
    }

    complField[y][x] = playerIdx;

    % Check for winner (playerIdx)
    var winner = checkForWinner(x, y);

    playerIdx++;
    if (playerIdx > MAX_PLAYERS) {
        playerIdx = 1;
    }

    % Print the current move information
    printCurrentMove();

    % Check if field full
    var full = true;
    if (winner == 0) {
        for (var xx = 0; xx < FIELD_WIDTH; xx++) {
            for (var yy = 0; yy < FIELD_HEIGHT; yy++) {
                if (complField[yy][xx] == EMPTY) {
                    full = false;
                    yy = FIELD_HEIGHT;
                    xx = FIELD_WIDTH;
                }
            }
        }
    }

    % When there is a winner of the field is full -> gameover
    % Print whether the game is over, or whos turn it is
    if (winner > 0) {
        gameover = true;
        var symbol = String.fromCharCode(PLAYER_SYMBOLS[winner - 1]);
        var text = "The winner is: Player " + winner + " - (" + symbol + ")";
        printInfoText(text, COLORS[winner - 1]);
    } else if (full) {
        gameover = true;
        printInfoText("No one did win and the field is full.");
    }

    draw(x, y);

    % Safe the last field so it can be marked
    lastField = [x, y];
}

/**
 * Check if there is a winner.
 * This is done using the last input that was taken,
 * since the game can only be won when the current
 * move is responsible for that.
 * Therefore all directions are checked whether a line
 * of a set length with the current player symbol can be formed.
 *
 * @param {Number} x The x position.
 * @param {Number} y The y position.
 * @return {Number} The player index or 0 if no winner
 */
function checkForWinner(x, y) {
    var count = 0;
    var maxCount = 0;
    % Define directions
    var directions = [
        0, 1,
        1, 1,
        1, 0,
        1, -1
    ]
    % Iterate directions
    for (var dirIdx = 0; dirIdx < directions.length; dirIdx += 2) {
        count = 0;
        maxCount = 0;
        % Count succeeding stones
        for (var wp = -WINNING_PIECES + 1; wp < WINNING_PIECES; wp++) {
            var nx = x + directions[dirIdx] * wp;
            var ny = y + directions[dirIdx + 1] * wp;
            % Border check
            if (nx < 0 || nx >= FIELD_WIDTH ||
                ny < 0 || ny >= FIELD_HEIGHT ||
                complField[ny][nx] != playerIdx
            ) {
                % Reset counter when line is broken
                count = 0;
            } else {
                count++;
                maxCount = count;
            }
        }
        % When there where enough pieces a winner was found
        if (maxCount >= WINNING_PIECES) {
            return playerIdx;
        }
    }
    return 0;
}

%%%%%%%%%%%%%%%%%%%%%
% Draw and coloring %
%%%%%%%%%%%%%%%%%%%%%
/**
 * Since only one field is updated with each input,
 * only this field needs to be redrawn.
 *
 * @param {Number} x The x position.
 * @param {Number} y The y position.
 */
function draw(x, y) {
    var field = this.getField("pos" + x + "-" + y);
    field.delay = true;
    var value = complField[y][x];

    field.textColor = COLORS[value - 1];
    field.value = String.fromCharCode(PLAYER_SYMBOLS[value - 1]);

    % Highlight the current taken move
    field.borderColor = HIGHLIGHT_COLOR;
    field.delay = false;

    % Reset highlight the last taken move
    if (lastField !== false) {
        var xx = lastField[0];
        var yy = lastField[1];
        field = this.getField("pos" + xx + "-" + yy);
        field.delay = true;
        field.borderColor = color.white;
        field.delay = false;
    }
}

/**
 * Reset the current field to its default state.
 *
 * @param {Number} x The x position.
 * @param {Number} y The y position.
 */
function resetDraw(x, y) {
    var field = this.getField("pos" + x + "-" + y);
    field.delay = true;
    field.textColor = color.black;
    field.value = "";
    field.borderColor = color.white;
    field.delay = false;
}

/**
 * Print information about which players turn it is.
 */
function printCurrentMove() {
    var symbol = String.fromCharCode(PLAYER_SYMBOLS[playerIdx - 1]);
    var text = "Please make a move: Player " + playerIdx + " - (" + symbol + ")";
    printInfoText(text);
}

/**
 * Print information about the game.
 *
 * @param {String} text Info string
 */
function printInfoText(text, col=color.black) {
    var field = this.getField("info");
    field.delay = true;
    field.value = text;
    field.textColor = col;
    field.delay = false;
}

\end{insDLJS}

\OpenAction{/S /JavaScript /JS (initialise();)}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Dokument
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

    \begin{Form}

        % Header
        \begin{multicols}{2}
            % Title
            \section*{Tic-Tac-Toe}
        \columnbreak
            % Tooltip object
            \begin{flushright}%
                \PushButton[name=tooltipbtn, bordercolor=, backgroundcolor=, borderwidth=0]{%
                    \begin{tcolorbox}[width=20pt, height=20pt, left=3pt, top=0pt]
                        \centering?\strut{}
                    \end{tcolorbox}%
                }
            \end{flushright}%
        \end{multicols}

        % Dynamically adjust the cell width and height to the number of cells
        % Calculate the max width and height of a block
        \FPeval{\resultW}{(\fieldWidth * 3 - 2)} % chktex 8
        \def\blocksizeW{\dimexpr (\linewidth-\resultW pt)/\fieldWidth \relax}

        \FPeval{\resultH}{(\fieldHeight * 3 + 3)}
        \def\blocksizeH{\dimexpr (500 pt -\resultH pt)/\fieldHeight \relax}

        % The game board
        \begin{tcolorbox}
            % Define the cellsize via the smaller amount
            % Must be done here so the \linewidth has the correct value
            \ifdim\blocksizeW<\blocksizeH
                \def\blocksize{\blocksizeW}
            \else
                \def\blocksize{\blocksizeH}
            \fi

            \begin{center}
                \tiny
                \xintFor* #2 in {\xintSeq{0}{\fieldHeight-1}} \do {%
                    \xintFor* #1 in {\xintSeq{0}{\fieldWidth-1}} \do {%
                        \TextField[%
                            name=pos#1-#2, width=\blocksize, height=\blocksize,%
                            bordercolor=white, align=1, readonly%
                        ]{}%
                        \xintifForLast{}{\hspace{3pt}}%
                    }\vspace{3pt}\\[-1pt]%
                }%
            \end{center}%
        \end{tcolorbox}

        \begin{center}%
            \begin{tabularx}{\textwidth}{@{} *{2}{X} @{}}%
                \PushButton[name=restart, bordercolor=, backgroundcolor=, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        Restart game\strut
                    \end{tcolorbox}
                } &
                \begin{tcolorbox}
                    \TextField[name=info, width=\linewidth,
                        bordercolor=, backgroundcolor=, readonly]{}
                \end{tcolorbox}
            \end{tabularx}
        \end{center}

        \TextField[name=tooltiptxt, bordercolor=, backgroundcolor=gray, readonly, hidden]{}

    \end{Form}
\end{document}
