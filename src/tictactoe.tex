\documentclass[12pt, a4paper, footexclude, headexclude]{scrartcl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[margin=0.5in]{geometry}

\usepackage[utf8x]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[ngerman]{babel}
\usepackage{xcolor}
\usepackage[pdftex]{hyperref}
\usepackage{multicol}

\usepackage{xinttools}
\usepackage[nomessages]{fp}
\usepackage{tabularx}
\usepackage{tcolorbox}

\setlength{\parindent}{0pt}

% Einbindung von Javascript ins PDF
\usepackage[pdftex]{insdljs}
%\renewcommand{\MakeTextField}[2]{{\vbox to #2{\vfill\hbox to #1{\hrulefill}}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Parameter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Obacht: It is discuraged to use a field with size bigger than 15x15 since the pdf might get
% to slow to play
\def\fieldWidth{3}
\def\fieldHeight{3}
\def\winningPieces{3}
% Max playercount is 5
\def\playerCount{2}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Javascript
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Inhalt der Umgebung wird in JSDateiname.djs gespeichert und steht im PDF zur Verf√ºgung
\begin{insDLJS}[]{JSDateiname}{TicTacToe}

const FIELD_WIDTH = AFMakeNumber(\fieldWidth);
const FIELD_HEIGHT = AFMakeNumber(\fieldHeight);
const SCREEN_TEXT_WIDTH = 300;
const WINNING_PIECES = AFMakeNumber(\winningPieces);
const MAY_PLAYERS = AFMakeNumber(\playerCount);

var run;
var complField = new Array();
% Lock if the game has ended
var gameover = false;
var playerIdx = 1;
var lastField = false;

var playerSymbols = [
    0x2717,
    0x274D,
    0x2730,
    0x2752,
    0x271C
];

var colors = new Array(
    [ "RGB", 0.843, 0.078, 0.058 ],
    [ "RGB", 0.203, 0.603, 0.054 ],
    [ "RGB", 0.078, 0.305, 0.560 ],
    [ "RGB", 0.560, 0.078, 0.533 ],
    color.black
);

highlightcolor = [ "RGB", 0.984, 0.800, 0.176 ];

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Initialisation and Restart %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function initialise() {
    for (var row = 0; row < FIELD_HEIGHT; row++) {
        var tmp = new Array();
        for (var column = 0; column < FIELD_WIDTH; column++) {
            tmp.push(0);
        }
        complField.push(tmp);
    }

    initialiseButtons();
}

function initialiseButtons() {
    this.getField("restart").setAction("MouseUp", "restart();");
    this.getField("restart").highlight="none";

    var funcName = "markField";
    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            var callbackName = funcName + "(" + x.toString() + "," + y.toString() + ");";
            this.getField("pos" + x + y).setAction("MouseDown", callbackName);
            this.getField("pos" + x + y).textSize = SCREEN_TEXT_WIDTH / FIELD_WIDTH;
            this.getField("pos" + x + y).alignment = "center";
        }
    }

    this.getField("winner").fillColor = color.transparent;
    this.getField("winner").borderColor = color.transparent;

    this.getField("tooltipbtn").setAction("MouseDown", "tooltip(true);");
    this.getField("tooltipbtn").setAction("MouseUp", "tooltip(false);");
    this.getField("tooltipbtn").highlight="none";

    printInfoText(0, false);
}

function tooltip(on) {
    if (on) {
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.alignment = "center";
        field.value = "This is a game.";

        field.fillColor = color.gray;
        % hight 842, width 596
        % upper-left x, upper-left y, lower-right x and lower-right y
        field.rect = [128, 601, 468, 401];

        field.delay = false;
    } else {
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.value = "";

        field.fillColor = color.gray;
        field.rect = [0, 0, 0, 0];

        field.delay = false;
    }
}

function restart() {
    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            complField[y][x] = 0;
        }
    }

    % Reset field marking
    lastField = false;

    gameover = false;
    playerIdx = 1;

    printInfoText(0, false);

    draw();
}

%%%%%%%%%%%%%%%%%%%%%
% Draw and coloring %
%%%%%%%%%%%%%%%%%%%%%
function markField(x, y) {
    if (gameover || complField[y][x] != 0) {
        return;
    }

    % Safe the last field so it can be marked
    lastField = [x, y];

    complField[y][x] = playerIdx;

    % Check for winner (playerIdx)
    var winner = checkForWinner(x, y);

    playerIdx++;
    if (playerIdx > MAY_PLAYERS) {
        playerIdx = 1;
    }

    % Check if field full
    var full = true;
    if (winner == 0) {
        for (var x = 0; x < FIELD_WIDTH; x++) {
            for (var y = 0; y < FIELD_HEIGHT; y++) {
                if (complField[y][x] == 0) {
                    full = false;
                    y = FIELD_HEIGHT;
                    x = FIELD_WIDTH;
                }
            }
        }
    }

    if (winner > 0 || full) {
        gameover = true;
    }

    % Print whether the game is over, or whos turn it is
    printInfoText(winner, full);

    draw();
}

function checkForWinner(x, y) {
    var count = 0;
    var maxCount = 0;
    % Define directions
    var directions = [
        0, 1,
        1, 1,
        1, 0,
        1, -1
    ]
    % Iterate directions
    for (var dirIdx = 0; dirIdx < directions.length; dirIdx += 2) {
        count = 0;
        maxCount = 0;
        % Count succeeding stones
        for (var wp = -WINNING_PIECES + 1; wp < WINNING_PIECES; wp++) {
            var nx = x + directions[dirIdx] * wp;
            var ny = y + directions[dirIdx + 1] * wp;
            if (nx < 0 || nx >= FIELD_WIDTH || ny < 0 || ny >= FIELD_HEIGHT || complField[ny][nx] != playerIdx) {
                count = 0;
            } else {
                count++;
                maxCount = count;
            }
        }
        if (maxCount >= WINNING_PIECES) {
            return playerIdx;
        }
    }
    return 0;
}

function draw() {
    var field;
    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            field = this.getField("pos" + x + y);
            field.delay = true;
            var value = complField[y][x];
            if (value > 0) {
                field.textColor = colors[value - 1];
                field.value = String.fromCharCode(playerSymbols[value - 1]);
            } else {
                field.value = "";
            }
            field.borderColor = color.white;
            field.delay = false;
        }
    }

    if (lastField !== false) {
        var x = lastField[0];
        var y = lastField[1];
        field = this.getField("pos" + x + y);
        field.delay = true;
        field.borderColor = highlightcolor;
        field.delay = false;
    }
}

function printInfoText(winner, full) {
    var field = this.getField("winner");
    field.delay = true;
    if (winner > 0) {
        field.textColor = colors[winner - 1];
        var symbol = String.fromCharCode(playerSymbols[winner - 1]);
        field.value = "The winner is: Player " + winner + " - (" + symbol + ")";
    } else if (full) {
        field.textColor = color.black;
        this.getField("winner").value = "No one did win and the field is full.";
    } else {
        field.textColor = color.black;
        var symbol = String.fromCharCode(playerSymbols[playerIdx - 1]);
        field.value = "Please make a move: Player " + playerIdx + " - (" + symbol + ")";
    }
    field.delay = false;
}

\end{insDLJS}

\OpenAction{/S /JavaScript /JS (initialise();)}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Dokument
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

    \begin{multicols}{2}
        \section*{Tic Tac Toe}
    \columnbreak
        \begin{flushright}%
        \PushButton[name=tooltipbtn, bordercolor=white]{%
            \begin{tcolorbox}[width=20pt, height=20pt, left=3pt, top=0pt]
                \centering
                ?\strut
            \end{tcolorbox}%
        }
        \end{flushright}%
    \end{multicols}

    % Calculate the max width and height of a block
    \FPeval{\resultW}{(\fieldWidth * 4 + 3)}
    \def\blocksizeW{\dimexpr (\linewidth-\resultW pt)/\fieldWidth \relax}

    \FPeval{\resultH}{(\fieldHeight * 4 + 3)}
    \def\blocksizeH{\dimexpr (500 pt -\resultH pt)/\fieldHeight \relax}

    % Define the blocksize via the smaller amount
    \ifnum\blocksizeW<\blocksizeH
        \def\blocksize{\blocksizeW}
    \else
        \def\blocksize{\blocksizeH}
    \fi

    \begin{Form}

        \begin{tcolorbox}
            \begin{flushright}
                \xintFor* #2 in {\xintSeq{0}{\fieldHeight-1}} \do {%
                    \xintFor* #1 in {\xintSeq{0}{\fieldWidth-1}} \do {%
                        \TextField[%
                            width=\blocksize, height=\blocksize,%
                            bordercolor=white, name=pos#1#2, readonly=true]{}%
                    }\vspace{3pt}
                    \newline%
                }%
            \end{flushright}%
        \end{tcolorbox}

        \begin{center}%
            \begin{tabularx}{\textwidth}{@{} X X @{}}%
                \PushButton[name=restart, bordercolor=white]{
                    \begin{tcolorbox}
                        \centering
                        Restart game\strut
                    \end{tcolorbox}
                } &
                \begin{tcolorbox}
                    \TextField[name=winner, width=\linewidth, readonly=true]{}
                \end{tcolorbox}
            \end{tabularx}
        \end{center}

        \TextField[bordercolor=white, name=tooltiptxt, readonly=true]{}

    \end{Form}
\end{document}
