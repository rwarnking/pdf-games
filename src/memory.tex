\documentclass[12pt, a4paper]{scrartcl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[margin=0.5in]{geometry}

\usepackage[pdftex]{hyperref}
\usepackage{multicol}

\usepackage{xinttools}
\usepackage[nomessages]{fp}
\usepackage{tabularx}
\usepackage{tcolorbox}

\setlength{\parindent}{0pt}

\usepackage[pdftex]{insdljs}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Parameter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Values can be changed
% Obacht: width * height needs to be an even number
\def\fieldWidth{6}
\def\fieldHeight{6}

% Max playercount is 5
\def\playerCount{3}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Javascript
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{insDLJS}[]{JSDateiname}{Memory}

const GAME_DESC = "In this game multiple player compete to collect the most pairs.\
Each pair contains two cards with the same symbol on it. At the beginning all\
cards are hidden and each player can reveal two of them when it is their turn.\
After the reveal both are hidden again if they do not match or they are removed if they do.\
In that case the reveiling player gets another turn.";

% Outside variables
const FIELD_WIDTH = AFMakeNumber(\fieldWidth);
const FIELD_HEIGHT = AFMakeNumber(\fieldHeight);
const SCREEN_TEXT_WIDTH = 300;
const MAX_PLAYERS = AFMakeNumber(\playerCount);
const MAX_PAIRS = (FIELD_WIDTH * FIELD_HEIGHT) / 2;

% Constants
% -

% Globals
% The game field array
var complField = new Array();
% Lock if the game has ended
var gameover = false;
var playerIdx = 1;
var lastField = false;
var beforeLastField = false;
var pairsFound = 0;
var playerPoints = [];

% Symbol array
const MEMORY_SYMBOLS = [
    0x260E, % telefon
    0x261E, % hand white
    0x261B, % hand black
    0x263B, % smilie
    0x266B, % note
    0x2702, % scissors
    0x2712, % pencil
    0x2706, % telefon2
    0x2707, % video
    0x2708, % plane
    0x2709, % mail
    0x2756, % diamond
    0x271F, % cross
    0x2717,
    0x274D,
    0x2730,
    0x2752,
    0x271C
];

%%%%%%%%%%
% Helper %
%%%%%%%%%%
/**
 * Returns a random number between 0 and the param.
 * @param {Number} max The upperbound
 */
function getRandomInt(max) {
    return Math.floor(Math.random() * max);
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Initialisation and Restart %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
/**
 * Initialise the default game state.
 */
function initialise() {
    % Create an array that contains all symbols twice
    var symbols = [];
    for (var i = 0; i < MAX_PAIRS; i++) {
        symbols.push(String.fromCharCode(MEMORY_SYMBOLS[i \% MEMORY_SYMBOLS.length]));
        symbols.push(String.fromCharCode(MEMORY_SYMBOLS[i \% MEMORY_SYMBOLS.length]));
    }

    % Create the field by removing one element for each slot
    for (var row = 0; row < FIELD_HEIGHT; row++) {
        var tmp = new Array();
        for (var column = 0; column < FIELD_WIDTH; column++) {
            var rnd = getRandomInt(symbols.length);
            var elem = symbols[rnd];
            symbols.splice(rnd, 1);
            % UTF8 symbol and is the field removed
            tmp.push([elem, false]);
        }
        complField.push(tmp);
    }

    for (var i = 0; i < MAX_PLAYERS; i++) {
        playerPoints.push(0);
    }

    % Init the GUI
    initialiseButtons();
}

/**
 * Initialise all buttons from the GUI.
 * For example add callbacks.
 */
function initialiseButtons() {
    % Assign each button the coresponding function and disable the highlights
    this.getField("restart").setAction("MouseUp", "restart();");
    this.getField("restart").highlight="none";

    var funcName = "revealField";
    var cell;
    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            var callbackName = funcName + "(" + x.toString() + "," + y.toString() + ");";
            cell = this.getField("pos" + x + "-" + y);
            cell.setAction("MouseDown", callbackName);
            cell.textSize = SCREEN_TEXT_WIDTH / Math.max(FIELD_HEIGHT, FIELD_WIDTH);
            cell.alignment = "center";
        }
    }

    % Tooltip button setup
    this.getField("tooltipbtn").setAction("MouseDown", "tooltip(true);");
    this.getField("tooltipbtn").setAction("MouseUp", "tooltip(false);");

    printInfoText("Your Turn: Player " + playerIdx);
}

/**
 * Restarts the game by clearing the field array and redistributing cards.
 * Resets playerpoints and gamevars.
 */
function restart() {
    % Create an array that contains all symbols twice
    var symbols = [];
    for (var i = 0; i < MAX_PAIRS; i++) {
        symbols.push(String.fromCharCode(MEMORY_SYMBOLS[i]));
        symbols.push(String.fromCharCode(MEMORY_SYMBOLS[i]));
    }

    % Create the field by removing one element for each slot
    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            var rnd = getRandomInt(symbols.length);
            var elem = symbols[rnd];
            symbols.splice(rnd, 1);
            complField[y][x] = [elem, false];

            var field = this.getField("pos" + x + "-" + y);
            field.delay = true;
            field.value = "";
            field.borderColor = color.white;
            field.delay = false;
        }
    }

    for (var i = 0; i < MAX_PLAYERS; i++) {
        playerPoints[i] = 0;
    }

    % Reset field marking
    beforeLastField = false;
    lastField = false;

    gameover = false;
    pairsFound = 0;
    playerIdx = 1;

    printInfoText("Your Turn: Player " + playerIdx);
}

/**
 * Enable or disable the tooltip.
 *
 * @param {Boolean} on Enable or disable tooltip.
 */
function tooltip(on) {
    if (on) {
        % Move the tooltip field to the center of the screen
        % and adjust the size so the text can be displayed
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.hidden = false;
        field.value = GAME_DESC;

        field.multiline = true;
        field.textSize = 16;
        % height 842, width 596
        % upper-left x, upper-left y, lower-right x and lower-right y
        field.rect = [128, 601, 468, 401];

        this.getField("tooltiptxt").setFocus();

        field.delay = false;
    } else {
        % Remove the field such that it is not visible
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.hidden = true;
        field.delay = false;
    }
}

%%%%%%%%%%%%%
% Gamelogic %
%%%%%%%%%%%%%
/**
 * Reveal the card at the given coordinates.
 * If already two fields are revealed, they are either hidden or removed.
 * Does not do anything if field is already revealed.
 *
 * @param {Number} x The x coordinate.
 * @param {Number} y The y coordinate.
 */
function revealField(x, y) {
    % This removes the cursor and fixes minor bugs
    this.getField("restart").setFocus();

    if (gameover) {
        return;
    }

    % If there are two fields selected either hide or remove them
    if (beforeLastField != false && lastField != false) {

        % Test if symbols match
        var match = complField[lastField[1]][lastField[0]][0] ==
            complField[beforeLastField[1]][beforeLastField[0]][0];
        if (match) {
            % Remove both symbols
            remove(lastField[0], lastField[1]);
            remove(beforeLastField[0], beforeLastField[1]);

            complField[lastField[1]][lastField[0]][1] = true;
            complField[beforeLastField[1]][beforeLastField[0]][1] = true;

            % Check if field is full or pairs left
            if (++pairsFound == MAX_PAIRS) {
                gameover = true;
                % Print game is over
                printInfoText("The Game is over, all pairs found.");
            }
        } else {
            % Hide both symbols
            draw(lastField[0], lastField[1], "");
            draw(beforeLastField[0], beforeLastField[1], "");
        }
        beforeLastField = false;
        lastField = false;

        return;
    }

    if (complField[y][x][1]) {
        return;
    }

    % If one field is selected allow for a second one
    if (lastField != false && (lastField[0] != x || lastField[1] != y)) {
        % Save both selections
        beforeLastField = lastField;
        lastField = [x, y];

        % Test if symbols match
        var match = complField[lastField[1]][lastField[0]][0] ==
            complField[beforeLastField[1]][beforeLastField[0]][0];
        if (!match) {
            % Advance player
            playerIdx++;
            if (playerIdx > MAX_PLAYERS) {
                playerIdx = 1;
            }
        } else {
            playerPoints[playerIdx - 1]++;
        }
        % Print whos turn it is
        printInfoText("Your Turn: Player " + playerIdx);
    } else {
        lastField = [x, y];
    }

    draw(x, y, complField[y][x][0]);
}

%%%%%%%%%%%%%%%%%%%%%
% Draw and coloring %
%%%%%%%%%%%%%%%%%%%%%
/**
 * Redraw the given position using the given value.
 *
 * @param {Number} x The x position.
 * @param {Number} y The y position.
 * @param {String} value The text value.
 */
function draw(x, y, value) {
    var field = this.getField("pos" + x + "-" + y);
    field.delay = true;
    field.value = value;
    field.delay = false;
}

/**
 * Remove the value at the given position.
 *
 * @param {Number} x The x position.
 * @param {Number} y The y position.
 */
function remove(x, y) {
    var field = this.getField("pos" + x + "-" + y);
    field.delay = true;
    field.value = "";
    field.borderColor = color.black;
    field.delay = false;
}

/**
 * Print information about the game.
 *
 * @param {String} text Info string
 */
function printInfoText(text) {
    var field = this.getField("info");
    field.delay = true;
    field.value = text;
    field.delay = false;

    % Refresh the current points
    var field = this.getField("pointtable");
    field.delay = true;
    var string = "";
    for (var i = 0; i < MAX_PLAYERS; i++) {
        string += "Player " + (i + 1) + " has " + playerPoints[i] + " Points.\n";
    }
    field.value = string;
    field.delay = false;
}

\end{insDLJS}

\OpenAction{/S /JavaScript /JS (initialise();)}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Dokument
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

    \begin{Form}

        % Header
        \begin{multicols}{2}
            % Title
            \section*{Memory}
        \columnbreak
            % Tooltip object
            \begin{flushright}%
                \PushButton[name=tooltipbtn, bordercolor=, borderwidth=0]{%
                    \begin{tcolorbox}[width=20pt, height=20pt, left=3pt, top=0pt]
                        \centering?\strut{}
                    \end{tcolorbox}%
                }
            \end{flushright}%
        \end{multicols}

        % Dynamically adjust the cell width and height to the number of cells
        % Calculate the max width and height of a block
        \FPeval{\resultW}{(\fieldWidth * 3 - 2)} % chktex 8
        \def\blocksizeW{\dimexpr (\linewidth-\resultW pt)/\fieldWidth \relax}

        \FPeval{\resultH}{(\fieldHeight * 3 + 3)}
        \def\blocksizeH{\dimexpr (500 pt -\resultH pt)/\fieldHeight \relax}

        % The game board
        \begin{tcolorbox}
            % Define the cellsize via the smaller amount
            % Must be done here so the \linewidth has the correct value
            \ifdim\blocksizeW<\blocksizeH
                \def\blocksize{\blocksizeW}
            \else
                \def\blocksize{\blocksizeH}
            \fi

            \begin{center}
                \xintFor* #2 in {\xintSeq{0}{\fieldHeight-1}} \do {%
                    \xintFor* #1 in {\xintSeq{0}{\fieldWidth-1}} \do {%
                        \TextField[%
                            name=pos#1-#2, bordercolor=white,%
                            width=\blocksize, height=\blocksize, readonly%
                        ]{}%
                        \xintifForLast{}{\hspace{3pt}}%
                    }\vspace{3pt}\\[-1pt]%
                }%
            \end{center}%
        \end{tcolorbox}

        % Game related buttons
        \begin{center}%
            \begin{tabularx}{\textwidth}{@{} *{2}{X} @{}}%
                \PushButton[name=restart, bordercolor=white]{
                    \begin{tcolorbox}
                        \centering
                        Restart game\strut
                    \end{tcolorbox}
                } &
                \begin{tcolorbox}
                    \TextField[name=info, width=\linewidth,
                        bordercolor=, backgroundcolor=, readonly]{}
                \end{tcolorbox}
            \end{tabularx}
        \end{center}

        \TextField[name=pointtable, bordercolor=black, readonly=true, multiline=true]{}
        \TextField[name=tooltiptxt, bordercolor=, backgroundcolor=gray, readonly, hidden]{}

    \end{Form}
\end{document}
