\documentclass[12pt, a4paper]{scrartcl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[margin=0.5in]{geometry}

\usepackage[pdftex]{hyperref}
\usepackage{multicol}

\usepackage{xinttools}
\usepackage[nomessages]{fp}
\usepackage{tabularx}
\usepackage{tcolorbox}

\setlength{\parindent}{0pt}

\usepackage[pdftex]{insdljs}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Parameter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Obacht: It is discouraged to use more than 50 particles the performance might be to bad
\def\particleCount{20}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% JavaScript
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{insDLJS}[]{JSDateiname}{particles}

const GAME_DESC = "In this application you can see a small particle system.\
Via the GUI it is possible to choose one of the available.";

% Outside variables
const PARTICLE_COUNT = AFMakeNumber(\particleCount);

% Constants
% Spawn dimensions
const UPPER_LIMIT = 842;
const LOWER_LIMIT = 0;
const LEFT_LIMIT = 0;
const RIGHT_LIMIT = 596;
const PARTICLE_SIZE = 10;
const PARTICLE_SIZE_H = PARTICLE_SIZE / 2;
% The amount of space that a particle moves each frame
const STEP_SIZE = 4;
const DEAD = false;
const ALIVE = true;

const X = 0;
const Y = 1;
const LIFESTATE = 0;
const POS = 1;
const SYMB_IDX = 2;

% Globals
% Animation interval variable
var run;
% Particle array
var particles = new Array();
var particleType = 0;

% Probabilities for emits
const PROBABILITY = [
    98,
    50
]

% Particle arrays
const SNOW_SYMBOLS = [
    0x2744,
    0x2745,
    0x2746,
    0x2749
]

const FLOWER_SYMBOLS = [
    0x2740
];

const CIRCLE_SYMBOLS = [
    0x25CF,
    0x25CB,
    0x25CC
];

%%%%%%%%%%
% Helper %
%%%%%%%%%%
/**
 * Returns a random number between 0 and the parameter.
 * @param {Number} max The upper bound
 */
function getRandomInt(max) {
    return Math.floor(Math.random() * max);
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Initialization and Restart %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
/**
 * Initialize the default particle state.
 */
function initialize() {
    % Initialize all particles as dead
    var particle;
    for (var idx = 0; idx < PARTICLE_COUNT; idx++) {
        % Lifestate, position, symbol index
        particles.push([DEAD, [0, 0], 0]);

        particle = this.getField("particle" + idx);
        particle.delay = true;
        particle.rect = [0, 0, 0, 0];
        particle.delay = false;
    }

    % Initialize the GUI
    initializeButtons();

    % Start the animation interval
    run = app.setInterval("runAll()", 100);
}

/**
 * Initialize all buttons from the GUI.
 * For example add callbacks.
 */
function initializeButtons() {
    % Disables the rectangle around a button after the click
    app.focusRect = false;

    % Assign each button the corresponding function and disable the highlights
    this.getField("restart").setAction("MouseUp", "restart();");

    this.getField("particleType").currentValueIndices = 0;
    this.getField("particleType").commitOnSelChange = true;

    % Tooltip setup
    this.getField("tooltipbtn").setAction("MouseDown", "tooltip(true);");
    this.getField("tooltipbtn").setAction("MouseUp", "tooltip(false);");
}

/**
 * Restart the particle system and the interval.
 */
function restart() {
    app.clearInterval(run);

    var particle;
    for (var idx = 0; idx < PARTICLE_COUNT; idx++) {
        % Lifestate, position, symbol index
        particles[idx] = [DEAD, [0, 0], 0];

        particle = this.getField("particle" + idx);
        particle.delay = true;
        particle.rect = [0, 0, 0, 0];
        particle.textSize = PARTICLE_SIZE;
        particle.delay = false;
    }

    run = app.setInterval("runAll()", 100);
}

/**
 * Enable or disable the tooltip.
 *
 * @param {Boolean} on Enable or disable tooltip.
 */
function tooltip(on) {
    if (on) {
        % Move the tooltip field to the center of the screen
        % and adjust the size so the text can be displayed
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.hidden = false;
        field.value = GAME_DESC;

        field.multiline = true;
        field.textSize = 16;
        % height 842, width 596
        % upper-left x, upper-left y, lower-right x and lower-right y
        field.rect = [128, 601, 468, 401];

        this.getField("tooltiptxt").setFocus();

        field.delay = false;
    } else {
        % Remove the field such that it is not visible
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.hidden = true;
        field.delay = false;
    }
}

%%%%%%%%%%%%%%%%
% Drawing loop %
%%%%%%%%%%%%%%%%
/**
 * Main loop used to emit new particles or move the current ones.
 */
function runAll() {
    particleType = this.getField("particleType").currentValueIndices;

    % Emit new particle if particle dead and random condition
    for (var idx = 0; idx < PARTICLE_COUNT; idx++) {
        if (particles[idx][LIFESTATE] === false &&
            getRandomInt(100) > PROBABILITY[particleType]
        ) {
            emitParticle(idx);
        } else {
            moveParticles(idx);
        }
    }

}

/**
 * Emits a new particle for the given index.
 * Dependent on the selected particle system.
 *
 * @param {Number} idx The index of the particle in the array.
 */
function emitParticle(idx) {
    if (particleType == 0) {
        var pos = getRandomInt(RIGHT_LIMIT - PARTICLE_SIZE) + PARTICLE_SIZE_H;
        % Select a random snow symbol
        var symb = SNOW_SYMBOLS[getRandomInt(SNOW_SYMBOLS.length)];
        % Lifestate, position, symbol
        particles[idx] = [ALIVE, [pos, UPPER_LIMIT - PARTICLE_SIZE_H], symb];
    } else {
        var posX = getRandomInt(RIGHT_LIMIT - PARTICLE_SIZE) + PARTICLE_SIZE_H;
        var posY = getRandomInt(UPPER_LIMIT - PARTICLE_SIZE) + PARTICLE_SIZE_H;
        % Lifestate, position, symbol index
        particles[idx] = [ALIVE, [posX, posY], 0];
    }
}

/**
 * Move the particle with the given index.
 * Dependent on the selected particle system.
 *
 * @param {Number} idx The index of the particle in the array.
 */
function moveParticles(idx) {
    var shiftX = 0;
    var addX = 0;
    var addY = 0;
    var particle = this.getField("particle" + idx);
    particle.delay = true;

    if (particleType == 0) {
        particle.value = String.fromCharCode(particles[idx][SYMB_IDX]);
        particle.textSize = PARTICLE_SIZE;
        % Apply shifting motion like waves
        shiftX = Math.cos((particles[idx][POS][X] + particles[idx][POS][Y]) / 40.0) * 20;

        particles[idx][POS][Y] -= STEP_SIZE;
        % Ending lifecycle when out of render area
        if (particles[idx][POS][Y] < LOWER_LIMIT) {
            particles[idx][LIFESTATE] = DEAD;
        }
    } else {
        particle.value = String.fromCharCode(
            CIRCLE_SYMBOLS[Math.floor(particles[idx][SYMB_IDX] / 3)]
        );
        particle.textSize = PARTICLE_SIZE + particles[idx][SYMB_IDX] * 2;

        particles[idx][SYMB_IDX]++;
        addX = particles[idx][SYMB_IDX];
        addY = particles[idx][SYMB_IDX];
        % Ending lifecycle when all symbols iterated
        if (particles[idx][SYMB_IDX] >= CIRCLE_SYMBOLS.length * 3) {
            particles[idx][LIFESTATE] = DEAD;
        }
    }

    % Adjust the rect position of the TextField
    var rect = [
        particles[idx][POS][X] - PARTICLE_SIZE_H - addX + shiftX,
        particles[idx][POS][Y] + PARTICLE_SIZE_H + addY,
        particles[idx][POS][X] + PARTICLE_SIZE_H + addX + shiftX,
        particles[idx][POS][Y] - PARTICLE_SIZE_H - addY
    ];
    particle.rect = rect;

    particle.delay = false;
}

\end{insDLJS}

\OpenAction{/S /JavaScript /JS (initialize();)}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Document
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

    \begin{Form}

        % Header
        \begin{multicols}{2}
            % Title
            \section*{Particles}
        \columnbreak
            % Tooltip object
            \begin{flushright}%
                \PushButton[name=tooltipbtn, bordercolor=, backgroundcolor=, borderwidth=0]{%
                    \begin{tcolorbox}[width=20pt, height=20pt, left=3pt, top=0pt]
                        \centering?\strut{}
                    \end{tcolorbox}%
                }
            \end{flushright}%
        \end{multicols}

        % Fill the page such that the remaining elements get pushed to the bottom
        \vspace*{\fill}

        % The particles for the particle system
        \xintFor* #1 in {\xintSeq{0}{\particleCount-1}} \do {%
            \TextField[name=particle#1, bordercolor=, backgroundcolor=, align=1, readonly]{}%
        }

        \TextField[name=tooltiptxt, bordercolor=, backgroundcolor=gray, readonly, hidden]{}

        %%%%%%%%%%%%%%%%%%%%%%%
        % Commandredifinition %
        % https://www.dickimaw-books.com/latex/admin/html/eforms.shtml
        %%%%%%%%%%%%%%%%%%%%%%%
        \renewcommand*{\DefaultWidthofChoiceMenu}{2.5ex}
        \renewcommand*{\DefaultHeightofChoiceMenu}{2.04ex}

        % Game related buttons
        \begin{center}%
            \begin{tabularx}{\textwidth}{@{} *{2}{X} @{}}%
                \PushButton[name=restart, bordercolor=, backgroundcolor=, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        Restart particle system\strut
                    \end{tcolorbox}
                } &
                \begin{tcolorbox}
                    \ChoiceMenu[name=particleType, width=50mm,
                        bordercolor=white, combo
                    ]{Particlesystem:\strut}{Snow, Explosions}
                \end{tcolorbox}
            \end{tabularx}
        \end{center}

    \end{Form}
\end{document}
