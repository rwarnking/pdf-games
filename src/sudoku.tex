\documentclass[12pt, a4paper, footexclude, headexclude]{scrartcl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[margin=0.5in]{geometry}

\usepackage[utf8x]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[ngerman]{babel}
\usepackage{xcolor}
\usepackage[pdftex]{hyperref}
\usepackage{multicol}

\usepackage{xinttools}
\usepackage[nomessages]{fp}
\usepackage{tabularx}
\usepackage{tcolorbox}

\setlength{\parindent}{0pt}

% Einbindung von Javascript ins PDF
\usepackage[pdftex]{insdljs}
%\renewcommand{\MakeTextField}[2]{{\vbox to #2{\vfill\hbox to #1{\hrulefill}}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Parameter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\fieldWidth{9}
\def\fieldHeight{9}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Javascript
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Inhalt der Umgebung wird in JSDateiname.djs gespeichert und steht im PDF zur VerfÃ¼gung
\begin{insDLJS}[]{JSDateiname}{Sudoku}

const FIELD_WIDTH = AFMakeNumber(\fieldWidth);
const FIELD_HEIGHT = AFMakeNumber(\fieldHeight);
const SCREEN_TEXT_WIDTH = 300;
const NUMBERS = 9;

var complField = new Array();
var solution = new Array();
var original = new Array();

var customMode = false;

var colors = new Array(
    [ "RGB", 1.0, 1.0, 1.0 ], % white
    [ "RGB", 0.8, 0.8, 0.8 ], % gray
    [ "RGB", 0.203, 0.603, 0.054 ], % green
    [ "RGB", 0.660, 0.178, 0.233 ], % red
    [ "RGB", 0.078, 0.305, 0.560 ]
);

highlightcolor = [ "RGB", 0.984, 0.800, 0.176 ];

%%%%%%%%%%
% Helper %
%%%%%%%%%%
function getRandomInt(max) {
    return Math.floor(Math.random() * max);
}

/**
 * Shuffles array in place.
 * https://stackoverflow.com/questions/6274339/how-can-i-shuffle-an-array
 *
 * @param {Array} a items An array containing the items.
 */
function shuffle(a) {
    var j, x, i;
    for (i = a.length - 1; i > 0; i--) {
        j = Math.floor(Math.random() * (i + 1));
        x = a[i];
        a[i] = a[j];
        a[j] = x;
    }
    return a;
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Initialisation and Restart %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function initialise() {
    for (var row = 0; row < FIELD_HEIGHT; row++) {
        var zArr1 = new Array();
        var zArr2 = new Array();
        var zArr3 = new Array();
        for (var column = 0; column < FIELD_WIDTH; column++) {
            zArr1.push(0);
            zArr2.push(0);
            zArr3.push(0);
        }
        complField.push(zArr1);
        solution.push(zArr2);
        original.push(zArr3);
    }

    initialiseButtons();

    generateSudoku();
}

function initialiseButtons() {
    this.getField("generate").setAction("MouseUp", "generateSudoku();");
    this.getField("generate").highlight="none";
    this.getField("hint").setAction("MouseUp", "showHint();");
    this.getField("hint").highlight="none";
    this.getField("solve").setAction("MouseUp", "showSolution();");
    this.getField("solve").highlight="none";
    this.getField("enter").setAction("MouseUp", "enterSudoku();");
    this.getField("enter").highlight="none";
    this.getField("reset").setAction("MouseUp", "resetSudoku();");
    this.getField("reset").highlight="none";

    this.getField("elemcount").borderColor = color.white;
    this.getField("elemcount").currentValueIndices = 2;
    this.getField("elemcount").commitOnSelChange = true;

    var funcName = "checkInput";
    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            var callbackName = funcName + "(" + x.toString() + "," + y.toString() + ");";
            this.getField("pos" + x + y).setAction("OnBlur", callbackName);
            this.getField("pos" + x + y).textSize = SCREEN_TEXT_WIDTH / FIELD_WIDTH;
            this.getField("pos" + x + y).alignment = "center";
        }
    }

    this.getField("info").fillColor = color.transparent;
    this.getField("info").borderColor = color.transparent;

    this.getField("tooltipbtn").setAction("MouseDown", "tooltip(true);");
    this.getField("tooltipbtn").setAction("MouseUp", "tooltip(false);");
    this.getField("tooltipbtn").highlight="none";

    printInfoText();
}

function tooltip(on) {
    if (on) {
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.alignment = "center";
        field.value = "This is a game.";

        field.fillColor = color.gray;
        % hight 842, width 596
        % upper-left x, upper-left y, lower-right x and lower-right y
        field.rect = [128, 601, 468, 401];

        field.delay = false;
    } else {
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.value = "";

        field.fillColor = color.gray;
        field.rect = [0, 0, 0, 0];

        field.delay = false;
    }
}

function enterSudoku() {
    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            complField[y][x] = 0;
            solution[y][x] = 0;
            original[y][x] = 0;
        }
    }

    customMode = true;

    drawAll(false);
}

%%%%%%%%%%%%%%%%%%%%%%%%%%
% Generation and solving %
%%%%%%%%%%%%%%%%%%%%%%%%%%
function generateSudoku() {
    customMode = false;

    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            complField[y][x] = 0;
        }
    }

    % https://www.geeksforgeeks.org/program-sudoku-generator/

    % Fill all the diagonal 3x3 matrices randomly.
    var numberArray = [];
    for (var i = 1; i <= NUMBERS; i++) {
        numberArray.push(i);
    }

    % % Fill top left
    fillQuad(numberArray, 0, 0);
    % Fill middle
    fillQuad(numberArray, 3, 3);
    % Fill bot right
    fillQuad(numberArray, 6, 6);

    % Fill rest of the non-diagonal matrices.
    % For every cell to be filled, try all numbers until
    % a safe number is found.
    solveSudoku();

    % Remove K elements randomly
    var positions = [];
    for (var x = 0; x < NUMBERS; x++) {
        for (var y = 0; y < NUMBERS; y++) {
            positions.push([x, y]);
        }
    }
    var num_elements = this.getField("elemcount").value;
    var rnd = 0;
    for (var count = NUMBERS * NUMBERS; count > num_elements; count--) {
        rnd = getRandomInt(positions.length);
        var elem = positions[rnd];
        complField[elem[1]][elem[0]] = 0;
        positions.splice(rnd, 1);
    }

    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            original[y][x] = complField[y][x];
        }
    }

    drawAll(true);
}

function fillQuad(numberArray, offsetX, offsetY) {
    shuffle(numberArray);

    var x = 0;
    var y = 0;
    for (var idx = 0; idx < numberArray.length; idx++) {
        x = offsetX + idx;
        if (idx > 5) {
            x -= 6;
        } else if (idx > 2) {
            x -= 3;
        }
        y = offsetY + Math.floor(idx / 3);
        complField[y][x] = numberArray[idx];
    }
}

function solveSudoku() {
    % Make list of all empty spaces
    var spaces = getEmptySpaces();

    % For each element in list find all candidates
    var candidates = getCandidates(spaces);

    % TODO this should not happen
    for (var idx = 0; idx < spaces.length; idx++) {
        if (candidates[idx].length == 0) {
            printInfoText(true);
        }
    }

    % Setup and init candidate indices
    var indices = [];
    for (var i = 0; i < spaces.length; i++) {
        indices.push(0);
    }

    % Apply candidates
    var apple = 0; % TODO remove
    for (var idx = 0; idx < spaces.length && apple < 500000; idx++) {
        apple++;
        complField[spaces[idx][1]][spaces[idx][0]] = candidates[idx][indices[idx]];
        if (!isFieldValid(spaces[idx][0], spaces[idx][1])) {

            var tmpIdx = idx;

            for (; indices[tmpIdx] + 1 >= candidates[tmpIdx].length; tmpIdx--) {
                indices[tmpIdx] = 0;

                % TODO this should not happen
                if (tmpIdx - 1 < 0) {
                    printInfoText(true);
                    break;
                }
            }
            indices[tmpIdx]++;
            idx = -1;

            % Reverse if not valid solution
            for (var idx2 = 0; idx2 < spaces.length; idx2++) {
                complField[spaces[idx2][1]][spaces[idx2][0]] = 0;
            }
        }
    }

    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            solution[y][x] = complField[y][x];
        }
    }
}

function getEmptySpaces() {
    var spaces = [];
    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            if (complField[y][x] == 0) {
                spaces.push([x, y]);
            }
        }
    }
    return spaces;
}

function getCandidates(spaces) {
    var tmp = [];
    for (var i = 0; i < 9; i++) {
        tmp.push(true);
    }

    var candidates = [];
    var num = 0;
    for (var idx = 0; idx < spaces.length; idx++) {
        % Check the row for all number that are set
        for (var x = 0; x < FIELD_WIDTH; x++) {
            num = complField[spaces[idx][1]][x];
            if (num > 0) {
                tmp[num - 1] = false;
            }
        }

        % Check the column for all number that are set
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            num = complField[y][spaces[idx][0]];
            if (num > 0) {
                tmp[num - 1] = false;
            }
        }

        % Check the box for all numbers that are set
        const WIDTH = 3;
        var xQuad = Math.floor(spaces[idx][0] / WIDTH);
        var yQuad = Math.floor(spaces[idx][1] / WIDTH);
        for (var x = xQuad * WIDTH; x < xQuad * WIDTH + WIDTH; x++) {
            for (var y = yQuad * WIDTH; y < yQuad * WIDTH + WIDTH; y++) {
                num = complField[y][x];
                if (num > 0) {
                    tmp[num - 1] = false;
                }
            }
        }

        % Get candidates
        var tmp2 = [];
        for (var i = 0; i < tmp.length; i++) {
            if (tmp[i]) {
                tmp2.push(i + 1);
            }
        }
        candidates.push(tmp2);

        % Reset set numbers
        for (var i = 0; i < 9; i++) {
            tmp[i] = true;
        }
    }
    return candidates;
}

function isFieldValid(valX, valY) {
    var value = complField[valY][valX];

    % Check the row
    for (var x = 0; x < FIELD_WIDTH; x++) {
        if (complField[valY][x] == value && x != valX) {
            return false;
        }
    }

    % Check the column
    for (var y = 0; y < FIELD_HEIGHT; y++) {
        if (complField[y][valX] == value && y != valY) {
            return false;
        }
    }

    % Check the box
    const WIDTH = 3;
    var xQuad = Math.floor(valX / WIDTH);
    var yQuad = Math.floor(valY / WIDTH);
    for (var x = xQuad * WIDTH; x < xQuad * WIDTH + WIDTH; x++) {
        for (var y = yQuad * WIDTH; y < yQuad * WIDTH + WIDTH; y++) {
            if (complField[y][x] == value && (y != valY || x != valX)) {
                return false;
            }
        }
    }

    return true;
}

function checkInput(x, y) {
    var field = this.getField("pos" + x + y);

    % If the value did not change dont do anything
    if (complField[y][x] == field.value) {
        return;
    }
    field.delay = true;

    if (field.value > 0 && field.value < 10) {
        complField[y][x] = field.value;
        if (isFieldValid(x, y)) {
            field.fillColor = colors[2];
        } else {
            field.fillColor = colors[3];
        }
    } else {
        field.value = "";
        field.fillColor = colors[0];
    }

    field.delay = false;
}

%%%%%%%%%%%%%%%%%%%%%
% Draw and coloring %
%%%%%%%%%%%%%%%%%%%%%
function resetSudoku() {
    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            complField[y][x] = original[y][x];
            refreshField(x, y, colors[1]);
        }
    }
}

function showHint() {
    % If one field in the solution array is zero the whole array should be
    % zero and therefore the solution was not yet generated
    if (solution[0][0] == 0) {
        solveSudoku();
    }

    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            if (complField[y][x] == 0) {
                complField[y][x] = solution[y][x];
                refreshField(x, y, colors[1]);
                return;
            }
        }
    }
}

function showSolution() {
    % When in custom mode it is not possible to know when
    % the user is done therefore the solution can only be
    % generated after requesting it
    if (customMode) {
        solveSudoku();
    }

    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            if (complField[y][x] == 0 || customMode) {
                complField[y][x] = solution[y][x];
                refreshField(x, y, colors[0]);
            }
        }
    }
}

/**
 * Refreshes value of one input field
 *
 * @param {int} x The x position.
 * @param {int} y The y position.
 * @param {RGB} color The rgb color.
 *              Gray for given fields, green for correct fields,
 *              Red for wrong fields, white for empty fields.
 */
function refreshField(x, y, color) {
    var field = this.getField("pos" + x + y);
    field.delay = true;
    if (complField[y][x] > 0) {
        field.value = complField[y][x];
        field.fillColor = color;
    } else {
        field.value = "";
        field.fillColor = colors[0];
    }
    field.delay = false;
}

function drawAll(color) {
    for (var x = 0; x < FIELD_WIDTH; x++) {
        for (var y = 0; y < FIELD_HEIGHT; y++) {
            field = this.getField("pos" + x + y);
            field.delay = true;
            if (complField[y][x] > 0) {
                field.value = complField[y][x];
                if (color) {
                    field.fillColor = colors[1];
                    field.readonly = true;
                }
            } else {
                field.value = "";
                field.fillColor = colors[0];
                field.readonly = false;
            }
            field.delay = false;
        }
    }
}

function printInfoText(error) {
    var field = this.getField("info");
    field.delay = true;
    if (error) {
        field.value = "ERROR";
    }
    field.delay = false;
}

\end{insDLJS}

\OpenAction{/S /JavaScript /JS (initialise();)}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Dokument
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

    \begin{multicols}{2}
        \section*{Sudoku}
    \columnbreak
        \begin{flushright}%
        \PushButton[name=tooltipbtn, bordercolor=white]{%
            \begin{tcolorbox}[width=20pt, height=20pt, left=3pt, top=0pt]
                \centering
                ?\strut
            \end{tcolorbox}%
        }
        \end{flushright}%
    \end{multicols}

    % Calculate the max width and height of a block
    \FPeval{\resultW}{(\fieldWidth * 4 + 3)}
    \def\blocksizeW{\dimexpr (\linewidth-\resultW pt)/\fieldWidth \relax}

    \FPeval{\resultH}{(\fieldHeight * 4 + 3)}
    \def\blocksizeH{\dimexpr (500 pt -\resultH pt)/\fieldHeight \relax}

    % Define the blocksize via the smaller amount
    \ifnum\blocksizeW<\blocksizeH
        \def\blocksize{\blocksizeW}
    \else
        \def\blocksize{\blocksizeH}
    \fi

    \begin{Form}

        \begin{tcolorbox}
            \begin{flushright}
                \xintFor* #2 in {\xintSeq{0}{\fieldHeight-1}} \do {%
                    \xintFor* #1 in {\xintSeq{0}{\fieldWidth-1}} \do {%
                        \TextField[%
                            width=\blocksize, height=\blocksize,%
                            bordercolor=white, name=pos#1#2]{}%
                        %
                        \ifnum#1=2%
                            \vspace{1pt}%
                            \vrule width 1pt%
                        \fi%
                        \ifnum#1=5%
                            \vspace{1pt}%
                            \vrule width 1pt%
                        \fi%
                    }\vspace{3pt}
                    \ifnum#2=2
                        \noindent\rule{\textwidth}{1pt}
                    \fi
                    \ifnum#2=5
                        \noindent\rule{\textwidth}{1pt}
                    \fi
                    \newline%
                }%
            \end{flushright}%
        \end{tcolorbox}
        %
        \ChoiceMenu[name=elemcount, width=50mm, combo]{Fullfield count:}{15, 30, 45, 60, 75}
        \TextField[bordercolor=white, name=tooltiptxt, readonly=true]{}
        %
        \begin{center}%
            \begin{tabularx}{\textwidth}{@{} X X @{}}%
                \PushButton[name=generate, bordercolor=white]{
                    \begin{tcolorbox}
                        \centering
                        Generate new Sudoku\strut
                    \end{tcolorbox}
                } &
                \PushButton[name=enter, bordercolor=white]{
                    \begin{tcolorbox}
                        \centering
                        Enter own Sudoku\strut
                    \end{tcolorbox}
                } \\
                \PushButton[name=solve, bordercolor=white]{
                    \begin{tcolorbox}
                        \centering
                        Show current solution\strut
                    \end{tcolorbox}
                } &
                \PushButton[name=hint, bordercolor=white]{
                    \begin{tcolorbox}
                        \centering
                        Give me a hint\strut
                    \end{tcolorbox}
                } \\
                \PushButton[name=reset, bordercolor=white]{
                    \begin{tcolorbox}
                        \centering
                        Reset current input\strut
                    \end{tcolorbox}
                } &
                \begin{tcolorbox}
                    \TextField[name=info, width=\linewidth, readonly=true]{}
                \end{tcolorbox}
            \end{tabularx}
        \end{center}

    \end{Form}
\end{document}
