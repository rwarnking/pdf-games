\documentclass[12pt, a4paper, footexclude, headexclude]{scrartcl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[margin=0.5in]{geometry}

\usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[ngerman]{babel}
\usepackage{xcolor}
\usepackage[pdftex]{hyperref}

\usepackage{xinttools}
\usepackage{tabularx}
\usepackage{tcolorbox}

\setlength{\parindent}{0pt}

% Einbindung von Javascript ins PDF
\usepackage[pdftex]{insdljs}
%\renewcommand{\MakeTextField}[2]{{\vbox to #2{\vfill\hbox to #1{\hrulefill}}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Parameter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\fieldWidth{9}
\def\fieldHeight{16}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Javascript
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Inhalt der Umgebung wird in JSDateiname.djs gespeichert und steht im PDF zur Verf√ºgung
\begin{insDLJS}[]{JSDateiname}{irgendeinTitel}

var fieldWidth = AFMakeNumber(\fieldWidth);
var fieldHeight = AFMakeNumber(\fieldHeight);

var stone = new Array();
var shouldEmitStone = true;

var complField = new Array();

var focus = 0;

%%%%%%%%%%%%%%%%%%
% Initialisation %
%%%%%%%%%%%%%%%%%%
function initialise() {
    for (column = 0; column < fieldHeight; column++) {
        var tmp = new Array();
        for (row = 0; row < fieldWidth; row++) {
            tmp.push(0);
        }
        complField.push(tmp);
    }

    initialiseButtons();

    var run = app.setInterval("runAll()", 150);
    run.count = 0;
    var timeout = app.setTimeOut( "app.clearInterval(run);", 3*36*150);
}

function initialiseButtons() {
    this.getField("input1").setFocus();

    this.getField("left").setAction("MouseUp", "move('a');");
    this.getField("left").highlight="invert";

    this.getField("right").setAction("MouseUp", "move('d');");
    this.getField("right").highlight="invert";
    this.getField("down").setAction("MouseUp", "move('s');");
    this.getField("down").highlight="invert";
    this.getField("fulldown").setAction("MouseUp", "move(' ');");
    this.getField("fulldown").highlight="invert";

    this.getField("turnRight").setAction("MouseUp", "move('q');");
    this.getField("turnRight").highlight="invert";
    this.getField("turnLeft").setAction("MouseUp", "move('e');");
    this.getField("turnLeft").highlight="invert";

    %var aRect = this.getField("left").rect;
    %aRect[0] -= 30;
    %aRect[2] += 30;
    %this.getField("left").rect = aRect;
}

%%%%%%%%
% Loop %
%%%%%%%%
function runAll() {
    processInput();
    updateField();
    if (!shouldEmitStone) {
        draw();
        removeStone();
    }
}

%%%%%%%%%%%%
% Movement %
%%%%%%%%%%%%
function processInput() {
    this.getField("input1").delay = true;
    this.getField("output1").delay = true;

    var movementString;
    var SPEED = 2;
    var div = Math.floor(focus / SPEED);
    if (focus - div * SPEED == 0) {
        this.getField("input1").setFocus();
        this.getField("output1").value += this.getField("input2").value;
        movementString = this.getField("input2").value;
        this.getField("input2").value = "";
    }
    else if (focus - div * SPEED == SPEED / 2) {
        this.getField("input2").setFocus();
        this.getField("output1").value += this.getField("input1").value;
        movementString = this.getField("input1").value;
        this.getField("input1").value = "";
    }
    focus++;

    for (var i = 0; i < movementString.length; i++) {
        move(movementString.charAt(i));
    }

    this.getField("input1").delay = false;
    this.getField("output1").delay = false;
}

function move(dir) {
    switch(dir) {
        case "s":
            app.beep(0);
            for (pice = 0; pice < stone.length; pice++) {
                stone[pice][1]++;
            }
            break;
        case " ":
            app.beep(2);
            for (pice = 0; pice < stone.length; pice++) {
                stone[pice][1]+=3;
            }
            break;
        case "a":
            app.beep(0);
            for (pice = 0; pice < stone.length; pice++) {
                stone[pice][0]--;
            }
            break;
        case "d":
            app.beep(0);
            for (pice = 0; pice < stone.length; pice++) {
                stone[pice][0]++;
            }
            break;
        case "q":
            app.beep(1);
            break;
        case "e":
            app.beep(1);
            break;
    }
}

%%%%%%%%%
% Logic %
%%%%%%%%%
var stones = new Array(
    new Array(
        new Array(1, 0),
        new Array(2, 0),
        new Array(3, 0),
        new Array(4, 0)
    ),
    new Array(
        new Array(1, 0),
        new Array(1, 1),
        new Array(2, 0),
        new Array(2, 1)
    ),
    new Array(
        new Array(1, 0),
        new Array(2, 0),
        new Array(2, 1),
        new Array(3, 0)
    ),
    new Array(
        new Array(1, 0),
        new Array(2, 0),
        new Array(2, 1),
        new Array(3, 1)
    ),
    new Array(
        new Array(1, 0),
        new Array(2, 0),
        new Array(3, 0),
        new Array(3, 1)
    ),
    new Array(
        new Array(1, 1),
        new Array(1, 0),
        new Array(2, 0),
        new Array(3, 0)
    ),
    new Array(
        new Array(1, 1),
        new Array(2, 1),
        new Array(2, 0),
        new Array(3, 0)
    )
);

function emitStone() {
    for (var pice = 0; pice < stone.length; pice++) {
        var x = stone[pice][0];
        var y = stone[pice][1];
        complField[y][x] = 1;
    }

    var stoneIdx = Math.floor(Math.random() * stones.length);
    for (var i = 0; i < stones[stoneIdx].length; i++)
        stone[i] = stones[stoneIdx][i].slice();

    for (var pice = 0; pice < stone.length; pice++) {
        var x = stone[pice][0];
        var y = stone[pice][1];
        complField[y][x] = 1;
    }
    shouldEmitStone = false;
}

function collidesOrHeight() {
    for (var pice = 0; pice < stone.length; pice++) {
        var x = stone[pice][0];
        var y = stone[pice][1];
        if (y + 1 >= fieldHeight || complField[y + 1][x] != 0) {
            return true;
        }
    }
    return false;
}

function updateField() {
    if (shouldEmitStone) {
        emitStone();
    }
    else {
        if (!collidesOrHeight()) {
            for (var pice = 0; pice < stone.length; pice++) {
                var x = stone[pice][0];
                var y = stone[pice][1];
                complField[y][x] = 0;
                stone[pice][1]++;
            }
            for (var pice = 0; pice < stone.length; pice++) {
                var x = stone[pice][0];
                var y = stone[pice][1];
                complField[y][x] = 1;
            }
        } else {
            shouldEmitStone = true;
        }
    }
}

function removeStone() {
    for (var pice = 0; pice < stone.length; pice++) {
        var x = stone[pice][0];
        var y = stone[pice][1];
        complField[y][x] = 0;
    }
}

function draw() {
    for (var x = 0; x < fieldWidth; x++) {
        for (var y = 0; y < fieldHeight; y++) {
            field = this.getField("pos" + x + y);
            field.delay = true;
            if (complField[y][x] == 1) {
                field.value = 1.0;
                field.borderColor = color.black;
                field.fillColor = color.black;
            }
            else {
                field.value = 0.0;
                field.borderColor = color.white;
                field.fillColor = color.white;
            }
            field.delay = false;
        }
    }
}

\end{insDLJS}

\OpenAction{/S /JavaScript /JS (initialise();)}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Dokument
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

    \begin{Form}

        \def\blocksize{0.05\linewidth}

        \begin{center}
            \xintFor* #2 in {\xintSeq{0}{\fieldHeight-1}} \do {%
                \xintFor* #1 in {\xintSeq{0}{\fieldWidth-1}} \do {%
                    \TextField[width=\blocksize, height=\blocksize, readonly=true, name=pos#1#2]{}
                }
                \newline
            }
        \end{center}

        \begin{center}%
            \begin{tabularx}{\textwidth}{@{} X X X @{}}%
                \multicolumn{3}{@{} l @{}}{%
                    \PushButton[name=start, bordercolor=black]{
                        \begin{tcolorbox}
                            \centering
                            \Large start/restart\strut
                        \end{tcolorbox}
                    }
                }\\
                \PushButton[name=turnLeft, bordercolor=black]{
                    \begin{tcolorbox}
                        \centering
                        \Large turnLeft\strut
                    \end{tcolorbox}
                } &
                \centering
                \TextField[name=output1, width=0.3\textwidth, height=1.5cm, bordercolor={0.650 .790 .94}]{} &
                \PushButton[name=turnRight, bordercolor=black]{
                    \begin{tcolorbox}
                        \centering
                        \Large turnRight\strut
                    \end{tcolorbox}
                } \\
                \PushButton[name=left, bordercolor=black]{
                    \begin{tcolorbox}
                        \centering
                        \Large left\strut
                    \end{tcolorbox}
                } &
                \PushButton[name=down, bordercolor=black]{
                    \begin{tcolorbox}
                        \centering
                        \Large down\strut
                    \end{tcolorbox}
                } &
                \PushButton[name=right, bordercolor=black]{
                    \begin{tcolorbox}
                        \centering
                        \Large right\strut
                    \end{tcolorbox}
                } \\
                \multicolumn{3}{@{} l @{}}{%
                    \PushButton[name=fulldown, bordercolor=black]{
                        \begin{tcolorbox}
                            \centering
                            \Large fulldown\strut
                        \end{tcolorbox}
                    }
                }
            \end{tabularx}
        \end{center}

        \TextField[name=input1, width=2in, bordercolor={0.650 .790 .94}]{}
        \TextField[name=input2, width=2in, bordercolor={0.650 .790 .94}]{}

    \end{Form}

\end{document}
