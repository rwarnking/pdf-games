\documentclass[12pt, a4paper, footexclude, headexclude]{scrartcl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[margin=0.5in]{geometry}

\usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[ngerman]{babel}
\usepackage{xcolor}
\usepackage[pdftex]{hyperref}

\usepackage{xinttools}
\usepackage[nomessages]{fp}
\usepackage{tabularx}
\usepackage{tcolorbox}

\setlength{\parindent}{0pt}

% Einbindung von Javascript ins PDF
\usepackage[pdftex]{insdljs}
%\renewcommand{\MakeTextField}[2]{{\vbox to #2{\vfill\hbox to #1{\hrulefill}}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Parameter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TODO needs to be atleast 4
\def\fieldWidth{9}
\def\fieldHeight{20}
% Higher means slower
\def\GAMESPEED{5}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Javascript
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Inhalt der Umgebung wird in JSDateiname.djs gespeichert und steht im PDF zur Verf√ºgung
\begin{insDLJS}[]{JSDateiname}{irgendeinTitel}

var fieldWidth = AFMakeNumber(\fieldWidth);
var halfFieldWidth = Math.floor(fieldWidth / 2.0);
var fieldHeight = AFMakeNumber(\fieldHeight);

var complField = new Array();

var focus = true;
var loopTimer = 0;
var speed = AFMakeNumber(\GAMESPEED);
var lineCount = 0;

var stone = new Array();
var stoneColor = color.black;
var shouldEmitStone = true;
var stones = new Array(
    % Bar
    new Array(
        new Array(halfFieldWidth - 2, 0),
        new Array(halfFieldWidth - 1, 0),
        new Array(halfFieldWidth, 0),
        new Array(halfFieldWidth + 1, 0)
    ),
    % Cube
    new Array(
        new Array(halfFieldWidth - 1, 0),
        new Array(halfFieldWidth - 1, 1),
        new Array(halfFieldWidth, 0),
        new Array(halfFieldWidth, 1)
    ),
    % T
    new Array(
        new Array(halfFieldWidth - 1, 0),
        new Array(halfFieldWidth, 0),
        new Array(halfFieldWidth, 1),
        new Array(halfFieldWidth + 1, 0)
    ),
    % Z
    new Array(
        new Array(halfFieldWidth - 1, 0),
        new Array(halfFieldWidth, 0),
        new Array(halfFieldWidth, 1),
        new Array(halfFieldWidth + 1, 1)
    ),
    % L
    new Array(
        new Array(halfFieldWidth - 1, 0),
        new Array(halfFieldWidth, 0),
        new Array(halfFieldWidth + 1, 0),
        new Array(halfFieldWidth + 1, 1)
    ),
    % J
    new Array(
        new Array(halfFieldWidth - 1, 1),
        new Array(halfFieldWidth - 1, 0),
        new Array(halfFieldWidth, 0),
        new Array(halfFieldWidth + 1, 0)
    ),
    % S
    new Array(
        new Array(halfFieldWidth - 1, 1),
        new Array(halfFieldWidth, 1),
        new Array(halfFieldWidth, 0),
        new Array(halfFieldWidth + 1, 0)
    )
);

var colors = new Array(
    color.black,
    [ "RGB", 0.843, 0.078, 0.058 ],
    [ "RGB", 0.203, 0.603, 0.054 ],
    [ "RGB", 0.078, 0.305, 0.560 ],
    [ "RGB", 0.560, 0.078, 0.533 ]
);

% For saving the interval
var run;

%%%%%%%%%%%%%%%%%%
% Initialisation %
%%%%%%%%%%%%%%%%%%
function initialise() {
    for (var row = 0; row < fieldHeight; row++) {
        var tmp = new Array();
        for (var column = 0; column < fieldWidth; column++) {
            tmp.push(0);
        }
        complField.push(tmp);
    }

    initialiseButtons();

    run = app.setInterval("runAll()", 20);
    %run.count = 0;
    %var timeout = app.setTimeOut( "app.clearInterval(run);", 3*36*150);
}

function initialiseButtons() {
    this.getField("input1").setFocus();

    this.getField("left").setAction("MouseUp", "move('a');");
    this.getField("left").highlight="invert";

    this.getField("right").setAction("MouseUp", "move('d');");
    this.getField("right").highlight="invert";
    this.getField("down").setAction("MouseUp", "move('s');");
    this.getField("down").highlight="invert";
    this.getField("fulldown").setAction("MouseUp", "move(' ');");
    this.getField("fulldown").highlight="invert";

    this.getField("turnLeft").setAction("MouseUp", "move('q');");
    this.getField("turnLeft").highlight="invert";
    this.getField("turnRight").setAction("MouseUp", "move('e');");
    this.getField("turnRight").highlight="invert";

    %var aRect = this.getField("left").rect;
    %aRect[0] -= 30;
    %aRect[2] += 30;
    %this.getField("left").rect = aRect;
}

%%%%%%%%
% Loop %
%%%%%%%%
function runAll() {
    loopTimer++;
    processInput();
    updateField();
    if (!shouldEmitStone) {
        draw();
        removeStone();
    } else if (gameover()) {
        restart();
    }
}

%%%%%%%%%
% Logic %
%%%%%%%%%
function gameover() {
    for (var column = 0; column < fieldWidth; column++) {
        if (complField[0][column] != 0) {
            return true;
        }
    }
    return false
}

function restart() {
    this.getField("points").value = 0;
    for (var row = 0; row < fieldHeight; row++) {
        for (var column = 0; column < fieldWidth; column++) {
            complField[row][column] = 0;
        }
    }
}

function emitStone() {
    stoneColor = Math.floor(Math.random() * colors.length) + 1;

    var stoneIdx = Math.floor(Math.random() * stones.length);
    for (var i = 0; i < stones[stoneIdx].length; i++)
        stone[i] = stones[stoneIdx][i].slice();

    for (var pice = 0; pice < stone.length; pice++) {
        var x = stone[pice][0];
        var y = stone[pice][1];
        complField[y][x] = stoneColor;
    }
    shouldEmitStone = false;
}

function collidesOrHeight() {
    for (var pice = 0; pice < stone.length; pice++) {
        var x = stone[pice][0];
        var y = stone[pice][1];
        if (y + 1 >= fieldHeight || complField[y + 1][x] != 0) {
            return true;
        }
    }
    return false;
}

function collidesOrLeft() {
    for (var pice = 0; pice < stone.length; pice++) {
        var x = stone[pice][0];
        var y = stone[pice][1];
        if (x - 1 < 0 || complField[y][x - 1] != 0) {
            return true;
        }
    }
    return false;
}

function collidesOrRight() {
    for (var pice = 0; pice < stone.length; pice++) {
        var x = stone[pice][0];
        var y = stone[pice][1];
        if (x + 1 >= fieldWidth || complField[y][x + 1] != 0) {
            return true;
        }
    }
    return false;
}

function removeLines() {
    for (var y = fieldHeight - 1; y >= 0; y--) {
        for (var x = 0; x < fieldWidth; x++) {
            if (complField[y][x] == 0) {
                x = fieldWidth;
            } else if (x == fieldWidth - 1 && complField[y][x] > 0) {

                this.getField("points").value += 1000;
                lineCount++;
                if (lineCount == 5 && speed > 1) {
                    lineCount = 0;
                    speed--;
                }
                % Remove the line by shifting all the lines above one down
                for (var move_y = y; move_y > 0; move_y--) {
                    complField[move_y] = complField[move_y - 1];
                }
                % Override the top line with a new one
                var tmp = new Array();
                for (var column = 0; column < fieldWidth; column++) {
                    tmp.push(0);
                }
                complField[0] = tmp;
                % Adjust y such that the shifted line is also tested
                y++;

            }
        }
    }
}

function updateField() {
    if (shouldEmitStone) {
        emitStone();
    }
    else {
        if (!collidesOrHeight()) {
            if (loopTimer >= speed) {
                this.getField("points").value++;
                loopTimer = 0;
                for (var pice = 0; pice < stone.length; pice++) {
                    stone[pice][1]++;
                    var x = stone[pice][0];
                    var y = stone[pice][1];
                    complField[y][x] = stoneColor;
                }
            } else {
                for (var pice = 0; pice < stone.length; pice++) {
                    var x = stone[pice][0];
                    var y = stone[pice][1];
                    complField[y][x] = stoneColor;
                }
            }
        } else {
            % Add the stone to the field array
            for (var pice = 0; pice < stone.length; pice++) {
                var x = stone[pice][0];
                var y = stone[pice][1];
                complField[y][x] = stoneColor;
            }
            removeLines();
            shouldEmitStone = true;
        }
    }
}

function removeStone() {
    for (var pice = 0; pice < stone.length; pice++) {
        var x = stone[pice][0];
        var y = stone[pice][1];
        complField[y][x] = 0;
    }
}

function draw() {
    for (var x = 0; x < fieldWidth; x++) {
        for (var y = 0; y < fieldHeight; y++) {
            field = this.getField("pos" + x + y);
            field.delay = true;
            if (complField[y][x] > 0) {
                field.fillColor = colors[complField[y][x] - 1];
            }
            else {
                field.fillColor = color.white;
            }
            field.delay = false;
        }
    }
}

%%%%%%%%%%%%
% Movement %
%%%%%%%%%%%%
function processInput() {
    var iField1 = this.getField("input1");
    var iField2 = this.getField("input2");
    var oField = this.getField("output1");

    iField1.delay = true;
    iField2.delay = true;
    oField.delay = true;

    var movementString;
    if (focus) {
        iField1.setFocus();
        movementString = iField2.value;
        if (oField.value.length >= 10)
            oField.value = oField.value.slice(movementString.length);
        oField.value += movementString;
        iField2.value = "";
    }
    else {
        iField2.setFocus();
        movementString = iField1.value
        if (oField.value.length >= 10)
            oField.value = oField.value.slice(movementString.length);
        oField.value += movementString;
        iField1.value = "";
    }
    focus = !focus;

    for (var i = 0; i < movementString.length; i++) {
        move(movementString.charAt(i));
    }

    iField1.delay = false;
    iField2.delay = false;
    oField.delay = false;
}

function move(dir) {
    switch(dir) {
        case "s":
            if (!collidesOrHeight()) {
                for (pice = 0; pice < stone.length; pice++) {
                    stone[pice][1]++;
                }
            }
            break;
        case " ":
            while (!collidesOrHeight()) {
                for (pice = 0; pice < stone.length; pice++) {
                    stone[pice][1]++;
                }
            }
            break;
        case "a":
            if (!collidesOrLeft()) {
                for (pice = 0; pice < stone.length; pice++) {
                    stone[pice][0]--;
                }
            }
            break;
        case "d":
            if (!collidesOrRight()) {
                for (pice = 0; pice < stone.length; pice++) {
                    stone[pice][0]++;
                }
            }
            break;
        case "q":
            var newPositions = new Array();
            for (var pice = 0; pice < stone.length; pice++) {
                var res = rotate(stone[0][0], stone[0][1], stone[pice][0], stone[pice][1], 90.0);
                if (collidesOrOOB(res[0], res[1]))
                    return;
                newPositions.push(res);
            }
            for (var pice = 0; pice < stone.length; pice++) {
                stone[pice][0] = newPositions[pice][0];
                stone[pice][1] = newPositions[pice][1];
            }
            break;
        case "e":
            var newPositions = new Array();
            for (var pice = 0; pice < stone.length; pice++) {
                var res = rotate(stone[0][0], stone[0][1], stone[pice][0], stone[pice][1], -90.0);
                if (collidesOrOOB(res[0], res[1]))
                    return;
                newPositions.push(res);
            }
            for (var pice = 0; pice < stone.length; pice++) {
                stone[pice][0] = newPositions[pice][0];
                stone[pice][1] = newPositions[pice][1];
            }
            break;
    }
}

function collidesOrOOB(x, y) {
    if (complField[y][x] > 0) {
         return true;
    }
    if (x < 0 || x >= fieldWidth || y < 0 || y >= fieldHeight) {
        return true;
    }
    return false;
}

% https://stackoverflow.com/questions/17410809/how-to-calculate-rotation-in-2d-in-javascript
function rotate(cx, cy, x, y, angle) {
    var radians = (Math.PI / 180) * angle;
    var cos = Math.cos(radians);
    var sin = Math.sin(radians);
    var nx = (cos * (x - cx)) + (sin * (y - cy)) + cx;
    var ny = (cos * (y - cy)) - (sin * (x - cx)) + cy;
    return [Math.round(nx), Math.round(ny)];
}

\end{insDLJS}

\OpenAction{/S /JavaScript /JS (initialise();)}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Dokument
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

    \begin{Form}

        \FPeval{\result}{(\fieldWidth * 3 + 3)}
        \def\blocksizeW{\dimexpr (\linewidth-\result pt)/\fieldWidth \relax}
        \FPeval{\result}{(\fieldHeight * 3 + 3)}
        \def\blocksizeH{\dimexpr (0.5\paperheight-\result pt)/\fieldHeight \relax}

        \begin{tcolorbox}
            %\centering
            \begin{flushright}
            \xintFor* #2 in {\xintSeq{0}{\fieldHeight-1}} \do {%
                \xintFor* #1 in {\xintSeq{0}{\fieldWidth-1}} \do {%
                    \TextField[width=\blocksizeW, height=\blocksizeH, bordercolor=white, readonly=true, name=pos#1#2]{}%
                }\vspace{3pt}
                \newline
            }
            \end{flushright}
        \end{tcolorbox}

        \begin{center}%
            \begin{tabularx}{\textwidth}{@{} X X X @{}}%
                \PushButton[name=start, bordercolor=white]{
                    \begin{tcolorbox}
                        \centering
                        \Large start/restart\strut
                    \end{tcolorbox}
                } &
                \centering
                \TextField[name=points, width=0.1\textwidth, value=0, bordercolor=white, readonly=true]{Points:} &
                \PushButton[name=pause, bordercolor=white]{
                    \begin{tcolorbox}
                        \centering
                        \Large pause\strut
                    \end{tcolorbox}
                } \\
                \PushButton[name=turnLeft, bordercolor=white]{
                    \begin{tcolorbox}
                        \centering
                        \Large turnLeft\strut
                    \end{tcolorbox}
                } &
                    \centering
                    % bordercolor={0.650 .790 .94}
                    \TextField[name=output1, width=0.3\textwidth, height=1.5cm, bordercolor=white, readonly=true]{}
                    %\begin{tcolorbox}
                    %\end{tcolorbox}
                &
                \PushButton[name=turnRight, bordercolor=white]{
                    \begin{tcolorbox}
                        \centering
                        \Large turnRight\strut
                    \end{tcolorbox}
                } \\
                \PushButton[name=left, bordercolor=white]{
                    \begin{tcolorbox}
                        \centering
                        \Large left\strut
                    \end{tcolorbox}
                } &
                \PushButton[name=down, bordercolor=white]{
                    \begin{tcolorbox}
                        \centering
                        \Large down\strut
                    \end{tcolorbox}
                } &
                \PushButton[name=right, bordercolor=white]{
                    \begin{tcolorbox}
                        \centering
                        \Large right\strut
                    \end{tcolorbox}
                } \\
                \multicolumn{3}{@{} l @{}}{%
                    \PushButton[name=fulldown, bordercolor=white]{
                        \begin{tcolorbox}
                            \centering
                            \Large fulldown\strut
                        \end{tcolorbox}
                    }
                }
            \end{tabularx}
        \end{center}

        \TextField[name=input1, width=2in, bordercolor={0.650 .790 .94}]{}
        \TextField[name=input2, width=2in, bordercolor={0.650 .790 .94}]{}

    \end{Form}

\end{document}
