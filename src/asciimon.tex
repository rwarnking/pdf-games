\documentclass[12pt, a4paper, footexclude, headexclude]{scrartcl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[margin=0.5in]{geometry}

% \usepackage[utf8x]{inputenc}
% \usepackage[T1]{fontenc}
% \usepackage[ngerman]{babel}
% \usepackage{xcolor}
\usepackage[pdftex]{hyperref}
\usepackage{multicol}

\usepackage{xinttools}
\usepackage[nomessages]{fp}
\usepackage{tabularx}
\usepackage{tcolorbox}

\setlength{\parindent}{0pt}

\usepackage[pdftex]{insdljs}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Parameter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Obacht: It is discuraged to use a field with size bigger than 15x15 since the pdf might get
% to slow to play
\def\fieldWidth{15}
\def\fieldHeight{15}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Javascript
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{insDLJS}[]{JSDateiname}{asciimon}

const GAME_DESC = "This game is similar to old games one might have played on a gameboy.\
There are two creatures shown. The one at the bottom is the player, while the one at the\
top is the enemy. Each turn both creatures are supposed to attack each other until\
one of them has no health left. If the enemy is beaten a new creature is selected.\
If your own creature dies you lose, unless you previously caught another one.";

% Outside variables
const FIELD_WIDTH = AFMakeNumber(\fieldWidth);
const FIELD_HEIGHT = AFMakeNumber(\fieldHeight);
const SCREEN_TEXT_WIDTH = 400;
const ENEMY_RESPONSE_TIME = 4000;

% Constants
% Menu states
const MENU = 0;
const FIGHT = 1;
const CHANGE = 2;
const ITEMS = 3;
const RUN = 4;

% Globals
% The game field
var gamestate = MENU;
var gameover = false;
% Creature data
var curCreatureIdx = 0;
var curPlayerCreatures = [["Empty"], ["Empty"], ["Empty"], ["Empty"]];
var curPlayerItems = [0, 0, 0, 0];
var curEnemy = 0;

% Turn information
const PLAYER = true;
const ENEMY = false;
var turn = PLAYER;
var turnInterval;

% Creature data
% Attributes
const NAME = 0;
const HP_GAIN = 1;
const TYPE = 2;
const ATKS = 3; % attacks
const EXP_GAIN = 4;
const IMAGE = 5;
const MAX_HP = 6;
const CUR_HP = 7;
const LVL = 8;
const CUR_EXP = 9;

const START_EXP = 500;
const MIN_LVL = 5;

% Types
const T_WATER = 0;
const T_AIR = 1;
const T_STONE = 2;
const T_GRASS = 3;
const T_GHOST = 4;
const T_FLUFF = 5;
const T_FIRE = 6;

const TYPE_STRINGS = new Array(
    "Water", "Air", "Stone", "Grass", "Ghost", "Fluff", "Fire"
);

% https://ascii.co.uk/art
% http://www.asciiworld.com/index.html
const CREATURE_LIST = new Array(
    ["SHEEP", 0.9, T_FLUFF, [0, 1, 2, 3], 32,
        [% https://ascii.co.uk/art/sheep
            "    .-:'  `; `-._   ",
            "   (_,           )  ",
            " ,'o\"(            )>",
            "(__,-'            ) ",
            "   (             )  ",
            "    `-'._.--._.-'   ",
            "       |||  |||     "
        ]
    ],
    ["BIRD", 0.5, T_AIR, [0, 1, 2, 3], 15,
        [
            " .-.      ",
            "(. .)__,'.",
            "/ V      .",
            "\  \\   \/ ",
            " `._`._ \  ",
            "==<<==`'== "
        ]
    ],
    ["STONE", 2.3, T_STONE, [0, 1, 2, 3], 50,
        [ % https://ascii.co.uk/art/dice
            "          ________          ",
            "         /\\       \\         ",
            "        /  \\       \\        ",
            "       /    \\       \\       ",
            "      /      \\_______\\      ",
            "      \\      /       /      ",
            "    ___\\    /   ____/___    ",
            "   /\\   \\  /   /\\       \\   ",
            "  /  \\   \\/___/  \\       \\  ",
            " /    \\       \\   \\       \\ ",
            "/      \\_______\\   \\_______\\",
            "\\      /       /   /       /",
            " \\    /       /   /       / ",
            "  \\  /       /\\  /       /  ",
            "   \\/_______/  \\/_______/   "
        ]
    ],
    ["TREE", 1.5, T_GRASS, [0, 1, 2, 3], 39,
        [ % https://ascii.co.uk/art/tree
            "          &&& &&  & &&        ",
            "      && &\\/&\\|& ()|/ @, &&   ",
            "      &\\/(/&/&||/& /_/)_&/_&  ",
            "   &() &\\/&|()|/&\\/ '\%\" & ()  ",
            "  &_\\_&&_\\ |& |&&/&__\%_/_& && ",
            "&&   && & &| &| /& & \% ()& /&&",
            " ()&_---()&\\&\\|&&-&&--\%---()~ ",
            "     &&     \\|||              ",
            "             |||              ",
            "             |||              ",
            "             |||              ",
            "       , -=-~  .-^- _         "
        ]
    ],
    ["SKELETOR", 1.2, T_GHOST, [0, 1, 2, 3], 40,
        [ % https://ascii.co.uk/art/skull
            " .-~~-. ",
            "(_^..^_)",
            "  ||||  ",
            "  `--'  "
        ]
    ],
    ["DUCK", 0.7, T_WATER, [0, 1, 2, 3], 23,
        [
             "  __    ",
             "<(o )___",
             " \\ ._> /",
             "  `---' "
        ]
    ]
);

const DMG = 1;
const KP = 2;

const ATTACK_LIST = new Array(
    ["Jump", 1.0, 3],
    ["Cry", 0.1, 5],
    ["Speak", 0.2, 10],
    ["Look", 0.8, 22]
);

const ITEM_LIST = new Array(
    ["Empty", 0],
    ["Potion", 50],
    ["Capture", 30],
    ["Improve", 10],
    ["Weaken", 10],
    ["lalala", 0]
);

const EXP_TABLE = [];

% Color data
const COLORS = new Array(
    %[ "RGB", 0.843, 0.078, 0.058 ],
    %[ "RGB", 0.203, 0.603, 0.054 ],
    %[ "RGB", 0.078, 0.305, 0.560 ]
);

%%%%%%%%%%
% Helper %
%%%%%%%%%%
/**
 * Returns a random number between 0 and the param.
 * @param {Number} max The upperbound
 */
function getRandomInt(max) {
    return Math.floor(Math.random() * max);
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Initialisation and Restart %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
/**
 * Initialise the default game state.
 */
function initialise() {
    % Init the GUI
    initialiseButtons();

    updateButtontxt();

    % Init exp table
    for (var i = 1; i < 101; i++) {
        EXP_TABLE.push(START_EXP + 250 * i * (i + 1));
    }

    % Initialise the player and enemy creature
    curCreatureIdx = 0;
    curPlayerCreatures[curCreatureIdx] = getCreature(MIN_LVL);
    curEnemy = getEnemy();

    % Initialise the player items
    curPlayerItems[0] = 2;

    updateEnemyTxt();
    updatePlayerTxt();

    drawAll();
}

/**
 * Initialise all buttons from the GUI.
 * For example add callbacks and set the correct colors.
 */
function initialiseButtons() {
    % Disables the rectangle around a button after the click
    app.focusRect = false;

    % Assign each button the coresponding function
    this.getField("restart").setAction("MouseUp", "restart();");

    this.getField("button1").setAction("MouseUp", "processInput(1);");
    this.getField("button1txt").setAction("MouseUp", "processInput(1);");
    this.getField("button2").setAction("MouseUp", "processInput(2);");
    this.getField("button2txt").setAction("MouseUp", "processInput(2);");
    this.getField("button3").setAction("MouseUp", "processInput(3);");
    this.getField("button3txt").setAction("MouseUp", "processInput(3);");
    this.getField("button4").setAction("MouseUp", "processInput(4);");
    this.getField("button4txt").setAction("MouseUp", "processInput(4);");

    % Adjust text size and font
    var cell;
    for (var m = 0; m < FIELD_HEIGHT; m++) {
        cell = this.getField("player" + m);
        cell.textSize = SCREEN_TEXT_WIDTH / (FIELD_WIDTH * 2);
        cell.textFont = font.Cour;
        %cell.alignment = "center";

        cell = this.getField("enemy" + m);
        cell.textSize = SCREEN_TEXT_WIDTH / (FIELD_WIDTH * 2);
        cell.textFont = font.Cour;
        %cell.alignment = "center";
    }

    % Info field setup
    this.getField("info").fillColor = color.transparent;
    this.getField("info").borderColor = color.transparent;

    % Tooltip setup
    this.getField("tooltipbtn").setAction("MouseDown", "tooltip(true);");
    this.getField("tooltipbtn").setAction("MouseUp", "tooltip(false);");
    this.getField("tooltipbtn").highlight="none";

    printInfoText("Init");
}

/**
 * Restart the game and clear everything
 */
function restart() {
    gameover = false;
    turn = PLAYER;

    printInfoText("Restart");
}

/**
 * Enable or disable the tooltip
 *
 * @param {Boolean} on Enable or disable tooltip
 */
function tooltip(on) {
    if (on) {
        % Move the tooltip field to the center of the screen
        % and adjust the size so the text can be displayed
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.hidden = false;
        field.value = GAME_DESC;

        field.multiline = true;
        field.textSize = 16;
        field.fillColor = color.gray;
        % height 842, width 596
        % upper-left x, upper-left y, lower-right x and lower-right y
        field.rect = [128, 601, 468, 401];

        field.delay = false;
    } else {
        % Remove the field such that it is not visible
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.hidden = true;
        field.value = "";

        field.multiline = false;
        field.fillColor = color.gray;
        field.rect = [0, 0, 0, 0];

        field.delay = false;
    }
}

%%%%%%%%%%%%%
% Gamelogic %
%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%
% Player actions %
%%%%%%%%%%%%%%%%%%
/**
 * If a menu button is pressed check which action needs to be taken.
 * This depends on the current gamestate.
 * If the enemy did not make a move, the input is ignored.
 * @param {Number} button The index of which button was pressed
 */
function processInput(button) {
    %this.getField("info").setFocus();

    if (gameover) {
        return;
    }

    if (turn != PLAYER) {
        printInfoText("Wait your turn!");
        return;
    }

    % If the menu was active the possible actions need to be shown
    if (gamestate == MENU) {
        if (button == RUN) {
            run();
        } else {
            gamestate = button;
        }
    } else {
        % If an action was selected run it and reset the gamestate
        if (gamestate == FIGHT) {
            attack(button);
        } else if (gamestate == CHANGE) {
            change(button);
        } else if (gamestate == ITEMS) {
            items(button);
        }
        gamestate = MENU;
    }
    updateButtontxt();
}

/**
 * With this action the player indicates that he does not want to
 * fight the current enemy. Therefore he flees and gets a new enemy.
 */
function run() {
    curEnemy = getEnemy();
    drawAll();
    updateEnemyTxt();
    % TODO the player should lose something when running
    printInfoText("You ran from your enemy. Your new enemy is: " + curEnemy[NAME]);
}

/**
 * This action runs the selected attack on the enemy creature.
 * For this the enemy hp are reduced by the damage from the arrack.
 * If the enemy is beaten, the player creature gets xp and has the
 * chance of leveling up.
 * This actions switches the turn to the enemy.
 * @ param {Number} idx The index of the attack selected.
 */
function attack(idx) {
    % Access the attack
    var curCreature = curPlayerCreatures[curCreatureIdx];
    var attacks = curCreature[ATKS];
    var attack = ATTACK_LIST[attacks[idx - 1]];

    % Calculate dmg
    var dmg = inflictDMG(curCreature, curEnemy, attack);
    % If the enemy is beaten add xp and lvl up if needed
    if (curEnemy[CUR_HP] <= 0) {
        curEnemy[CUR_HP] = 0;

        var exp = addEXP(curEnemy, curCreature);
        var lvlup = checkLvlUp(curCreature);
        if (lvlup) {
            updatePlayerTxt();
            printInfoText("You have slayn " + curEnemy[NAME] + " and " + curCreature[NAME] + " leveled up." + exp + " " + curCreature[CUR_EXP]);
        } else {
            printInfoText("You have slayn " + curEnemy[NAME] + " and got " + exp + " experience.");
        }
    } else {
        printInfoText("You attacked with " + attack[NAME] + "! " + curEnemy[NAME] + " took " + dmg + " damage.");
    }

    updateEnemyTxt();

    % Enemy turn
    turn = ENEMY;
    turnInterval = app.setInterval("enemyTurn()", ENEMY_RESPONSE_TIME);
}

/**
 * Select one creature from your creature list as a substitute for
 * the current creature. Does only work if there is an other creature
 * then the current one.
 * This actions switches the turn to the enemy if a switch is made.
 * @param {Number} idx The index of the new creature.
 */
function change(idx) {
    var creature = curPlayerCreatures[idx - 1];
    var oldName = curPlayerCreatures[curCreatureIdx][NAME];

    % If there is no creature or the same one is selected the swap can not be done
    if (creature[NAME] == "Empty" || curCreatureIdx == idx - 1) {
        printInfoText("Creature was not switched.");
        return;
    }

    curCreatureIdx = idx - 1;

    printInfoText("You switched from " + oldName + " to " + creature[NAME] + ".");
    updatePlayerTxt();
    drawAll();

    % Enemy turn
    turn = ENEMY;
    turnInterval = app.setInterval("enemyTurn()", ENEMY_RESPONSE_TIME);
}

/**
 * Selects the chosen item from the backpack and applies its affect.
 * This actions switches the turn to the enemy if a item is used (unless it is a catcher).
 * @param {Number} idx The index of the chosen item.
 */
function items(idx) {
    var item = ITEM_LIST[curPlayerItems[idx - 1]];
    % If no item at that slot
    if (item[NAME] == "Empty") {
        printInfoText("No item was used.");
        return;
    }

    printInfoText("You used " + item[NAME] + ".");
    % Apply the selected item
    if (item[NAME] == "Capture") {
        if (catchCreature()) {
            updateEnemyTxt();
            addInfoText(" Your new enemy is: " + curEnemy[NAME] + ".");
        }
        return;
    }
    if (item[NAME] == "Improve") {
    } else if (item[NAME] == "Weaken") {
    } else if (item[NAME] == "Potion") {
    } else if (item[NAME] == "lalala") {
    }

    % Enemy turn
    turn = ENEMY;
    turnInterval = app.setInterval("enemyTurn()", ENEMY_RESPONSE_TIME);
}

/**
 * Add the current enemy creature to your own creature list.
 * If there are already four creature select one to replace it.
 */
function catchCreature() {
    % Search for an emty space
    for (var i = 0; i < curPlayerCreatures.length; i++) {
        if (curPlayerCreatures[i][NAME] == "Empty") {
            curPlayerCreatures[i] = curEnemy;
            % Get new enemy
            curEnemy = getEnemy();
            drawAll();
            return true;
        }
    }
    % TODO replace creature when there is no spot left
    return false;
}

%%%%%%%%%%%%%%%%%
% Enemy actions %
%%%%%%%%%%%%%%%%%
/**
 * Calculates the enemys turn. If the current creature has
 * less or equal to zero health a new enemy creature is spawned
 * and the turn shifts back to the player.
 * Otherwise an attack onto the player occurs.
 * If the player creature is beaten, the player needs to chose a new one,
 * unless he has none left then he lost the game.
 */
function enemyTurn() {
    % Switch turn
    turn = PLAYER;
    % Clear the interval, since the enemy should only attack once
    app.clearInterval(turnInterval);

    % If the enemy is dead he is not able to attack and need to be substituted
    if (curEnemy[CUR_HP] == 0) {
        curEnemy = getEnemy();
        drawAll();
        updateEnemyTxt();
        printInfoText("Your new enemy is: " + curEnemy[NAME]);
        return;
    }

    % Get attack data
    var attacks = curEnemy[ATKS];
    var attackIdx = getRandomInt(attacks.length);
    var attack = ATTACK_LIST[attacks[attackIdx]];

    var creature = curPlayerCreatures[curCreatureIdx];
    var dmg = inflictDMG(curEnemy, creature, attack);
    % If the player creature is dead remove it from the player creatures
    if (creature[CUR_HP] <= 0) {
        creature[CUR_HP] = 0;
        updatePlayerTxt();

        curPlayerCreatures[curCreatureIdx] = ["Empty"];
        % If the player has no creatures left the game is over
        if (noCreatureLeft()) {
            gameover = true;
            printInfoText("No Creatures left, game over!");
        } else {
            printInfoText("Your creature has no health left, please select a new creature.");
        }
    } else {
        printInfoText("You got attacked with " + attack[NAME] + "! " + creature[NAME] + " took " + dmg + " damage.");
        updatePlayerTxt();
    }
}

%%%%%%%%%%%%%%%%%%%%%%%
% Helper %
%%%%%%%%%%%%%%%%%%%%%%%
/**
 * Check if the player has no creatures left.
 */
function noCreatureLeft() {
    for (var i = 0; i < curPlayerCreatures.length; i++) {
        if (curPlayerCreatures[i][NAME] != "Empty") {
            return false;
        }
    }
    return true;
}

/**
 * Check if the player creature has leveled up, by comparing
 * its current experience to the needed xp of the next lvl.
 * @param {Array} creature The data of the creature.
 */
function checkLvlUp(creature) {
    if (creature[CUR_EXP] > EXP_TABLE[creature[LVL] - MIN_LVL]) {
        creature[LVL]++;
        % Increase health after lvl up
        creature[MAX_HP] += Math.ceil(creature[HP_GAIN]);
        creature[CUR_HP] += Math.ceil(creature[HP_GAIN]);
        return true;
    }
    return false;
}

/**
 * Add experience points to the given creature.
 * The amount depends on the beaten enemy.
 * @param {Array} The data of the target creature.
 * @param {Array} The data of the source creature.
 */
function addEXP(source, target) {
    var exp = source[EXP_GAIN] * source[LVL];
    target[CUR_EXP] += exp;
    return exp;
}

/**
 * Apply damage to the target creature depending on
 * the attack and the source creature lvl.
 * Takes also into account the type of both creatures.
 */
function inflictDMG(source, target, attack) {
    % TODO take type into account
    var dmg = Math.ceil(attack[DMG] * source[LVL])
    target[CUR_HP] -= dmg;
    return dmg;
}

%%%%%%%%%%%%%%%%%%%%%%%
% Information updates %
%%%%%%%%%%%%%%%%%%%%%%%
/**
 * Update the text of all four gui buttons depending on the
 * current menu state.
 */
function updateButtontxt() {
    if (gamestate == MENU) {
        this.getField("button1txt").value = "Fight";
        this.getField("button2txt").value = "Change";
        this.getField("button3txt").value = "Item";
        this.getField("button4txt").value = "Run";
    } else if (gamestate == FIGHT) {
        var attacks = curPlayerCreatures[curCreatureIdx][ATKS];
        this.getField("button1txt").value = ATTACK_LIST[attacks[0]][NAME];
        this.getField("button2txt").value = ATTACK_LIST[attacks[1]][NAME];
        this.getField("button3txt").value = ATTACK_LIST[attacks[2]][NAME];
        this.getField("button4txt").value = ATTACK_LIST[attacks[3]][NAME];
    } else if (gamestate == CHANGE) {
        this.getField("button1txt").value = curPlayerCreatures[0][NAME];
        this.getField("button2txt").value = curPlayerCreatures[1][NAME];
        this.getField("button3txt").value = curPlayerCreatures[2][NAME];
        this.getField("button4txt").value = curPlayerCreatures[3][NAME];
    } else if (gamestate == ITEMS) {
        this.getField("button1txt").value = ITEM_LIST[curPlayerItems[0]][NAME];
        this.getField("button2txt").value = ITEM_LIST[curPlayerItems[1]][NAME];
        this.getField("button3txt").value = ITEM_LIST[curPlayerItems[2]][NAME];
        this.getField("button4txt").value = ITEM_LIST[curPlayerItems[3]][NAME];
    }
}

/**
 * Updates the enemy information displayed by the gui.
 */
function updateEnemyTxt() {
    this.getField("enemyname").value = curEnemy[NAME];
    this.getField("enemystatus").value = "Type: " + TYPE_STRINGS[curEnemy[TYPE]] + " - Level: " + curEnemy[LVL];
    this.getField("enemyhp").value = "HP: " + curEnemy[CUR_HP] + " of " + curEnemy[MAX_HP];
}

/**
 * Updates the player information displayed by the gui.
 */
function updatePlayerTxt() {
    var creature = curPlayerCreatures[curCreatureIdx];
    this.getField("playername").value = creature[NAME];
    this.getField("playerstatus").value = "Type: " + TYPE_STRINGS[creature[TYPE]] + " - Level: " + creature[LVL];
    this.getField("playerhp").value = "HP: " + creature[CUR_HP] + " of " + creature[MAX_HP];
}

%%%%%%%%%%%%
% Spawning %
%%%%%%%%%%%%
/**
 * Create a new enemy with level depending on the currently available
 * player creatures. Allows for enemys that continously pose a threat to
 * the player and allow him to level up.
 */
function getEnemy() {
    % Calculate the level depending on the reserve creatures
    var curLvl = 0;
    for (var i = 0; i < curPlayerCreatures.length; i++) {
        if (curPlayerCreatures[i][NAME] != "Empty") {
            curLvl += curPlayerCreatures[i][LVL];
        }
    }
    curLvl /= curPlayerCreatures.length;

    % Variance
    var offset = getRandomInt(MIN_LVL * 2);
    curLvl = curLvl + (MIN_LVL - offset);
    curLvl = Math.max(MIN_LVL, Math.floor(curLvl));

    return getCreature(curLvl);
}

/**
 * Get a random creature with the given level.
 * @param {Number} curLvl The level of the creature.
 */
function getCreature(curLvl) {
    var creature = getRandomInt(CREATURE_LIST.length);

    var hp = Math.ceil(CREATURE_LIST[creature][HP_GAIN] * curLvl);

    % TODO dont copy everything, have an id to the original list and
    % extra attributes for the instance variables
    return [
        CREATURE_LIST[creature][NAME],
        CREATURE_LIST[creature][HP_GAIN],
        CREATURE_LIST[creature][TYPE],
        CREATURE_LIST[creature][ATKS],
        CREATURE_LIST[creature][EXP_GAIN],
        CREATURE_LIST[creature][IMAGE],
        hp, % MAX_HP
        hp, % CUR_HP
        curLvl, % LVL
        START_EXP % CUR_EXP
    ];
}

%%%%%%%%%%%%%%%%%%%%%
% Draw and coloring %
%%%%%%%%%%%%%%%%%%%%%
/**
 * Draw all cells.
 */
function drawAll() {
    var creature = curPlayerCreatures[curCreatureIdx];
    var centerM = FIELD_HEIGHT * 0.5;
    var startM = Math.floor(centerM - creature[IMAGE].length * 0.5);

    % Draw player creature
    for (var m = 0; m < FIELD_HEIGHT; m++) {
        if (startM <= m && m < startM + creature[IMAGE].length) {
            drawPlayer(m, creature[IMAGE][m - startM]);
        } else {
            drawPlayer(m, "")
        }
    }

    creature = curEnemy;
    startM = Math.floor(centerM - creature[IMAGE].length * 0.5);

    % Draw enemy creature
    for (var m = 0; m < FIELD_HEIGHT; m++) {
        if (startM <= m && m < startM + creature[IMAGE].length) {
            drawEnemy(m, creature[IMAGE][m - startM]);
        } else {
            drawEnemy(m, "")
        }
    }
}

/**
 * Redraw the given enemy row.
 *
 * @param {Number} m The m position.
 * @param {Number} value The value.
 */
function drawEnemy(m, value) {
    var cell = this.getField("enemy" + m);
    cell.delay = true;
    cell.value = value;
    cell.delay = false;
}

/**
 * Redraw the given player row.
 *
 * @param {Number} m The m position.
 * @param {Number} value The value.
 */
function drawPlayer(m, value) {
    var cell = this.getField("player" + m);
    cell.delay = true;
    cell.value = value;
    cell.delay = false;
}

/**
 * Print information about the winner and the gamestate.
 */
function printInfoText(text) {
    var field = this.getField("info");
    field.delay = true;
    field.value = text;
    field.delay = false;
}

/**
 * Add information to the information-gui.
 */
function addInfoText(text) {
    var field = this.getField("info");
    field.delay = true;
    field.value += text;
    field.delay = false;
}

\end{insDLJS}

\OpenAction{/S /JavaScript /JS (initialise();)}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Dokument
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

    \begin{Form}

        % Header
        \begin{multicols}{2}
            % Title
            \section*{ASCIImon}
        \columnbreak
            % Tooltip object
            \begin{flushright}%
                \PushButton[name=tooltipbtn, bordercolor=white]{%
                    \begin{tcolorbox}[width=20pt, height=20pt, left=3pt, top=0pt]
                        \centering?\strut{}
                    \end{tcolorbox}%
                }
            \end{flushright}%
        \end{multicols}

        % Calculate the max width and height of a block
        \def\blocksizeH{\dimexpr (250 pt)/\fieldHeight \relax}
        \def\blocksizeW{\dimexpr (250 pt) \relax}

        \begin{multicols}{2}

            \begin{tcolorbox}%
                \TextField[name=enemyname, width=\linewidth, readonly=true]{}\newline

                \TextField[name=enemystatus, width=\linewidth, readonly=true]{}\newline

                \TextField[name=enemyhp, width=\linewidth, readonly=true]{}%
            \end{tcolorbox}%

            \vspace{2.5cm}

            \begin{center}
                \xintFor* #1 in {\xintSeq{0}{\fieldHeight-1}} \do {%
                    \TextField[%
                        width=\blocksizeW, height=\blocksizeH, bordercolor=white, name=player#1, readonly=true%
                    ]{}%
                    \\[0pt]%
                }%
            \end{center}

        \columnbreak%

            \begin{center}
                \xintFor* #1 in {\xintSeq{0}{\fieldHeight-1}} \do {%
                    \TextField[%
                        width=\blocksizeW, height=\blocksizeH, bordercolor=white, name=enemy#1, readonly=true%
                    ]{}%
                    \\[0pt]%
                }%
            \end{center}

            \vspace{2.5cm}

            \begin{tcolorbox}%
                \TextField[name=playername, width=\linewidth, readonly=true]{}\newline

                \TextField[name=playerstatus, width=\linewidth, readonly=true]{}\newline

                \TextField[name=playerhp, width=\linewidth, readonly=true]{}%
            \end{tcolorbox}%

        \end{multicols}

        %%%%%%%%%%%%%%%%%%%%%%%
        % Commandredifinition %
        % https://www.dickimaw-books.com/latex/admin/html/eforms.shtml
        %%%%%%%%%%%%%%%%%%%%%%%
        % \def\DefaultHeightofText{14pt}
        % \renewcommand*{\LayoutTextField}[2]{%
        %     \parbox[c][\DefaultHeightofText]{0.5\linewidth}{#1#2}%
        % }

        % \renewcommand*{\LayoutCheckField}[2]{#1 #2}
        % \renewcommand*{\DefaultWidthofCheckBox}{2ex}
        % \renewcommand*{\DefaultHeightofCheckBox}{2ex}
        % \renewcommand*{\LayoutCheckField}[2]{%
        %     \parbox[c][\DefaultHeightofCheckBox]{0.12\linewidth}{#1}\enspace%
        %     \parbox[c][\DefaultHeightofCheckBox]{\DefaultWidthofCheckBox}{#2}%
        % }

        % \renewcommand*{\DefaultWidthofChoiceMenu}{2.5ex}
        % \renewcommand*{\DefaultHeightofChoiceMenu}{2.04ex}

        %%%%%%%%%%%%%%%%
        % GUI elements %
        %%%%%%%%%%%%%%%%
        \begin{center}
            \begin{tcolorbox}
                \TextField[name=info, width=\linewidth, readonly=true]{}
            \end{tcolorbox}

            % Game related buttons
            \begin{tabularx}{\textwidth}{@{} *{2}{X} @{}}%
                \PushButton[name=button1, bordercolor=white, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        \TextField[name=button1txt, width=\linewidth, readonly=true]{}%
                        \strut
                    \end{tcolorbox}
                } &
                \PushButton[name=button2, bordercolor=white, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        \TextField[name=button2txt, width=\linewidth, readonly=true]{}%
                        \strut
                    \end{tcolorbox}
                }\\
                \PushButton[name=button3, bordercolor=white, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        \TextField[name=button3txt, width=\linewidth, readonly=true]{}%
                        \strut
                    \end{tcolorbox}
                } &
                \PushButton[name=button4, bordercolor=white, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        \TextField[name=button4txt, width=\linewidth, readonly=true]{}%
                        \strut
                    \end{tcolorbox}
                }\\
                \PushButton[name=back, bordercolor=white, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        Back\strut
                    \end{tcolorbox}
                } &
                \PushButton[name=restart, bordercolor=white, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        Restart game\strut
                    \end{tcolorbox}
                }
                \\
            \end{tabularx}
        \end{center}

        \TextField[bordercolor=white, name=tooltiptxt, readonly=true, hidden]{}

    \end{Form}
\end{document}
