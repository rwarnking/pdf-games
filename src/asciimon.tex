\documentclass[12pt, a4paper, footexclude, headexclude]{scrartcl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[margin=0.5in]{geometry}

% \usepackage[utf8x]{inputenc}
% \usepackage[T1]{fontenc}
% \usepackage[ngerman]{babel}
% \usepackage{xcolor}
\usepackage[pdftex]{hyperref}
\usepackage{multicol}

\usepackage{xinttools}
\usepackage[nomessages]{fp}
\usepackage{tabularx}
\usepackage{tcolorbox}

\setlength{\parindent}{0pt}

\usepackage[pdftex]{insdljs}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Parameter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Obacht: It is discuraged to use a field with size bigger than 15x15 since the pdf might get
% to slow to play
\def\fieldWidth{30}
\def\fieldHeight{15}
\def\atkAnimCells{20}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Javascript
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{insDLJS}[]{JSDateiname}{asciimon}

const GAME_DESC = "This game is similar to old games one might have played on a gameboy.\
There are two creatures shown. The one at the bottom is the player, while the one at the\
top is the enemy. Each turn both creatures are supposed to attack each other until\
one of them has no health left. If the enemy is beaten a new creature is selected.\
If your own creature dies you lose, unless you previously caught another one.";

% Outside variables
const FIELD_WIDTH = AFMakeNumber(\fieldWidth);
const FIELD_HEIGHT = AFMakeNumber(\fieldHeight);
const ATK_ANIM_CELLS = AFMakeNumber(\atkAnimCells);
const SCREEN_TEXT_WIDTH = 400;
const ENEMY_RESPONSE_TIME = 4000;
const CHANGE_ANIMATION_SPEED = 50;

%%%%%%%%%%%%%%%%%%
% Game constants %
%%%%%%%%%%%%%%%%%%
% Menu states
const MENU = 0;
const FIGHT = 1;
const CHANGE = 2;
const ITEMS = 3;
const RUN = 4;
const HARD_CHANGE = 5;
const REPLACE = 6;

% Turns
const PLAYER = 0;
const ENEMY = 1;

% Animation
const CENTER_M = FIELD_HEIGHT * 0.5;
const PADDING_SYMB = " ";
% https://stackoverflow.com/questions/16885297/
const EMPTY_LINE = Array(FIELD_WIDTH + 2).join(PADDING_SYMB);

%%%%%%%%%%%%%%%%%%%%
% Global game data %
%%%%%%%%%%%%%%%%%%%%
% The game field
var gamestate = MENU;
var gameover = false;
% Creature data
var curCreatureIdx = 0;
var curPlayerCreatures = [["Empty"], ["Empty"], ["Empty"], ["Empty"]];
var curPlayerItems = [0, 0, 0, 0];
var curEnemy = 0;

% Turn information
var turnInterval;
var turn = PLAYER;

% Animation data
var changeAnimationInterval;
var animationProgress = FIELD_WIDTH;

%%%%%%%%%%%%%%%%%
% Creature data %
%%%%%%%%%%%%%%%%%
% Attributes
const NAME = 0;
const HP_GAIN = 1;
const TYPE = 2;
const ATKS = 3; % attacks
const EXP_GAIN = 4;
const IMAGE = 5;
const MAX_HP = 6;
const CUR_HP = 7;
const LVL = 8;
const CUR_EXP = 9;

const START_EXP = 500;
const MIN_LVL = 5;

% Types
const T_WATER = 0;
const T_AIR = 1;
const T_STONE = 2;
const T_GRASS = 3;
const T_GHOST = 4;
const T_FLUFF = 5;
const T_FIRE = 6;

const TYPE_STRINGS = new Array(
    "Water", "Air", "Stone", "Grass", "Ghost", "Fluff", "Fire"
);

% Row against column - 1 = normal dmg
const DMG_MATRIX = [
    % Water, Air, Stone, Grass, Ghost, Fluff, Fire
    [1.0, 1.0, 0.3, 0.5, 1.3, 1.7, 2.0], % Water
    [0.9, 1.0, 0.4, 0.7, 2.0, 1.3, 0.8], % Air
    [0.7, 0.5, 1.3, 1.5, 0.8, 2.0, 1.3], % Stone
    [1.7, 0.7, 1.3, 1.0, 1.3, 1.3, 0.7], % Grass
    [0.9, 0.5, 0.5, 1.3, 1.3, 2.0, 0.8], % Ghost
    [0.8, 1.1, 1.5, 1.1, 1.7, 0.5, 0.5], % Fluff
    [0.8, 0.4, 2.0, 2.0, 0.3, 2.0, 0.4], % Fire
];

% https://ascii.co.uk/art
% http://www.asciiworld.com/index.html
const CREATURE_LIST = new Array(
    % Water
    ["DUCK", 2.5, T_WATER, [0, 1, 35, 44], 25,
        [
             "  __    ",
             "<(o )___",
             " \\ ._> /",
             "  `---' "
        ]
    ],
    ["OCTOPUS", 3.3, T_WATER, [1, 2, 12, 41], 58,
        [ % https://ascii.co.uk/art/octopus
            "                 .-'   `'.                           ",
            "                /         \\                          ",
            "                |         ;                          ",
            "                |         |           ___.--,        ",
            "       _.._     (0) ~ (0) |    _.---'`__.-( )_.      ",
            "__.--'`_.. '.__.\\    '--. \\_.-' ,.--'`     `\"\"`      ",
            " ,.--'`   ',__ /./;   ;, '.__.'`    __               ",
            "      .---.__.' / |   |\\   \\__..--\"\"  \"\"\"--.,_       ",
            "    .'.''-._.-'`_./  /\\ '.  \\ _.-~~~````~~~-._`-.__.'",
            "    | |  .' _.-' |  |  \\  \\  '.               `~---` ",
            "     \\ \\/ .'     (  \\   '. '-._)                     ",
            "      \\/ /        \\  \\    `=.__`~-.                  ",
            "      / /\\         (  )    / / `\"\".`\\                ",
            ", _.-'.'\\ \\        / /    ( )     / /                ",
            " `--~`   ( )    .-'.'      '.'.  | |                 ",
            "          `    '-;`          (-)  '-;                "
        ]
    ],
    ["JELLYFISH", 2.1, T_WATER, [1, 6, 28, 46], 25,
        [ % https://ascii.co.uk/art/jellyfish
            " .-;':':'-.  ",
            "{'.'.'.'.'.} ",
            " ?        '`.",
            "'-. ._ ,_.-='",
            "  `). ( `);( ",
            "  ('. .)(,'.)",
            "   ) ( ,').( ",
            "  ( .').'(').",
            "  .) (' ).(' ",
            "   '  ? (  ).",
            "    .'( .)'  ",
            "        .'   "
        ]
    ],
    ["WHALE", 4.2, T_WATER, [2, 3, 13, 36], 80,
        [ % https://ascii.co.uk/art/whale
            "                  __       __  ",
            "                 '.'--.--'.-'  ",
            "   .,_--- --.___    \\' r'      ",
            "   ', '-._a      '-' .'        ",
            "     \\    '-'Y \\._  /          ",
            "      '--;____'--.'-,          ",
            "       /..'       '''          "
        ]
    ],
    ["FISH", 2.7, T_WATER, [1, 3, 5, 8], 35,
        [ % https://ascii.co.uk/art/fish
            "             |             ",
            "             |             ",
            "            ,|.            ",
            "           ,\\|/.           ",
            "         ,' .V. `.         ",
            "        / .     . \\        ",
            "       /_`       '_\\       ",
            "      ,' .:     ;, `.      ",
            "      |@)|  . .  |(@|      ",
            " ,-._ `._';  .  :`_,' _,-. ",
            "'--  `-\\ /,-===-.\\ /-'  --`",
            "(----  _| ||___|| |_  ----)",
            "`._,-'  \\  `-.-'  /  `-._,'",
            "         `-.___,-'         "
        ]
    ],
    % Air
    ["BIRD", 2.2, T_AIR, [5, 8, 10, 38], 25,
        [ % https://ascii.co.uk/art/bird
            "       ,\\--/,       ",
            "      { @  @ }      ",
            "      |  \\/  |      ",
            "      | )  ( |      ",
            "------`W-mm-W'------",
            "        \\  /        ",
            "         WW         "
        ]
    ],
    ["BAT", 2.1, T_AIR, [7, 11, 21, 30], 20,
        [ % https://ascii.co.uk/art/bat
            "._.                  _.____.",
            " ) \\.              /    .(  ",
            " )  |            .'   .(    ",
            " ). |.          .'  .(      ",
            "   ) |.        .'  (        ",
            "   ). ;      ./  .(         ",
            "    ) |      |  (           ",
            "    ).;      :.(            ",
            "     ||    .|.;             ",
            "     .^--^./ |.             ",
            "     ;0..0;   \\             ",
            "      'vv'_.:_.:            ",
            "           m  M             "
        ]
    ],
    ["BUTTERFLY", 2.2, T_AIR, [10, 12, 24, 36], 25,
        [ % https://ascii.co.uk/art/butterfly
                ".==-.                   .-==.",
                " \\()8`-._  `.   .'  _.-'8()/ ",
                " (88\"   ::.  \\./  .::   \"88) ",
                "  \\_.'`-::::.(#).::::-'`._/  ",
                "    `._... .q(_)p. ..._.'    ",
                "      \"\"-..-'|=|`-..-\"\"      ",
                "      .\"\"' .'|=|`. `\"\".      ",
                "    ,':8(o)./|=|\\.(o)8:`.    ",
                "   (O :8 ::/ \\_/ \\:: 8: O)   ",
                "    \\O `::/       \\::' O/    ",
                "     \"\"--'         `--\"\"     "
        ]
    ],
    ["OWL", 3.1, T_AIR, [10, 11, 28, 34], 55,
        [ % https://ascii.co.uk/art/owl
            "                 ___        ",
            "             .-\"-~-\"-.      ",
            "            /.-\"-.-\"-.\\     ",
            "            ||((o|o))||     ",
            "            )\\__/V\\__/(     ",
            "           / ~ -...- ~ \\    ",
            "          |\\` ~. ~ .~ `/|   ",
            "       () | `~ - \^ - ~` |   ",
            "   () //  | ;  '  :  .  |   ",
            "  ()\\\\/_() \\ . : '  ; '/    ",
            " ___/ /_____'.   ; ' .'____ ",
            "       _   \^ `uu---uu`    /\\",
            "__   ________\^ _________\^_\\/"
        ]
    ],
    % Stone
    ["STONES", 3.7, T_STONE, [6, 13, 16, 39], 60,
        [ % https://ascii.co.uk/art/dice
            "          ________          ",
            "         /\\       \\         ",
            "        /  \\       \\        ",
            "       /    \\       \\       ",
            "      /      \\_______\\      ",
            "      \\      /       /      ",
            "    ___\\    /   ____/___    ",
            "   /\\   \\  /   /\\       \\   ",
            "  /  \\   \\/___/  \\       \\  ",
            " /    \\       \\   \\       \\ ",
            "/      \\_______\\   \\_______\\",
            "\\      /       /   /       /",
            " \\    /       /   /       / ",
            "  \\  /       /\\  /       /  ",
            "   \\/_______/  \\/_______/   "
        ]
    ],
    ["PYRAMID", 4.0, T_STONE, [13, 15, 26, 39], 75,
        [ % https://ascii.co.uk/art/pyramid
            "                _L/L                ",
            "              _LT/l_L_              ",
            "            _LLl/L_T_lL_            ",
            "          _LT|L/_|__L_|_L_          ",
            "        _TL|_T/_L_|__T__|_l_        ",
            "      _LL|_Tl/_|__l___L__L_|L_      ",
            "    _'|_|_|T/_L_l__T _ l__|__|L_    ",
            "  _LlT_|_Ll/_l_ _|__[ ]__|__|_l_L_  ",
            "_T_L|_|_|l/___|__ | _l__|_ |__|_T_L_"
        ]
    ],
    % Grass
    ["TREE", 3.6, T_GRASS, [11, 17, 20, 40], 60,
        [ % https://ascii.co.uk/art/tree
            "          &&& &&  & &&        ",
            "      && &\\/&\\|& ()|/ @, &&   ",
            "      &\\/(/&/&||/& /_/)_&/_&  ",
            "   &() &\\/&|()|/&\\/ '\%\" & ()  ",
            "  &_\\_&&_\\ |& |&&/&__\%_/_& && ",
            "&&   && & &| &| /& & \% ()& /&&",
            " ()&_---()&\\&\\|&&-&&--\%---()~ ",
            "     &&     \\|||              ",
            "             |||              ",
            "             |||              ",
            "             |||              ",
            "       , -=-~  .-^- _         "
        ]
    ],
    ["ANT", 1.9, T_GRASS, [21, 24, 31,  41], 19,
        [ % https://ascii.co.uk/art/ant
            " \\       /                       ",
            "  \\     /                        ",
            "   \\.-./                         ",
            "  (o\\^/o)  _   _   _     __      ",
            "   ./ \\.\\ ( )-( )-( ) .-'  '-.   ",
            "    {-} \\(//  ||   \\\\/ (   )) '-.",
            "         //-__||__.-\\\\.       .-'",
            "        (/    ()     \\) '-._.-'   ",
            "        ||    ||      \\\\         ",
            "        |'    ('       ')        "
        ]
    ],
    ["BEEHIVE", 3.9, T_GRASS, [9,  17, 21, 45], 70,
        [ % https://ascii.co.uk/art/bee
            "     \^\^      .-=-=-=-.  \^\^         ",
            " \^\^        (`-=-=-=-=-`)         ",
            "         (`-=-=-=-=-=-=-`)  \^\^   ",
            "   \^\^   (`-=-=-=-=-=-=-=-`)      ",
            "       ( `-=-=-=-( )-=-=-` )       ",
            "       (`-=-=-=-=-=-=-=-=-`)       ",
            "       (`-=-=-=-=-=-=-=-=-`)       ",
            "       (`-=-=-=-=-=-=-=-=-`)       ",
            "       (`-=-=-=-=-=-=-=-=-`)       ",
            "        (`-=-=-=-=-=-=-=-`)        ",
            "         (`-=-=-=-=-=-=-`)  \^\^   ",
            "           (`-=-=-=-=-`)           ",
            "            `-=-=-=-=-`   \^\^     "
        ]
    ],
    ["COBRA", 3.0, T_GRASS, [21,  30, 40, 45], 40,
        [ % https://ascii.co.uk/art/cobra
            "         ,,'6''-,.                                  ",
            "        <====,.;;--.                                ",
            "        _`---===. \"\"\"==__                           ",
            "      //\"\"@@-\\===\\@@@@ \"\"\\\\                         ",
            "     |( @@@  |===|  @@@  |)                         ",
            "      \\\\ @@   |===|  @@  //                         ",
            "        \\\\ @@ |===|@@@ //                           ",
            "         \\\\  |===|  //                              ",
            "___________\\\\|===| //_____,----\"\"\"\"\"\"\"\"\"\"-----,_    ",
            "  \"\"\"\"---,__`\\===`/ _________,---------,____    `,  ",
            "             |==||                           `\\   \\ ",
            "            |==| |                             |   |",
            "           |==| |       _____         ______,--'   '",
            "           |=|  `----\"\"\"     `\"\"\"\"\"\"\"\"         _,-' ",
            "            `=\\_______,---\"\"\"-------------\"\"\"''     "
        ]
    ],
    ["TULIP", 2.4, T_GRASS, [7,  23, 36, 47], 25,
        [ % https://ascii.co.uk/art/tulips
            "      ,    ",
            "  /\\\^/`\\   ",
            " | \\/   |  ",
            " | |    |  ",
            " \\ \\    /  ",
            "  '\\\\//'   ",
            "    ||     ",
            "    ||     ",
            "    ||     ",
            "    ||  ,  ",
            "|\\  ||  |\\ ",
            "| | ||  | |",
            "| | || / / ",
            " \\ \\||/ /  ",
            "  `\\\\//`   "
        ]
    ],
    ["MUSHROOM", 2.8, T_GRASS, [14,  22, 27, 41], 45,
        [ % https://ascii.co.uk/art/mushroom
            "           ____             ",
            "       _.-'78o `\"`--._      ",
            "   ,o888o.  .o888o,   ''-.  ",
            " ,88888P  `78888P..______.] ",
            "/_..__..----\"\"        __.'  ",
            "`-._       /\"\"| _..-''      ",
            "    \"`-----\\  `\\            ",
            "            |   ;.-\"\"--..   ",
            "            | ,8o.  o88. `. ",
            "            `;888P  `788P  :",
            "      .o\"\"-.|`-._         ./",
            "     J88 _.-/    \";\"-P----' ",
            "     `--'\\`|     /  /       ",
            "         | /     |  |       ",
            "         `------`---'       "
        ]
    ],
    % Ghost
    ["REAPER", 3.5, T_GHOST, [4, 18, 29, 42], 65,
        [ % https://ascii.co.uk/art/death
            "              ,____ ",
            "              |---.\\",
            "      ___     |    `",
            "     / .-\\  .(=)    ",
            "    |  |\"|_/\\/|     ",
            "    ;  |-;| /_|     ",
            "   / \\_| |/   |     ",
            "  /      \\/   |     ",
            "  |   /  |`   |     ",
            "  /   \\ _/    |     ",
            " /--._/  \\    |     ",
            " (/|)    |    /     ",
            "    /     |   |     ",
            "  .'      |   |     ",
            " /         \\  |     ",
            "(_.-.__.__.)  /     "
        ]
    ],
    ["ANGEL", 3.2, T_GHOST, [25, 29, 33, 48], 60,
        [ % https://ascii.co.uk/art/angel
            "     __/)     (\\__     ",
            "  ,-'~~(   _   )~~`-.  ",
            " /      \\/'_'\\/      \\ ",
            "|       /_(_)_\\       |",
            "|     _(/(\\_/)\\)_     |",
            "|    / // \\ / \\\\ \\    |",
            " \\  | ``  / \\ ''  |  / ",
            "  \\  )   /   \\   (  /  ",
            "   )/   /     \\   \\(   ",
            "   '    '-'-'-'    '   "
        ]
    ],
    ["PUMPKIN FAMILY", 3.1, T_GHOST, [25,  26, 31, 46], 57,
        [ % https://ascii.co.uk/art/halloween
            "                      /\\          ",
            "        _           __(_)__       ",
            "        \\_      .-'._'-'_.'-.    ",
            "     .'`---`'. .'.' /o\\'/o\\ '.'.  ",
            "    /  <> <>  \\ : ._:  0  :_. : \\ ",
            "    |    A    |:   \\\\/\\_/\\//   : |",
            "    \\  <\\_/>  / :  :\\/\\_/\\/:  : / ",
            "   _?_._`\"`_.'`'-:__:__:__:__:-'  ",
            " .'`---`'.``  _/\\                 ",
            "/.'a . a  \\.'`---`'.              ",
            "|:        /.'<> <>  \\             ",
            "\\'  \\__   |:   ^    |             ",
            " '._____.'\\' '___'  /             ",
            "           '.__.__.'              "
        ]
    ],
    ["SPIDER FAMILY", 2.3, T_GHOST, [15, 21, 32, 45], 22,
        [ % https://ascii.co.uk/art/halloween
            "        _.._   _\\(o)/_  //  \\\\      ",
            "      .'    '.  /(_)\\  _\\\\()//_     ",
            "    /   __   \\        / //  \\\\ \\    ",
            " ,  |   ><   |  ,      | \\__/ |     ",
            ". \\  \\      /  / .                  ",
            " \\_'--`(  )'--'_/     __             ",
            "   .--'/()\\'--.    | /  \\ |         ",
            "  /  /` '' `\\  \\  \\_\\\\  //_/        ",
            "    |        |      //()\\\\          ",
            "     \\      /       \\\\  //          "
        ]
    ],
    ["MAGICIAN", 3.0, T_GHOST, [0, 9, 28, 44], 55,
        [ % https://ascii.co.uk/art/magician
            ". .'..' . ' ' . . '.  . '",
            "  `.':.'        ':'.'.'  ",
            "    `\\\\_  |     _//'     ",
            "      \\(  |\\    )/       ",
            "      //\\ |_\\  /\\\\       ",
            "     (/ /\\(\" )/\\ \\)      ",
            "      \\/\\ (  ) /\\/       ",
            "         |(  )|          ",
            "         | \\( \\          ",
            "         |  )  \\         ",
            "         |      \\        ",
            "         |       \\       ",
            "         |        `.__,  ",
            "         \\_________.-'   "
        ]
    ],
    % Fluff
    ["SHEEP", 2.9, T_FLUFF, [33, 35, 37, 43], 40,
        [ % https://ascii.co.uk/art/sheep
            "    .-:'  `; `-._   ",
            "   (_,           )  ",
            " ,'o\"(            )>",
            "(__,-'            ) ",
            "   (             )  ",
            "    `-'._.--._.-'   ",
            "       |||  |||     "
        ]
    ],
    ["BEAR", 3.4, T_FLUFF, [11, 16, 33, 42], 55,
        [ % https://ascii.co.uk/art/bear
            "     ( )___( )    ",
            "     /__oo   \\    ",
            "    ( \\/     )    ",
            "    | `=/    |    ",
            "   /         \\    ",
            "  /  /    \\   \\   ",
            " /  /      \\   \\  ",
            "| ,_/_      \\   \\ ",
            " \\_ '=       \\   |",
            "   \"\"'       /  / ",
            "   ;        /  /'?",
            "   :       {{}} / ",
            "    `._   \\  _ (  ",
            "     __)   |  /_  ",
            "   (\"__,..\"'_._.) "
        ]
    ],
    ["SNAIL", 2.3, T_FLUFF, [1, 19, 24, 37], 30,
        [ % https://ascii.co.uk/art/insect
            "     /\^\\    /\^\\                         ",
            "    {  O}  {  O}                        ",
            "     \\ /    \\ /                         ",
            "     //     //       _------_           ",
            "    //     //     ./~        ~-_        ",
            "   / ~----~/     /              \\       ",
            " /         :   ./       _---_    ~-     ",
            "|  \\________? :       /~     ~\\   |     ",
            "|        /    |      |  :~~\\  |   |     ",
            "|       |     |      |  \\___-~    |     ",
            "|       \\ __/`\^\\______\\.        ./     ",
            " \\                     ~-______-~\\.     ",
            " .|                                ~-_  ",
            "/_____________________________________~~"
        ]
    ],
    % Fire
    ["CANDLE", 2.6, T_FIRE, [8, 31, 46, 48], 20,
        [ % https://ascii.co.uk/art/candle
            "         (\\           ",
            "        /  )          ",
            "       ( * )          ",
            "        \\#/           ",
            "      .-\"#'-.         ",
            "      |\"-.-\"|         ",
            "      |     |         ",
            "    __|     |__   .-. ",
            " .-'  |     |  `-:   :",
            ":     '-._,-'    :-'  ",
            " `-._         _.-'    ",
            "     '\"\"\"\"\"\"'         "
        ]
    ],
    ["DRAGON", 3.7, T_FIRE, [10, 39, 45, 49], 65,
        [ % https://ascii.co.uk/art/dragon
            " <>=======()                           ",
            " /\\___   /|\\\\          ()==========<>_ ",
            "      \\_/ | \\\\        //|\\   ______/ \\",
            "        \\_|  \\\\      // | \\_/          ",
            "          \\|\\/|\\_   //  /\\/            ",
            "           (oo)\\ \\_//  /               ",
            "          //_/\\_\\/ /  |                ",
            "         @@/  |=\\  \\  |                ",
            "              \\_=\\_ \\ |                ",
            "                \\==\\ \\|\\_              ",
            "             __/\\===\\(  )\\             ",
            "            ((~)) __-_/   |            ",
            "                 ((~)) \\  /            ",
            "                 ______/ /             ",
            "                 '------'              "
        ]
    ],
    ["HANDGRANADE", 2.7, T_FIRE, [14, 39, 48, 50], 20,
        [ % https://ascii.co.uk/art/handgranade
            "           .     ",
            "          /|     ",
            "         |@/     ",
            "        _/\"      ",
            "      _/==\\__    ",
            "     (==---==)   " ,
            "  /\%/_________\\  ",
            " /#(_|_|_|_|_|_) ",
            "|#(_|_|_|_|_|_|_)",
            "|#(|_|_|_|_|_|_|)",
            "|#(_|_|_|_|_|_|_)",
            "\\#(_|_|_|_|_|_)  ",
            " \\#|_|_|_|_|_/   ",
            "   '\"-------\"    "
        ]
    ],
    ["COFFEE", 2.6, T_FIRE, [6, 8, 20, 42], 20,
        [ % https://ascii.co.uk/art/coffee
            "    {  }            ",
            "  {   }             ",
            "   {}_{ __{         ",
            " .-{   }   }-.      ",
            "(   }     { } )     ",
            "|`-.._____..-'|     ",
            "|             ;--.  ",
            "|             |__  \\",
            "|             | (  )",
            "|             |/  / ",
            "|             /  /  ",
            "|               /   ",
            "\\             y'    ",
            " `-.._____..-'      "
        ]
    ],
    ["FLAMEINGO", 2.7, T_FIRE, [10, 35, 43, 47], 38,
        [ % https://ascii.co.uk/art/flamingo
            "           __   ",
            "          /(`o) ",
            "    ,-,  //  \\\\ ",
            "   (,,,) ||   V ",
            "  (,,,,)\\//     ",
            "  (,,,/w)-'     ",
            "  (,,/w)        ",
            "  `V/uu         ",
            "    / |         ",
            "    | |         ",
            "    o o         ",
            "    \\ |         ",
            "\\,/   ,\\|,.  \\,/"
        ]
    ]
);

const DMG = 1;

% https://www.fantasynamegenerators.com/anime-attack-names.php
% Water 6, Air 6, Stone 7, Grass 6, Ghost 8, Fluff 6, Fire 11
% Each creature should have attacks worth of 6 dmg points
const ATTACK_LIST = new Array(
    % Water
    ["Overflowing Look", 1.1, T_WATER], % 0 - DUCK, MAGICIAN
    ["Bubble Knock", 1.3, T_WATER], % DUCK, OCTOPUS, JELLYFISH, FISH, SNAIL
    ["Ice Prism", 2.3, T_WATER], % OCTOPUS, WHALE
    ["Running Wave", 1.0, T_WATER], % WHALE, FISH
    ["Drowning Screech", 1.5, T_WATER], % REAPER, ELLYFISH
    ["Stormy Rush", 1.2, T_WATER], % 5 - BIRD, FISH
    ["Flow Release", 0.9, T_WATER], % STONE, COFFEE
    % Air
    ["Fearless Smoke", 0.9, T_AIR], % TULIP
    ["Dutiful Mist", 1.0, T_AIR], % BIRD, FISH, BAT, CANDLE, COFFEE
    ["Wind Volley", 1.3, T_AIR], % BEEHIVE, MAGICIAN
    ["Screaming Wind", 1.9, T_AIR], % 10 - BIRD, BUTTERFLY, OWL, DRAGON, FLAMEINGO
    ["Stormy Axe", 1.4, T_AIR], % TREE, BAT, OWL, BEAR
    ["Typhoon Bullet", 1.8, T_AIR], % OCTOPUS, BUTTERFLY
    % Stone
    ["Meteor Fall", 2.8, T_STONE], % STONE, WHALE, PYRAMID
    ["Earth Impact", 1.1, T_STONE], % MUSHROOM, HANDGRANADE
    ["Rockslide", 1.2, T_STONE], % 15 - PYRAMID, SPIDER FAMILY
    ["Gravity Blade", 1.5, T_STONE], % STONE, BEAR
    ["Tree Knock", 1.7, T_STONE], % TREE, BEEHIVE
    ["Skeletal Scratch", 1.2, T_STONE], % REAPER
    ["Cracking Peace", 0.8, T_STONE], % SNAIL
    % Grass
    ["Reducing Root", 2.0, T_GRASS], % 20 - TREE, COFFEE
    ["Doubling Drain", 1.3, T_GRASS], % BAT, ANT, BEEHIVE, COBRA, SPIDER FAMILY
    ["Arctic Branch", 2.7, T_GRASS], % MUSHROOM
    ["Lotus Cannon", 2.0, T_GRASS], % TULIP
    ["Leafs Kiss", 1.8, T_GRASS], % BUTTERFLY, ANT, SNAIL
    ["Freezing Bark", 0.8, T_GRASS], % 25 - ANGEL, PUMPKIN FAMILY
    % Ghost
    ["Phantom Stomp", 1.4, T_GHOST], % PYRAMID, PUMPKIN FAMILY
    ["Ghost Fist", 1.6, T_GHOST], % MUSHROOM
    ["Spirit Blast", 1.8, T_GHOST], % JELLYFISH, OWL, MAGICIAN
    ["Hungry Mind", 3.0, T_GHOST], % REAPER, ANGEL
    ["Vampiric Drain", 2.4, T_GHOST], % 30 - BAT, COBRA
    ["Hells Ambush", 2.3, T_GHOST], % ANT, PUMPKIN FAMILY, CANDLE
    ["Demonic Blood", 1.8, T_GHOST], % SPIDER FAMILY
    % Fluff
    ["Breaking Cuddle", 2.0, T_FLUFF], % SHEEP, ANGEL, BEAR
    ["Sneaking Blow", 0.8, T_FLUFF], % OWL
    ["Heavens Hit", 1.4, T_FLUFF], % 35 - DUCK, SHEEP, FLAMEINGO
    ["Summer Dance", 0.6, T_FLUFF], % WHALE, BUTTERFLY, TULIP
    ["Violence Void", 2.0, T_FLUFF], % SHEEP, SNAIL
    ["Cloud Fall", 1.9, T_FLUFF], % BIRD
    % Fire
    ["Flaming Burst", 0.8, T_FIRE], % STONE, PYRAMID, DRAGON, HANDGRANADE
    ["Venom Heat", 0.9, T_FIRE], % 40 - TREE, COBRA
    ["Poison Edge", 0.5, T_FIRE], % OCTOPUS, ANT, MUSHROOM
    ["Hot Retribution", 1.0, T_FIRE], % REAPER, BEAR, COFFEE
    ["Radiating Charge", 0.6, T_FIRE], % SHEEP, FLAMEINGO
    ["Magic Teardrop", 2.0, T_FIRE], % DUCK, MAGICIAN
    ["Boiling Rage", 1.7, T_FIRE], % 45 - BEEHIVE, COBRA, SPIDER FAMILY, DRAGON
    ["Forbidden Light", 1.3, T_FIRE], % JELLYFISH, PUMPKIN FAMILY, CANDLE
    ["Ash Whip", 1.6, T_FIRE], % TULIP, FLAMEINGO
    ["Glowing Flash", 0.8, T_FIRE], % ANGEL, CANDLE, HANDGRANADE
    ["Nova Bullet", 4.0, T_FIRE], % DRAGON
    ["Dual Explosion", 3.0, T_FIRE] % 50 - HANDGRANADE
);

const ITEM_LIST = new Array(
    ["Empty", 0],
    ["Potion", 50],
    ["Capture", 30],
    ["Improve", 10],
    ["Weaken", 10],
    ["lalala", 0]
);

const EXP_TABLE = [];

% Color data
const COLORS = new Array(
    %[ "RGB", 0.843, 0.078, 0.058 ],
    %[ "RGB", 0.203, 0.603, 0.054 ],
    %[ "RGB", 0.078, 0.305, 0.560 ]
);

%%%%%%%%%%
% Helper %
%%%%%%%%%%
/**
 * Returns a random number between 0 and the param.
 * @param {Number} max The upperbound
 */
function getRandomInt(max) {
    return Math.floor(Math.random() * max);
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Initialisation and Restart %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
/**
 * Initialise the default game state.
 */
function initialise() {
    % Init the GUI
    initialiseButtons();

    updateButtontxt();

    % Init exp table
    for (var i = 1; i < 101; i++) {
        EXP_TABLE.push(START_EXP + 250 * i * (i + 1));
    }

    % Initialise the player and enemy creature
    curCreatureIdx = 0;
    curPlayerCreatures[curCreatureIdx] = getCreature(MIN_LVL + 10);
    curEnemy = getEnemy();

    % Initialise the player items
    curPlayerItems[0] = 2;

    updateEnemyTxt();
    updatePlayerTxt();

    fill();
    drawAll();
}

/**
 * Initialise all buttons from the GUI.
 * For example add callbacks and set the correct colors.
 */
function initialiseButtons() {
    % Disables the rectangle around a button after the click
    app.focusRect = false;

    % Assign each button the coresponding function
    this.getField("restart").setAction("MouseUp", "restart();");

    this.getField("button1").setAction("MouseUp", "processInput(1);");
    this.getField("button1txt").setAction("MouseUp", "processInput(1);");
    this.getField("button2").setAction("MouseUp", "processInput(2);");
    this.getField("button2txt").setAction("MouseUp", "processInput(2);");
    this.getField("button3").setAction("MouseUp", "processInput(3);");
    this.getField("button3txt").setAction("MouseUp", "processInput(3);");
    this.getField("button4").setAction("MouseUp", "processInput(4);");
    this.getField("button4txt").setAction("MouseUp", "processInput(4);");

    this.getField("back").setAction("MouseUp", "processInput(0);");

    % Adjust text size and font
    var cell;
    for (var m = 0; m < FIELD_HEIGHT; m++) {
        cell = this.getField("player" + m);
        cell.textSize = SCREEN_TEXT_WIDTH / FIELD_WIDTH;
        cell.textFont = font.Cour;
        %cell.alignment = "center";

        cell = this.getField("enemy" + m);
        cell.textSize = SCREEN_TEXT_WIDTH / FIELD_WIDTH;
        cell.textFont = font.Cour;
        %cell.alignment = "center";
    }

    % Info field setup
    this.getField("info").fillColor = color.transparent;
    this.getField("info").borderColor = color.transparent;

    % Tooltip setup
    this.getField("tooltipbtn").setAction("MouseDown", "tooltip(true);");
    this.getField("tooltipbtn").setAction("MouseUp", "tooltip(false);");
    this.getField("tooltipbtn").highlight="none";

    printInfoText("Initialised the game. Beat the current enemy creature.");
}

/**
 * Restart the game and clear everything
 */
function restart() {
    gameover = false;
    gamestate = MENU;
    turn = PLAYER;

    % Initialise the player and enemy creature
    curCreatureIdx = 0;
    curPlayerCreatures[curCreatureIdx] = getCreature(MIN_LVL);
    curEnemy = getEnemy();

    % Initialise the player items
    curPlayerItems[0] = 2;

    % Update GUI
    updateButtontxt();
    updateEnemyTxt();
    updatePlayerTxt();
    fill();
    drawAll();
    printInfoText("Restarted the game!");
}

/**
 * Enable or disable the tooltip
 *
 * @param {Boolean} on Enable or disable tooltip
 */
function tooltip(on) {
    if (on) {
        % Move the tooltip field to the center of the screen
        % and adjust the size so the text can be displayed
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.hidden = false;
        field.value = GAME_DESC;

        field.multiline = true;
        field.textSize = 16;
        field.fillColor = color.gray;
        % height 842, width 596
        % upper-left x, upper-left y, lower-right x and lower-right y
        field.rect = [128, 601, 468, 401];

        field.delay = false;
    } else {
        % Remove the field such that it is not visible
        var field = this.getField("tooltiptxt");
        field.delay = true;
        field.hidden = true;
        field.value = "";

        field.multiline = false;
        field.fillColor = color.gray;
        field.rect = [0, 0, 0, 0];

        field.delay = false;
    }
}

%%%%%%%%%%%%%
% Gamelogic %
%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%
% Player actions %
%%%%%%%%%%%%%%%%%%
/**
 * If a menu button is pressed check which action needs to be taken.
 * This depends on the current gamestate.
 * If the enemy did not make a move, the input is ignored.
 * @param {Number} button The index of which button was pressed
 */
function processInput(button) {
    this.getField("tooltiptxt").setFocus();

    if (gameover) {
        return;
    }

    if (animationProgress != FIELD_WIDTH) {
        printInfoText("Wait for animation!");
        return;
    }

    if (turn != PLAYER) {
        printInfoText("Wait your turn!");
        return;
    }

    % If the menu was active the possible actions need to be shown
    if (gamestate == MENU) {
        if (button == RUN) {
            run();
        } else {
            gamestate = button;
        }
    } else {
        % The back button was pressed, only switch to main menu
        if (button == MENU) {
            if (gamestate == REPLACE) {
                printInfoText("Did not capture creature!");
            } else if (gamestate == HARD_CHANGE) {
                printInfoText("You NEED to select a new creature!");
                return;
            }
            gamestate = MENU;
        }
        % If an action was selected run it and reset the gamestate
        else if (gamestate == FIGHT) {
            attack(button);
            gamestate = MENU;
        } else if (gamestate == CHANGE) {
            change(button);
            gamestate = MENU;
        } else if (gamestate == REPLACE) {
            replace(button);
            gamestate = MENU;
        } else if (gamestate == ITEMS) {
            gamestate = items(button);
        } else if (gamestate == HARD_CHANGE) {
            gamestate = hardChange(button);
        }
    }
    updateButtontxt();
}

/**
 * With this action the player indicates that he does not want to
 * fight the current enemy. Therefore he flees and gets a new enemy.
 */
function run() {
    curEnemy = getEnemy();
    drawEnemy();
    updateEnemyTxt();
    printInfoText("You ran from your enemy. Your new enemy is: " + curEnemy[NAME] + ".");
    % The player creature loses one lvl
    var creature = curPlayerCreatures[curCreatureIdx];
    if (creature[LVL] > MIN_LVL) {
        addInfoText(" " + creature[NAME] + " loses one level.");
        % Level down to discourage the player from running away from a fight
        creature[LVL]--;
        creature[MAX_HP] -= Math.ceil(creature[HP_GAIN]);
        creature[CUR_HP] = Math.min(creature[CUR_HP], creature[MAX_HP]);
        updatePlayerTxt();
    }
}

/**
 * This action runs the selected attack on the enemy creature.
 * For this the enemy hp are reduced by the damage from the arrack.
 * If the enemy is beaten, the player creature gets xp and has the
 * chance of leveling up.
 * This actions switches the turn to the enemy.
 * @ param {Number} idx The index of the attack selected.
 */
function attack(idx) {
    % Access the attack
    var curCreature = curPlayerCreatures[curCreatureIdx];
    var attacks = curCreature[ATKS];
    var attack = ATTACK_LIST[attacks[idx - 1]];

    % Calculate dmg
    var dmg = inflictDMG(curCreature, curEnemy, attack);

    % If the enemy is beaten add xp and lvl up if needed
    if (curEnemy[CUR_HP] <= 0) {
        curEnemy[CUR_HP] = 0;

        var exp = addEXP(curEnemy, curCreature);
        var lvlup = checkLvlUp(curCreature);
        if (lvlup) {
            updatePlayerTxt();
            printInfoText(curCreature[NAME] + " has slayn " + curEnemy[NAME] + " and leveled up.");
        } else {
            printInfoText(curCreature[NAME] + " has slayn " + curEnemy[NAME] +
                " and got " + exp + " experience.");
        }
    } else {
         printInfoText(curCreature[NAME] + " attacked with " + attack[NAME] + "! "
            + curEnemy[NAME] + " took " + dmg + " damage.");
    }

    updateEnemyTxt();

    % TODO
    attackAnimation(attack[TYPE]);

    % Enemy turn
    turn = ENEMY;
    turnInterval = app.setInterval("enemyTurn()", ENEMY_RESPONSE_TIME);
}

/**
 * Select one creature from your creature list as a substitute for
 * the current creature. Does only work if there is an other creature
 * then the current one.
 * This actions switches the turn to the enemy if a switch is made.
 * @param {Number} idx The index of the new creature.
 */
function change(idx) {
    var creature = curPlayerCreatures[idx - 1];
    var oldName = curPlayerCreatures[curCreatureIdx][NAME];

    % If there is no creature or the same one is selected the swap can not be done
    if (creature[NAME] == "Empty" || curCreatureIdx == idx - 1) {
        printInfoText("Creature was not switched.");
        return;
    }

    curCreatureIdx = idx - 1;

    printInfoText("You switched from " + oldName + " to " + creature[NAME] + ".");
    updatePlayerTxt();
    drawPlayer();

    % Enemy turn
    turn = ENEMY;
    turnInterval = app.setInterval("enemyTurn()", ENEMY_RESPONSE_TIME);
}

function hardChange(idx) {
    if (curPlayerCreatures[idx - 1][NAME] == "Empty") {
        printInfoText("You NEED to select a new creature!");
        return HARD_CHANGE;
    } else {
        change(idx);
        return MENU;
    }
}

/**
 * Selects the chosen item from the backpack and applies its affect.
 * This actions switches the turn to the enemy if a item is used (unless it is a catcher).
 * @param {Number} idx The index of the chosen item.
 */
function items(idx) {
    var item = ITEM_LIST[curPlayerItems[idx - 1]];
    % If no item at that slot
    if (item[NAME] == "Empty") {
        printInfoText("No item was used.");
        return MENU;
    }

    printInfoText("You used " + item[NAME] + ".");
    % Apply the selected item
    if (item[NAME] == "Capture") {
        return catchCreature();
    }
    if (item[NAME] == "Improve") {
    } else if (item[NAME] == "Weaken") {
    } else if (item[NAME] == "Potion") {
    } else if (item[NAME] == "lalala") {
    }

    % Enemy turn
    turn = ENEMY;
    turnInterval = app.setInterval("enemyTurn()", ENEMY_RESPONSE_TIME);
    return MENU;
}

/**
 * Add the current enemy creature to your own creature list.
 * If there are already four creature select one to replace it.
 */
function catchCreature() {
    % Search for an emty space
    for (var i = 0; i < curPlayerCreatures.length; i++) {
        if (curPlayerCreatures[i][NAME] == "Empty") {
            curPlayerCreatures[i] = curEnemy;

            % Get new enemy
            curEnemy = getEnemy();
            updateEnemyTxt();
            drawEnemy();
            addInfoText(" Your new enemy is: " + curEnemy[NAME] + ".");

            return MENU;
        }
    }

    % Replace creature because there is no spot left
    updateButtontxt();
    addInfoText(" You have no free slot, select one creature to be replaced!");
    return REPLACE;
}

/**
 * Replaces the given creature with the enemy creature.
 * It is possible to replace the currently active player creature.
 * @param {Number} idx The index of the player creature.
 */
function replace(idx) {
    curPlayerCreatures[idx - 1] = curEnemy;
    if (idx - 1 == curCreatureIdx) {
        updatePlayerTxt();
        drawPlayer();
    }

    % Get new enemy
    curEnemy = getEnemy();
    updateEnemyTxt();
    drawEnemy();
    printInfoText("Creature catched! Your new enemy is: " + curEnemy[NAME] + ".");
}

%%%%%%%%%%%%%%%%%
% Enemy actions %
%%%%%%%%%%%%%%%%%
/**
 * Calculates the enemys turn. If the current creature has
 * less or equal to zero health a new enemy creature is spawned
 * and the turn shifts back to the player.
 * Otherwise an attack onto the player occurs.
 * If the player creature is beaten, the player needs to chose a new one,
 * unless he has none left then he lost the game.
 */
function enemyTurn() {
    % Switch turn
    turn = PLAYER;
    % Clear the interval, since the enemy should only attack once
    app.clearInterval(turnInterval);

    % If the enemy is dead he is not able to attack and need to be substituted
    if (curEnemy[CUR_HP] == 0) {
        curEnemy = getEnemy();
        drawEnemy();
        updateEnemyTxt();
        printInfoText("Your new enemy is: " + curEnemy[NAME]);
        return;
    }

    % Get attack data
    var attacks = curEnemy[ATKS];
    var attackIdx = getRandomInt(attacks.length);
    var attack = ATTACK_LIST[attacks[attackIdx]];

    var creature = curPlayerCreatures[curCreatureIdx];
    var dmg = inflictDMG(curEnemy, creature, attack);
    % If the player creature is dead remove it from the player creatures
    if (creature[CUR_HP] <= 0) {
        creature[CUR_HP] = 0;
        updatePlayerTxt();

        curPlayerCreatures[curCreatureIdx] = ["Empty"];
        % If the player has no creatures left the game is over
        if (noCreatureLeft()) {
            gameover = true;
            printInfoText("No Creatures left, game over!");
        } else {
            gamestate = HARD_CHANGE;
            updateButtontxt();
            printInfoText("Your creature has no health left, please select a new creature.");
        }
    } else {
        printInfoText("You got attacked with " + attack[NAME] + "! "
            + creature[NAME] + " took " + dmg + " damage.");
        updatePlayerTxt();
    }
}

%%%%%%%%%%%%%%%%%%%%%%%
% Helper %
%%%%%%%%%%%%%%%%%%%%%%%
/**
 * Check if the player has no creatures left.
 */
function noCreatureLeft() {
    for (var i = 0; i < curPlayerCreatures.length; i++) {
        if (curPlayerCreatures[i][NAME] != "Empty") {
            return false;
        }
    }
    return true;
}

/**
 * Check if the player creature has leveled up, by comparing
 * its current experience to the needed xp of the next lvl.
 * @param {Array} creature The data of the creature.
 */
function checkLvlUp(creature) {
    if (creature[CUR_EXP] > EXP_TABLE[creature[LVL] - MIN_LVL]) {
        creature[LVL]++;
        % Increase health after lvl up
        creature[MAX_HP] += Math.ceil(creature[HP_GAIN]);
        creature[CUR_HP] += Math.ceil(creature[HP_GAIN]);
        return true;
    }
    return false;
}

/**
 * Add experience points to the given creature.
 * The amount depends on the beaten enemy.
 * @param {Array} The data of the target creature.
 * @param {Array} The data of the source creature.
 */
function addEXP(source, target) {
    var exp = source[EXP_GAIN] * source[LVL];
    target[CUR_EXP] += exp;
    return exp;
}

/**
 * Apply damage to the target creature depending on
 * the attack and the source creature lvl.
 * Takes also into account the type of both creatures.
 */
function inflictDMG(source, target, attack) {
    var creatureMul = DMG_MATRIX[source[TYPE]][target[TYPE]];
    var attackMul = DMG_MATRIX[attack[TYPE]][target[TYPE]];
    var dmg = Math.ceil(attack[DMG] * source[LVL] * creatureMul * attackMul);
    target[CUR_HP] -= dmg;
    return dmg;
}

%%%%%%%%%%%%
% Spawning %
%%%%%%%%%%%%
/**
 * Create a new enemy with level depending on the currently available
 * player creatures. Allows for enemys that continously pose a threat to
 * the player and allow him to level up.
 */
function getEnemy() {
    % Calculate the level depending on the reserve creatures
    var curLvl = 0;
    for (var i = 0; i < curPlayerCreatures.length; i++) {
        if (curPlayerCreatures[i][NAME] != "Empty") {
            curLvl += curPlayerCreatures[i][LVL];
        }
    }
    curLvl /= curPlayerCreatures.length;

    % Variance
    var offset = getRandomInt(MIN_LVL * 2);
    curLvl = curLvl + (MIN_LVL - offset);
    curLvl = Math.max(MIN_LVL, Math.floor(curLvl));

    return getCreature(curLvl);
}

/**
 * Get a random creature with the given level.
 * @param {Number} curLvl The level of the creature.
 */
function getCreature(curLvl) {
    var creature = getRandomInt(CREATURE_LIST.length);

    var hp = Math.ceil(CREATURE_LIST[creature][HP_GAIN] * curLvl);

    % TODO dont copy everything, have an id to the original list and
    % extra attributes for the instance variables
    return [
        CREATURE_LIST[creature][NAME],
        CREATURE_LIST[creature][HP_GAIN],
        CREATURE_LIST[creature][TYPE],
        CREATURE_LIST[creature][ATKS],
        CREATURE_LIST[creature][EXP_GAIN],
        CREATURE_LIST[creature][IMAGE],
        hp, % MAX_HP
        hp, % CUR_HP
        curLvl, % LVL
        START_EXP % CUR_EXP
    ];
}

%%%%%%%%%%%%%%%%%%%%%%%
% Information updates %
%%%%%%%%%%%%%%%%%%%%%%%
/**
 * Update the text of all four gui buttons depending on the
 * current menu state.
 */
function updateButtontxt() {
    if (gamestate == MENU) {
        this.getField("button1txt").value = "Fight";
        this.getField("button2txt").value = "Change";
        this.getField("button3txt").value = "Item";
        this.getField("button4txt").value = "Run";
    } else if (gamestate == FIGHT) {
        % Show all attacks of the current creature
        var attacks = curPlayerCreatures[curCreatureIdx][ATKS];
        for (var i = 0; i < 4; i++) {
            var attack = ATTACK_LIST[attacks[i]];
            var btn = "button" + (i + 1) + "txt";
            var dmgTxt = " (Does " + attack[DMG] + " "
                + TYPE_STRINGS[attack[TYPE]] + " dmg per lvl)";
            this.getField(btn).value = attack[NAME] + dmgTxt;
        }
    } else if (gamestate == CHANGE || gamestate == HARD_CHANGE || gamestate == REPLACE) {
        % Show all player creatures with lvl if available
        for (var i = 0; i < 4; i++) {
            var btn = "button" + (i + 1) + "txt";
            var name = curPlayerCreatures[i][NAME];
            if (name != "Empty") {
                name += " (Lvl " + curPlayerCreatures[i][LVL] + ")";
            }
            this.getField(btn).value = name;
        }
    } else if (gamestate == ITEMS) {
        this.getField("button1txt").value = ITEM_LIST[curPlayerItems[0]][NAME];
        this.getField("button2txt").value = ITEM_LIST[curPlayerItems[1]][NAME];
        this.getField("button3txt").value = ITEM_LIST[curPlayerItems[2]][NAME];
        this.getField("button4txt").value = ITEM_LIST[curPlayerItems[3]][NAME];
    }
}

/**
 * Updates the enemy information displayed by the gui.
 */
function updateEnemyTxt() {
    this.getField("enemyname").value = curEnemy[NAME];
    this.getField("enemystatus").value =
        "Type: " + TYPE_STRINGS[curEnemy[TYPE]] + " - Level: " + curEnemy[LVL];
    this.getField("enemyhp").value = "HP: " + curEnemy[CUR_HP] + " of " + curEnemy[MAX_HP];
}

/**
 * Updates the player information displayed by the gui.
 */
function updatePlayerTxt() {
    var creature = curPlayerCreatures[curCreatureIdx];
    this.getField("playername").value = creature[NAME];
    this.getField("playerstatus").value =
        "Type: " + TYPE_STRINGS[creature[TYPE]] + " - Level: " + creature[LVL];
    this.getField("playerhp").value = "HP: " + creature[CUR_HP] + " of " + creature[MAX_HP];
}

%%%%%%%%%%%%%%%%%%%%%
% Animation %
%%%%%%%%%%%%%%%%%%%%%
function frameAll() {
    frame(["player", "enemy"]);
}

function framePlayer() {
    frame(["player"]);
}

function frameEnemy() {
    frame(["enemy"]);
}

function frame(owners) {
    if (animationProgress < 0) {
        app.clearInterval(changeAnimationInterval);
        animationProgress = FIELD_WIDTH;
        return;
    }

    for (var idx = 0; idx < owners.length; idx++) {
        for (var m = 0; m < FIELD_HEIGHT; m++) {
            shiftFieldLeft(owners[idx] + m);
        }
    }

    animationProgress--;
}

/**
 * Adds the current creature of the given owner to the corresponding
 * field. The strings are simply concatenated line by line to the current
 * field value.
 * @param {Number} owner The owner, being either the player or the enemy.
 */
function addCurCreature(owner) {
    var creature;
    if (owner == PLAYER) {
        creature = curPlayerCreatures[curCreatureIdx];
    } else {
        creature = curEnemy;
    }

    % Calculate the needed padding to center the current creature.
    % Uses the complete width and the amount of cells occupied by the creature string.
    var paddingSize = FIELD_WIDTH - creature[IMAGE][0].length + 1;
    var paddingSizeLeft = Math.floor(paddingSize * 0.5);
    var paddingSizeRight = Math.ceil(paddingSize * 0.5);
    % Create padding string
    var paddingLeft = "";
    var paddingRight = "";
    for (var n = 0; n < paddingSizeLeft; n++) {
        paddingLeft += PADDING_SYMB;
    }
    for (var n = 0; n < paddingSizeRight; n++) {
        paddingRight += PADDING_SYMB;
    }

    % Used to center the creature vertically (m)
    var startM = Math.floor(CENTER_M - creature[IMAGE].length * 0.5);

    % Add the string of the new creature
    var valueString = "";
    for (var m = 0; m < FIELD_HEIGHT; m++) {
        % Centering the creature and add padding top and bottom
        if (startM <= m && m < startM + creature[IMAGE].length) {
            var lineString = creature[IMAGE][m - startM];
            if (lineString.length > FIELD_WIDTH) {
                lineString = lineString.substring(0, FIELD_WIDTH + 1);
            }
            valueString = paddingLeft + lineString + paddingRight;
        } else {
            valueString = EMPTY_LINE;
        }
        % Add to the field belonging to the owner
        if (owner == PLAYER) {
            addToField("player" + m, valueString);
        } else {
            addToField("enemy" + m, valueString);
        }
    }
}

const ENEMY_TOP_RECT = this.getField("enemy0").rect;
const ENEMY_BOT_RECT = this.getField("enemy" + (FIELD_HEIGHT - 1)).rect;

const R = ENEMY_TOP_RECT[2];
const L = ENEMY_TOP_RECT[0];
const T = ENEMY_TOP_RECT[1];
const B = ENEMY_BOT_RECT[3];

const FIELD_HEIGHT_H = (T - B) / 2.0;
%const SIZE_H = (FIELD_HEIGHT_H / FIELD_HEIGHT) * 2.0;
const FIELD_WIDTH_H = (R - L) / 2.0;

const CENTER_P = [163, 456];
const CENTER_E = [L + FIELD_WIDTH_H, B + FIELD_HEIGHT_H];
%const START = [CENTER_P[0] - SIZE_H, CENTER_P[1] + SIZE_H, CENTER_P[0] + SIZE_H, CENTER_P[1] - SIZE_H];
%const END = [CENTER_E[0] - SIZE_H, CENTER_E[1] + SIZE_H, CENTER_E[0] + SIZE_H, CENTER_E[1] - SIZE_H];

const ATK_DURATION = 15;

const DEAD = -1;

const STATE = 0;
const POS = 1;
const SYMB = 2;
const ROTATION = 3;
const MASS = 4;
const MOMENTUM = 5;
const WIDTH = 6;
const HEIGHT = 7;

const X = 0;
const Y = 1;

var particles = Array.apply(null, Array(ATK_ANIM_CELLS)).map(_ => [
    DEAD, [0, 0],
    0, 0,
    2, [0, 0],
    FIELD_WIDTH_H / FIELD_HEIGHT, FIELD_HEIGHT_H / FIELD_HEIGHT
]);

var particleSys = {
    frameTime: 75,
    iterationCount: ATK_DURATION - 1,
    iterationCur: 0,
    aliveParticles: 0,
    alignment: "center",
    particleCount: FIELD_WIDTH,
    particleSymbols: ["X"],
    particleLifetime: ATK_DURATION - 1,
    particleMultiline: false,
    particleBold: false,
    gravity: [0, -9.81],
    force: [0, 5],
    energyReduction: 0.45,
    % FUNCTIONS
    emit: function(p) {
        particles[p][STATE]++;
        this.aliveParticles++;
        initParticleField(p);
        return true;
    },
    remove: function(p) {
        hideParticleField(p);
        particles[p][STATE] = DEAD;
        this.aliveParticles--;
    }
};

/**
 * Very similar to an implementation that can be found here:
 * https://gamedev.stackexchange.com/questions/10277/equation-for-bouncing-graph
 */
function applyGravityToParticle(p) {
    const h = particles[p][HEIGHT];
    const g = particleSys.gravity;
    const f = particleSys.force;
    const m = particles[p][MASS];
    var pos = particles[p][POS];
    var mom = particles[p][MOMENTUM];

    % Momentum += gravity + force
    mom = [mom[X] + g[X] + f[X], mom[Y] + g[Y] + f[Y]];
    % Velocity = momentum / mass
    var v = [mom[X] / m, mom[Y] / m];
    % Position += velocity
    pos = [pos[X] + v[X], pos[Y] + v[Y]];

    % If position is at floor & momentum heading downward
    if (pos[Y] < B + h && mom[Y] < 0) {
        pos[Y] = B + h;
        % Bouncing off direction
        var collisionNormal = [0, 1];
        var dot = mom[X] * collisionNormal[X] + mom[Y] * collisionNormal[Y];
        % Reflect
        mom = [mom[X] - collisionNormal[X] * 2 * dot, mom[Y] - collisionNormal[Y] * 2 * dot];
        % Energy loss from bounce.
        mom = [mom[X] * particleSys.energyReduction, mom[Y] * particleSys.energyReduction];
    }

    particles[p][MOMENTUM] = mom;
    return pos;
}

function attackAnimation(type) {
    if (type == T_WATER && false) {
        waterParticles();
    % } else if (type == T_AIR) {
    } else if (type == T_STONE && false) {
        stoneParticles();
    %} else if (type == T_GRASS) {
    } else if (type == T_GHOST) {
        ghostParticles();
    % } else if (type == T_FLUFF) {
    } else {
        % T_FIRE
        fireParticles();
    }

    % Shoot move function
    % particleSys.move = function(l, p) {
    %     for (var j = 0; j < particles[p][POS].length; j++) {
    %         particles[p][POS][j] = START[j] * (1.0 - l) + END[j] * l;
    %     }
    % };

    attackInterval = app.setInterval("processParticles()", particleSys.frameTime);
}

function waterParticles() {
    particleSys.frameTime = 15;
    particleSys.iterationCount = (ATK_DURATION - 1) * 2;
    particleSys.particleLifetime = (ATK_DURATION - 1) * 4;
    particleSys.particleSymbols = ["(", " )", "(", "(", "(", " )", " )", "(", " )", " )", ""];
    particleSys.particleBold = true;
    particleSys.particleCount = FIELD_WIDTH / 2.0 + 1;

    var particle = this.getField("atkanim" + 0);
    particle.fillColor = color.white;

    particleSys.emit = function(p) {
        if (p == 0) {
            particles[p][STATE]++;
            particles[p][POS] = [CENTER_E[X], 0];
            particles[p][SYMB] = particleSys.particleSymbols.length - 1;
            particles[p][WIDTH] = FIELD_WIDTH_H;

            this.aliveParticles++;

            initParticleField(p);

            return true;
        }

        %particles[p][HEIGHT] = particles[p][WIDTH];
        const w = particles[p][WIDTH];
        var xPos = L + w + (p - 1) * w * 2.0;

        particles[p][STATE]++;
        particles[p][POS] = [xPos, 0];
        particles[p][SYMB] = p \% (particleSys.particleSymbols.length - 1);
        particles[p][ROTATION] = 90;
        this.aliveParticles++;

        initParticleField(p);
        return true;
    };

    particleSys.move = function(l, p) {
        % Height and pos of the top line
        const h = particles[1][HEIGHT];
        const top = (B + FIELD_HEIGHT_H * 2.0 * 0.75 - h);
        var yPos = (1.0 - l) * (B + h + 1) + l * top;

        if (p == 0) {
            particles[p][HEIGHT] = (yPos - h * 0.5 - B) * 0.5;
            particles[p][POS][Y] = B + particles[p][HEIGHT];
            initParticleField(p);
            return;
        }

        particles[p][POS][Y] = yPos;
        particles[p][SYMB] = (particles[p][SYMB] + 1) \% (particleSys.particleSymbols.length - 1);
        % TODO dont use init here
        initParticleField(p);
    };
}

function stoneParticles() {
    particleSys.iterationCount = (ATK_DURATION - 1) * 2;
    particleSys.particleLifetime = (ATK_DURATION - 1) * 2;
    particleSys.particleSymbols = ["[##]\n [##]", "\n ####", "\n ## #", "\n #  #", "\n #   #", "\n #    #"];
    particleSys.particleMultiline = true;
    particleSys.particleCount = 3;

    particleSys.emit = function(p) {
        % if (getRandomInt(100) > 1) {
        %     return false;
        % }
        %var xPos = (L + particles[p][WIDTH]) + getRandomInt((FIELD_WIDTH_H - particles[p][WIDTH]) * 2.0);

        % Create a particle with same width as height
        particles[p][WIDTH] = (FIELD_HEIGHT_H / FIELD_HEIGHT) * 2.0;
        particles[p][HEIGHT] = (FIELD_HEIGHT_H / FIELD_HEIGHT) * 2.0;

        const s = (L + particles[p][WIDTH]);
        const w = (FIELD_WIDTH_H - particles[p][WIDTH]) * 2.0;
        const pos = [
            [s + w * 0.25, T - particles[p][HEIGHT]],
            [s + w * 0.5, T],
            [s + w * 0.75, T - particles[p][HEIGHT]]
        ];
        const mom = [
            [-2, 2],
            [0, 2],
            [2, 2]
        ]

        particles[p][STATE]++;
        particles[p][POS] = pos[p \% particleSys.particleCount];
        %particles[p][SYMB] = getRandomInt(particleSys.particleSymbols.length);
        particles[p][SYMB] = 0;
        particles[p][MASS] = 2;
        particles[p][MOMENTUM] = mom[p \% particleSys.particleCount];

        this.aliveParticles++;

        initParticleField(p);
        return true;
    };

    % Falling stones move function
    particleSys.move = function(l, p) {
        % var yPos = (1.0 - l) * (T - particles[p][HEIGHT]) + l * (B + particles[p][HEIGHT] + 1);
        particles[p][POS] = applyGravityToParticle(p);

        if (particles[p][SYMB] > 0 && particles[p][STATE] \% 2 == 0 && particles[p][SYMB] < particleSys.particleSymbols.length - 1) {
            particles[p][SYMB]++;
            initParticleField(p); % TODO
        }

        if (particles[p][POS][Y] <= B + particles[p][HEIGHT] && particles[p][SYMB] == 0) {
            particles[p][SYMB] = 1;
            particles[p][MASS] = 1;
            initParticleField(p); % TODO
        }
    };
}

function ghostParticles() {
    % Circular move function
    particleSys.move = function(l, p) {
        const R_X = FIELD_WIDTH_H;
        const R_Y = FIELD_WIDTH_H;
        const ANGLE = (Math.PI * 2.0) / particles.length;

        const offsetX = R_X * Math.cos(p * ANGLE + l * Math.PI * 2.0);
        const offsetY = R_Y * Math.sin(p * ANGLE + l * Math.PI * 2.0);

        particles[p][POS][X] = CENTER_E[X] + (1.0 - l) * offsetX;
        particles[p][POS][Y] = CENTER_E[Y] + (1.0 - l) * offsetY;
    }
}

function fireParticles() {
    particleSys.frameTime = 250;
    particleSys.iterationCount = (ATK_DURATION - 1) * 2;
    particleSys.particleLifetime = (ATK_DURATION - 1) * 2;
    particleSys.alignment = "left";

    % https://ascii.co.uk/art/fire
    % Prevent bracket issues
    "((((((((((((";
    particleSys.particleSymbols = [
        "       (                           ",
        "       )                 '    .    ",
        "         *          )     .        ",
        "   ( .    ) .     ('  )  (    )  * ",
        "    .*)  (  )   ,  )  ,    )  (.   ",
        " ).   ( . :(   )  ( , ')   .'  ),( ",
        "(_,)  _), _) .(_, )  (, ) '_),.(' )",
        %
        "       ?            )    .         ",
        "       '          (           '    ",
        "        \"                 '        ",
        "      )  (  '      ) :    )   (    ",
        "  .  ' (   ) .   ' ( . ' (     )'  ",
        " ('    )  ' )  (   )   )   '   )(  ",
        "(#_)_ _),_ ) '(_: )  (* )_ _)*'(  )",
        %
        "       .           ?               ",
        "                  '           *    ",
        "         .                         ",
        "   ( *    )        )     (     :   ",
        "    ')   ( ) '    (  '  )      ('  ",
        " ('     ( '  . (   )   (   '   )(  ",
        "( _) __('#_)  ('_ )  ( .) __)*'(  )",
        %
        "                   .               ",
        "       :                           ",
        "    ,   (                (         ",
        "   ).     )    .   )  .   )    ( , ",
        "  . (   )  (      (      (  *    ) ",
        " (   )  '   )  (.  )    (      ( ) ",
        "(  )  _) : )' (  _(  ). )  _(#_(  )"
    ];
    ")))";

    %particleSys.particleBold = true;
    particleSys.particleCount = 7;

    particleSys.emit = function(p) {
        const h = particles[p][HEIGHT];
        var yPos = B + h + p * h * 2.0;
        var lines = particleSys.particleCount;
        var frames = particleSys.particleSymbols.length / lines;

        particles[p][STATE]++;
        particles[p][POS] = [CENTER_E[X], yPos];
        particles[p][SYMB] = (lines - p - 1) \% particleSys.particleSymbols.length;
        particles[p][WIDTH] = FIELD_WIDTH_H;
        this.aliveParticles++;

        initParticleField(p);
        return true;
    };

    particleSys.move = function(l, p) {
        var lines = particleSys.particleCount;
        var frames = particleSys.particleSymbols.length / lines;
        particles[p][SYMB] = (lines - p - 1) + lines * (particles[p][STATE] \% frames);
        % TODO dont use init here
        initParticleField(p);
    };
}

function processParticles() {
    var finished = particleSys.iterationCount < particleSys.iterationCur;
    if (finished && particleSys.aliveParticles == 0) {
        app.clearInterval(attackInterval);
        particleSys.iterationCur = 0;
        return;
    }

    for (var p = 0; p < Math.min(particles.length, particleSys.particleCount); p++) {
        if (!finished && particles[p][STATE] == DEAD) {
            if (!particleSys.emit(p)) {
                continue;
            }
        } else if (particleSys.particleLifetime < particles[p][STATE]) {
            particleSys.remove(p);
            continue;
        }

        var l = particles[p][STATE] / particleSys.particleLifetime;

        particleSys.move(l, p);
        moveParticleField(p);

        particles[p][STATE]++;
    }

    particleSys.iterationCur++;
}

function moveParticleField(p) {
    var particle = this.getField("atkanim" + p);

    const x = particles[p][POS][X];
    const y = particles[p][POS][Y];
    const w = particles[p][WIDTH];
    const h = particles[p][HEIGHT];
    var rect = [x - w, y + h, x + w, y - h];

    particle.rect = rect;
}

function initParticleField(p) {
    var particle = this.getField("atkanim" + p);
    particle.hidden = false;
    particle.textSize = (SCREEN_TEXT_WIDTH / FIELD_WIDTH) / 1.2;
    particle.textFont = font.Cour;
    particle.alignment = particleSys.alignment;
    particle.rotation = particles[p][ROTATION];

    var textIdx = particles[p][SYMB];

    if (particleSys.particleMultiline || particleSys.particleBold) {
        var spans = new Array();
        spans[0] = new Object();
        spans[0].text = particleSys.particleSymbols[textIdx];
        if (particleSys.particleBold) {
            spans[0].fontWeight = 700;
        }

        particle.richText = true;
        particle.richValue = spans;
    } else {
        particle.richText = false;
        particle.value = particleSys.particleSymbols[textIdx];
    }
}

function hideParticleField(p) {
            var particle = this.getField("atkanim" + p);
            particle.hidden = true;
}

function waterAnimation() {
    if (animationProgress2 < 0 && aliveParticles == 0) {
        app.clearInterval(attackInterval);
        animationProgress2 = ATK_DURATION;
        return;
    }

    var emitbool = ((animationProgress2 \% 3) == 0) && animationProgress2 > 0;

    %for (var i = 0; i < ATK_ANIM_CELLS; i++) {
    for (var p = 0; p < particles.length; p++) {
        if (particles[p] == DEAD) {
            if (emitbool) {
                emitbool = false;
                emit(p);
            } else {
                continue;
            }
        } else if (particles[p] == particleLifetime) {
            particles[p] = DEAD;
            aliveParticles--;
            var particle = this.getField("atkanim" + p);
            particle.hidden = true;
            continue;
        }

        var particle = this.getField("atkanim" + p);

        % height 842, width 596
        % upper-left x, upper-left y, lower-right x and lower-right y
        var l = particles[p] / particleLifetime;
        var pos = [0, 0, 0, 0];
        for (var j = 0; j < pos.length; j++) {
            pos[j] = END[j];%START[j] * (1.0 - l) + END[j] * l;
        }

        particle.rect = pos;
        particles[p]++;
    }
    animationProgress2--;
    printInfoText(animationProgress2);
}

function emit(p) {
    var particle = this.getField("atkanim" + p);
    particle.delay = true;
    particle.value = "w";
    particle.delay = false;

    particle.hidden = false;
    particles[p] = 0;
    aliveParticles++;
}

%%%%%%%%%%%%%%%%%%%%%
% Draw and coloring %
%%%%%%%%%%%%%%%%%%%%%
/**
 * Adds the next creature and starts an animated redraw for enemy and player.
 */
function drawAll() {
    addCurCreature(PLAYER);
    addCurCreature(ENEMY);
    changeAnimationInterval = app.setInterval("frameAll()", CHANGE_ANIMATION_SPEED);
}

/**
 * Adds the next creature and starts an animated redraw for the enemy.
 */
function drawEnemy() {
    addCurCreature(ENEMY);
    changeAnimationInterval = app.setInterval("frameEnemy()", CHANGE_ANIMATION_SPEED);
}

/**
 * Adds the next creature and starts an animated redraw for the player.
 */
function drawPlayer() {
    addCurCreature(PLAYER);
    changeAnimationInterval = app.setInterval("framePlayer()", CHANGE_ANIMATION_SPEED);
}

/**
 * Completely fills the enemy and the player fields with empty lines.
 */
function fill() {
    for (var m = 0; m < FIELD_HEIGHT; m++) {
        setField("enemy" + m, EMPTY_LINE);
        setField("player" + m, EMPTY_LINE);
    }
}

/**
 * Shift the value of the given field.
 *
 * @param {Number} id The id of the field.
 */
function shiftFieldLeft(id) {
    var cell = this.getField(id);
    cell.delay = true;
    cell.value = cell.value.substring(1);
    cell.delay = false;
}

/**
 * Set string of the given field.
 *
 * @param {Number} id The id of the field.
 * @param {String} value The value to set.
 */
function setField(id, value) {
    var cell = this.getField(id);
    cell.delay = true;
    cell.value = value;
    cell.delay = false;
}

/**
 * Add string to the given field.
 *
 * @param {Number} id The id of the field.
 * @param {String} value The value to add.
 */
function addToField(id, value) {
    var cell = this.getField(id);
    cell.delay = true;
    cell.value += value;
    cell.delay = false;
}

/**
 * Print information about the winner and the gamestate.
 */
function printInfoText(text) {
    var field = this.getField("info");
    field.delay = true;
    field.value = text;
    field.delay = false;
}

/**
 * Add information to the information-gui.
 */
function addInfoText(text) {
    var field = this.getField("info");
    field.delay = true;
    field.value += text;
    field.delay = false;
}

\end{insDLJS}

\OpenAction{/S /JavaScript /JS (initialise();)}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Dokument
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

    \begin{Form}

        % Header
        \begin{multicols}{2}
            % Title
            \section*{ASCIImon}
        \columnbreak
            % Tooltip object
            \begin{flushright}%
                \PushButton[name=tooltipbtn, bordercolor=white]{%
                    \begin{tcolorbox}[width=20pt, height=20pt, left=3pt, top=0pt]
                        \centering?\strut{}
                    \end{tcolorbox}%
                }
            \end{flushright}%
        \end{multicols}

        % Calculate the max width and height of a block
        \def\blocksizeH{\dimexpr (250 pt)/\fieldHeight \relax}
        \def\blocksizeW{\dimexpr (250 pt) \relax}

        \begin{multicols}{2}

            \begin{tcolorbox}%
                \TextField[name=enemyname, width=\linewidth, readonly=true]{}\newline

                \TextField[name=enemystatus, width=\linewidth, readonly=true]{}\newline

                \TextField[name=enemyhp, width=\linewidth, readonly=true]{}%
            \end{tcolorbox}%

            \vspace{2.5cm}

            \begin{center}
                \xintFor* #1 in {\xintSeq{0}{\fieldHeight-1}} \do {%
                    \TextField[%
                        width=\blocksizeW, height=\blocksizeH,%
                        bordercolor=white, name=player#1, readonly=true%
                    ]{}%
                    \\[0pt]%
                }%
            \end{center}

        \columnbreak%

            \begin{center}
                \xintFor* #1 in {\xintSeq{0}{\fieldHeight-1}} \do {%
                    \TextField[%
                        width=\blocksizeW, height=\blocksizeH,%
                        bordercolor=white, name=enemy#1, readonly=true%
                    ]{}%
                    \\[0pt]%
                }%
            \end{center}

            \vspace{2.5cm}

            \begin{tcolorbox}%
                \TextField[name=playername, width=\linewidth, readonly=true]{}\newline

                \TextField[name=playerstatus, width=\linewidth, readonly=true]{}\newline

                \TextField[name=playerhp, width=\linewidth, readonly=true]{}%
            \end{tcolorbox}%

        \end{multicols}

        %%%%%%%%%%%%%%%%%%%%%%%
        % Commandredifinition %
        % https://www.dickimaw-books.com/latex/admin/html/eforms.shtml
        %%%%%%%%%%%%%%%%%%%%%%%
        % \def\DefaultHeightofText{14pt}
        % \renewcommand*{\LayoutTextField}[2]{%
        %     \parbox[c][\DefaultHeightofText]{0.5\linewidth}{#1#2}%
        % }

        % \renewcommand*{\LayoutCheckField}[2]{#1 #2}
        % \renewcommand*{\DefaultWidthofCheckBox}{2ex}
        % \renewcommand*{\DefaultHeightofCheckBox}{2ex}
        % \renewcommand*{\LayoutCheckField}[2]{%
        %     \parbox[c][\DefaultHeightofCheckBox]{0.12\linewidth}{#1}\enspace%
        %     \parbox[c][\DefaultHeightofCheckBox]{\DefaultWidthofCheckBox}{#2}%
        % }

        % \renewcommand*{\DefaultWidthofChoiceMenu}{2.5ex}
        % \renewcommand*{\DefaultHeightofChoiceMenu}{2.04ex}

        %%%%%%%%%%%%%%%%
        % GUI elements %
        %%%%%%%%%%%%%%%%
        \begin{center}
            \begin{tcolorbox}
                \TextField[name=info, width=\linewidth, readonly=true]{}
            \end{tcolorbox}

            % Game related buttons
            \begin{tabularx}{\textwidth}{@{} *{2}{X} @{}}%
                \PushButton[name=button1, bordercolor=white, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        \TextField[name=button1txt, width=\linewidth, readonly=true]{}%
                        \strut
                    \end{tcolorbox}
                } &
                \PushButton[name=button2, bordercolor=white, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        \TextField[name=button2txt, width=\linewidth, readonly=true]{}%
                        \strut
                    \end{tcolorbox}
                }\\
                \PushButton[name=button3, bordercolor=white, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        \TextField[name=button3txt, width=\linewidth, readonly=true]{}%
                        \strut
                    \end{tcolorbox}
                } &
                \PushButton[name=button4, bordercolor=white, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        \TextField[name=button4txt, width=\linewidth, readonly=true]{}%
                        \strut
                    \end{tcolorbox}
                }\\
                \PushButton[name=back, bordercolor=white, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        Back\strut
                    \end{tcolorbox}
                } &
                \PushButton[name=restart, bordercolor=white, borderwidth=0]{
                    \begin{tcolorbox}
                        \centering
                        Restart game\strut
                    \end{tcolorbox}
                }
                \\
            \end{tabularx}
        \end{center}

        \xintFor* #1 in {\xintSeq{0}{\atkAnimCells-1}} \do {%
            \TextField[%
                width=1cm, height=1cm,%
                bordercolor=, backgroundcolor=, name=atkanim#1, readonly=true%
                %bordercolor=gray, name=atkanim#1, readonly=true%
            ]{}%
        }%

        \TextField[bordercolor=white, name=tooltiptxt, readonly=true, hidden]{}

    \end{Form}
\end{document}
