\documentclass[12pt, a4paper, footexclude, headexclude]{scrartcl}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[margin=0.5in]{geometry}

\usepackage[latin1]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[ngerman]{babel}
\usepackage{xcolor}
\usepackage[pdftex]{hyperref}
\usepackage{xinttools}

\usepackage{tcolorbox}
\setlength{\parindent}{0pt}

% Einbindung von Javascript ins PDF
\usepackage[pdftex]{insdljs}
%\renewcommand{\MakeTextField}[2]{{\vbox to #2{\vfill\hbox to #1{\hrulefill}}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Parameter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\fieldWidth{9}
\def\fieldHeight{16}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Javascript
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Inhalt der Umgebung wird in JSDateiname.djs gespeichert und steht im PDF zur Verf√ºgung
\begin{insDLJS}[]{JSDateiname}{irgendeinTitel}

var fieldWidth = AFMakeNumber(\fieldWidth);
var fieldHeight = AFMakeNumber(\fieldHeight);

var stone = new Array();
var shouldEmitStone = true;

var complField = new Array();

var focus = 0;

%%%%%%%%%%%%%%%%%%
% Initialisation %
%%%%%%%%%%%%%%%%%%
function initialise() {
    for (column = 0; column < fieldHeight; column++) {
        var tmp = new Array();
        for (row = 0; row < fieldWidth; row++) {
            tmp.push(0);
        }
        complField.push(tmp);
    }

    initialiseButtons();

    var run = app.setInterval("runAll()", 150);
    run.count = 0;
    var timeout = app.setTimeOut( "app.clearInterval(run);", 3*36*150);
}

function initialiseButtons() {
    %this.getField("input1").commitOnSelChange="true";
    this.getField("input1").setFocus();
    %this.getField("input1").charLimit = 1;

    this.getField("left").setAction("MouseUp", "move('a');");
    var aRect = this.getField("left").rect;
    aRect[0] -= 30;
    aRect[2] += 30;
    this.getField("left").rect = aRect;
    %this.getField("left").fillColor=color.green;
    %this.getField("left").textColor=color.white;
    this.getField("left").highlight="outline";

    this.getField("right").setAction("MouseUp", "move('d');");
    this.getField("right").highlight="invert";
    this.getField("down").setAction("MouseUp", "move('s');");
    this.getField("down").highlight="push";
    this.getField("fulldown").setAction("MouseUp", "move(' ');");

    this.getField("turnRight").setAction("MouseUp", "move('q');");
    this.getField("turnLeft").setAction("MouseUp", "move('e');");
}

%%%%%%%%
% Loop %
%%%%%%%%
function runAll() {
    processInput();
    updateField();
    draw();
    removeStone();
}

%%%%%%%%%%%%
% Movement %
%%%%%%%%%%%%
function processInput() {
    this.getField("input1").delay = true;
    this.getField("output1").delay = true;

    var movementString;
    var SPEED = 2;
    var div = Math.floor(focus / SPEED);
    if (focus - div * SPEED == 0) {
        this.getField("input1").setFocus();
        this.getField("output1").value += this.getField("input2").value;
        movementString = this.getField("input2").value;
        this.getField("input2").value = "";
    }
    else if (focus - div * SPEED == SPEED / 2) {
        this.getField("input2").setFocus();
        this.getField("output1").value += this.getField("input1").value;
        movementString = this.getField("input1").value;
        this.getField("input1").value = "";
    }
    focus++;

    for (var i = 0; i < movementString.length; i++) {
        move(movementString.charAt(i));
    }

    this.getField("input1").delay = false;
    this.getField("output1").delay = false;
}

function move(dir) {
    switch(dir) {
        case "s":
            app.beep(0);
            for (pice = 0; pice < stone.length; pice++) {
                stone[pice][1]++;
            }
            break;
        case " ":
            app.beep(2);
            for (pice = 0; pice < stone.length; pice++) {
                stone[pice][1]++;
            }
            break;
        case "a":
            app.beep(0);
            for (pice = 0; pice < stone.length; pice++) {
                stone[pice][0]--;
            }
            break;
        case "d":
            app.beep(0);
            for (pice = 0; pice < stone.length; pice++) {
                stone[pice][0]++;
            }
            break;
        case "q":
            app.beep(1);
            break;
        case "e":
            app.beep(1);
            break;
    }
}

%%%%%%%%%
% Logic %
%%%%%%%%%
function emitStone() {
    for (pice = 0; pice < stone.length; pice++) {
        var x = stone[pice][0];
        var y = stone[pice][1];
        complField[y][x] = 1;
    }

    stone = new Array(
        new Array(1, 0),
        new Array(2, 0),
        new Array(3, 0)
    );

    for (pice = 0; pice < stone.length; pice++) {
        var x = stone[pice][0];
        var y = stone[pice][1];
        complField[y][x] = 1;
    }
    shouldEmitStone = false;
}

function collidesOrHeight() {
    for (pice = 0; pice < stone.length; pice++) {
        var x = stone[pice][0];
        var y = stone[pice][1];
        if (y + 1 >= fieldHeight || complField[y + 1][x] != 0) {
            return true;
        }
    }
    return false;
}

function updateField() {
    if (shouldEmitStone) {
        emitStone();
    }
    else {
        if (!collidesOrHeight()) {
            for (pice = 0; pice < stone.length; pice++) {
                var x = stone[pice][0];
                var y = stone[pice][1];
                complField[y][x] = 0;
                complField[y + 1][x] = 1;
                stone[pice][1]++;
            }
        } else {
            shouldEmitStone = true;
        }
    }
}

function removeStone() {
    for (pice = 0; pice < stone.length; pice++) {
        var x = stone[pice][0];
        var y = stone[pice][1];
        complField[y][x] = 0;
    }
}

function draw() {
    for (x = 0; x < fieldWidth; x++) {
        for (y = 0; y < fieldHeight; y++) {
            field = this.getField("pos" + x + y);
            field.delay = true;
            if (complField[y][x] == 1) {
                field.value = 1.0;
                field.borderColor = color.black;
                field.fillColor = color.black;
            }
            else {
                field.value = 0.0;
                field.borderColor = color.white;
                field.fillColor = color.white;
            }
            field.delay = false;
        }
    }
}

\end{insDLJS}

\OpenAction{/S /JavaScript /JS (initialise();)}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Dokument
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

    \begin{Form}

        \begin{center}
            \xintFor* #2 in {\xintSeq{0}{\fieldHeight-1}} \do {%
                \xintFor* #1 in {\xintSeq{0}{\fieldWidth-1}} \do {%
                    \TextField[width=1cm, height=1cm, readonly=true, name=pos#1#2]{}
                }
                \newline
            }
        \end{center}

        \begin{center}%
            \begin{tabular}{| l | l | l |}%
                \begin{tcolorbox}[width=0.3\linewidth]
                    \centering
                    \PushButton[name=turnLeft, bordercolor=black]{\Large turnLeft\strut}
                \end{tcolorbox} &
                \TextField[name=output1, width=2in, bordercolor={0.650 .790 .94}]{}
                &
                \begin{tcolorbox}[width=0.3\linewidth]
                    \centering
                    \PushButton[name=turnRight, bordercolor=black]{\Large turnRight\strut}
                \end{tcolorbox} \\
                \begin{tcolorbox}[width=0.3\linewidth]%
                    \centering%
                    \PushButton[name=left, bordercolor=black]{\Large left\strut}%
                \end{tcolorbox}&%
                \begin{tcolorbox}[width=0.3\linewidth]%
                    \centering%
                    \PushButton[name=down, bordercolor=black]{\Large down\strut}%
                \end{tcolorbox}&
                \PushButton[name=right, bordercolor=black]{
                \begin{tcolorbox}[width=0.3\linewidth]
                    \centering
                    \Large right\strut
                \end{tcolorbox}} \\
                \multicolumn{3}{l}{%
                \begin{tcolorbox}[width=\linewidth]
                    \centering
                    \PushButton[name=fulldown, bordercolor=black]{\Large fulldown}
                \end{tcolorbox}
                }
            \end{tabular}
        \end{center}

        \begin{tcolorbox}[width=\linewidth]
            \centering
            \PushButton[name=fulldown, bordercolor=black]{\Large fulldown}
        \end{tcolorbox}

        \TextField[name=input1, width=2in, bordercolor={0.650 .790 .94}]{}
        \TextField[name=input2, width=2in, bordercolor={0.650 .790 .94}]{}

    \end{Form}

\end{document}
